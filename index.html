<!DOCTYPE html>
<html lang="fr" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tazkiya Vision : Analyse Photo (v3.1)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Amiri:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- Le site utilise uniquement des filtres math√©matiques classiques. -->
    
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #10b981 0%, #3b82f6 100%);
            --glass-bg: rgba(15, 23, 42, 0.9);
            --glass-border: rgba(255, 255, 255, 0.1);
        }
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #064e3b 50%, #0f172a 100%);
            color: white; overflow-x: hidden; min-height: 100vh;
        }
        .font-arabic { font-family: 'Amiri', serif; }
        .glass-card {
            background: var(--glass-bg); backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border); box-shadow: 0 8px 32px 0 rgba(0,0,0,0.5);
        }
        .btn-primary {
            background: var(--primary-gradient); border: none; color: white; font-weight: 600;
            padding: 12px 24px; border-radius: 12px; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;
        }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(16, 185, 129, 0.5); }
        
        .video-container {
            position: relative; border-radius: 24px; overflow: hidden; background: #000;
            box-shadow: 0 20px 50px -10px rgba(0,0,0,0.7); aspect-ratio: 16/9;
        }
        .photo-feed { width: 100%; height: 100%; object-fit: contain; }
        .overlay-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        
        .chakra-dot {
            position: absolute; border-radius: 50%; box-shadow: 0 0 10px currentColor;
            transform: translate(-50%, -50%); transition: all 0.2s ease-out; z-index: 20;
        }

        /* Custom Scrollbar */
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); }
        .custom-scroll::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 10px; }
    </style>
</head>
<body>
    <header class="sticky top-0 z-50 glass-card border-b border-white/5">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <h1 class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-emerald-400 to-cyan-400">TAZKIYA VISION <span class="text-xs text-white border border-white/20 px-2 rounded-full ml-2">v3.1</span></h1>
            <div id="status-indicator" class="w-3 h-3 rounded-full bg-emerald-500 transition-colors duration-500"></div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8 max-w-6xl">
        <div class="glass-card rounded-2xl p-4 md:p-6 grid grid-cols-1 lg:grid-cols-12 gap-6">
            
            <!-- GAUCHE : VISUALISATION PHOTO -->
            <div class="lg:col-span-8 flex flex-col gap-4">
                <div class="bg-emerald-900/10 border-b border-white/10 p-3 rounded-t-lg">
                    <h2 class="font-bold text-emerald-400">üì∏ Studio d'Analyse Spirituelle</h2>
                </div>

                <!-- PHOTO VIEW CONTAINER -->
                <div id="container-photo" class="video-container relative bg-slate-900 group">
                    <!-- Image charg√©e -->
                    <img id="photo-img" class="photo-feed hidden" crossorigin="anonymous"/>
                    <!-- Calque de dessin (Aura) -->
                    <canvas id="canvas-photo" class="overlay-canvas"></canvas>
                    <!-- Calque des points (Lataifs) -->
                    <div id="chakra-photo" class="overlay-canvas"></div>
                    
                    <!-- Interface d'Upload (Visible par d√©faut) -->
                    <div id="upload-ui" class="absolute inset-0 z-30 flex flex-col items-center justify-center bg-slate-900/50 backdrop-blur-sm transition-all duration-500">
                        <div class="w-20 h-20 bg-emerald-500/10 border border-emerald-500/30 rounded-full flex items-center justify-center mb-6 shadow-[0_0_30px_rgba(16,185,129,0.2)]">
                            <svg class="w-10 h-10 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                        </div>
                        <h3 class="text-xl font-bold text-white mb-2">Chargez une photo</h3>
                        <p class="text-slate-400 mb-6 text-sm text-center max-w-xs">Analyse classique par filtration des couleurs de la zone centrale.</p>
                        
                        <label class="btn-primary cursor-pointer flex items-center gap-2 transform hover:scale-105 transition-transform">
                            <span>üì§</span> S√©lectionner un fichier
                            <input type="file" id="input-photo" class="hidden" accept="image/*" onchange="handlePhoto(event)">
                        </label>
                    </div>

                    <!-- Bouton Effacer -->
                    <button onclick="resetPhoto()" class="absolute top-4 right-4 z-40 bg-black/60 hover:bg-red-500/80 text-white p-2 rounded-full hidden transition-colors backdrop-blur-md" id="btn-clear" title="Nouvelle photo">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>

                <!-- STATS -->
                <div class="grid grid-cols-2 gap-4">
                    <div class="glass-card p-4 rounded-xl flex items-center justify-between">
                        <div>
                            <p class="text-xs text-slate-400 uppercase tracking-wider">√âtat du C≈ìur (Qalb)</p>
                            <p id="val-nur" class="text-2xl font-bold text-emerald-300">--</p>
                        </div>
                        <div class="text-emerald-400 text-3xl">üíö</div>
                    </div>
                    <div class="glass-card p-4 rounded-xl flex items-center justify-between">
                        <div>
                            <p class="text-xs text-slate-400 uppercase tracking-wider">Sak√Ænah (Paix)</p>
                            <p id="val-coh" class="text-2xl font-bold text-cyan-300">--%</p>
                        </div>
                        <div class="text-cyan-400 text-3xl">üïäÔ∏è</div>
                    </div>
                </div>
            </div>

            <!-- DROITE : R√âSULTATS & GUIDANCE -->
            <div class="lg:col-span-4 flex flex-col h-full">
                <div class="bg-emerald-900/20 p-4 rounded-t-xl border-b border-white/5">
                    <h3 class="font-bold">‚ú® Analyse de l'√Çme</h3>
                </div>
                
                <div class="p-5 flex-grow bg-slate-900/40 space-y-6 overflow-y-auto custom-scroll" style="max-height: 600px;">
                    
                    <!-- AURA COLOR REVEAL -->
                    <div class="bg-white/5 p-4 rounded-xl border border-white/10 text-center relative overflow-hidden group">
                        <div class="absolute inset-0 bg-gradient-to-b from-white/5 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                        <p class="text-xs text-slate-400 uppercase mb-3 relative z-10">Couleur de votre Aura</p>
                        <div class="flex justify-center mb-3">
                            <div id="aura-circle" class="w-24 h-24 rounded-full shadow-[0_0_30px_currentColor] border-4 border-white/20 transition-all duration-1000 bg-slate-800 relative z-10"></div>
                        </div>
                        <h4 id="aura-name" class="text-2xl font-bold text-white mb-1 relative z-10">En attente...</h4>
                        <p id="aura-meaning" class="text-sm text-emerald-300 italic relative z-10">...</p>
                    </div>

                    <!-- VIBRATION -->
                    <div>
                        <div class="flex justify-between text-xs mb-2 text-emerald-300 font-bold">
                            <span>TAUX VIBRATOIRE</span>
                            <span id="vib-val" class="text-white font-mono">0 UB</span>
                        </div>
                        <div class="h-4 bg-slate-800 rounded-full overflow-hidden border border-white/10 relative shadow-inner">
                            <div id="vib-bar" class="h-full bg-gradient-to-r from-emerald-600 via-teal-400 to-cyan-300 w-0 transition-all duration-1000"></div>
                        </div>
                        <p class="text-[10px] text-slate-500 text-right mt-1">Estimation par Bovis (UB)</p>
                    </div>

                    <!-- LATAIFS -->
                    <div class="space-y-3">
                        <p class="text-xs font-bold text-slate-500 uppercase">Centres (Lataifs)</p>
                        <div id="chakra-list" class="space-y-2">
                            <div class="text-center py-4 text-slate-600 text-xs border border-dashed border-slate-700 rounded-lg">
                                Chargez une photo pour voir l'analyse
                            </div>
                        </div>
                    </div>

                    <!-- GUIDANCE CORANIQUE -->
                    <div class="bg-emerald-500/10 border border-emerald-500/20 p-4 rounded-xl">
                        <h5 class="font-bold text-emerald-400 text-sm mb-2 flex items-center gap-2">
                            üìñ Guidance & Dhikr
                        </h5>
                        <div id="guidance-content" class="space-y-3">
                            <p class="text-sm text-slate-300 italic">L'analyse s√©lectionnera un verset pour vous.</p>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </main>

    <script>
        /**
         * TAZKIYA VISION ENGINE v3.1 (Non-AI Filter Edition)
         * - Removed TensorFlow/Blazeface.
         * - Uses fixed central region analysis for color/aura extraction.
         * - All logic is purely mathematical/deterministic (non-ML).
         */

        const STATE = { model: null }; // Model is now obsolete, kept for structure
        const DOM = {
            photoImg: document.getElementById('photo-img'),
            canvasPhoto: document.getElementById('canvas-photo'),
            ctxPhoto: document.getElementById('canvas-photo').getContext('2d', { willReadFrequently: true }),
            overlays: { photo: document.getElementById('chakra-photo'), upload: document.getElementById('upload-ui') },
            stats: { 
                nur: document.getElementById('val-nur'), 
                coh: document.getElementById('val-coh'), 
                guidance: document.getElementById('guidance-content'), 
                chakraList: document.getElementById('chakra-list'), 
                vibBar: document.getElementById('vib-bar'), 
                vibVal: document.getElementById('vib-val'),
                auraCircle: document.getElementById('aura-circle'),
                auraName: document.getElementById('aura-name'),
                auraMeaning: document.getElementById('aura-meaning')
            }
        };

        const DATA = {
            colors: {
                'Rouge': { meaning: 'Force & Ancrage (Al-Quwwa)', verset: 'Et quant √† la terre, Il l\'a √©tablie pour les cr√©atures. (55:10)', dhikr: 'Ya Hayyu Ya Qayyum (√î Vivant, √î Subsistant) - 33x' },
                'Orange': { meaning: 'Cr√©ativit√© & Lien (Silat)', verset: 'C\'est Lui qui a cr√©√© les cieux et la terre en toute v√©rit√©. (6:73)', dhikr: 'Alhamdulillah (Louange √† Allah) - 33x' },
                'Jaune': { meaning: 'Lumi√®re & Savoir (Ilm)', verset: 'Allah est la Lumi√®re des cieux et de la terre. (24:35)', dhikr: 'Ya Nur (√î Lumi√®re) - 100x' },
                'Vert': { meaning: 'Gu√©rison & C≈ìur (Shifa)', verset: 'Et Il gu√©rit les poitrines d\'un peuple croyant. (9:14)', dhikr: 'Ya Salam (√î Paix) - 33x' },
                'Bleu': { meaning: 'V√©rit√© & Parole (Haqq)', verset: 'Et dis la v√©rit√©, m√™me si elle est contre toi-m√™me. (4:135)', dhikr: 'SubhanAllah (Gloire √† Allah) - 33x' },
                'Indigo': { meaning: 'Vision & Sagesse (Basira)', verset: 'Craignez Allah et Allah vous enseignera. (2:282)', dhikr: 'Ya Alim (√î Omniscient) - 33x' },
                'Violet': { meaning: 'Spiritualit√© (Ruhaniya)', verset: 'Ceux qui croient et dont les c≈ìurs s\'apaisent au souvenir d\'Allah. (13:28)', dhikr: 'La ilaha illa Allah - 100x' },
                'Blanc': { meaning: 'Puret√© Absolue (Tahara)', verset: 'Il a r√©ussi, certes, celui qui la purifie. (91:9)', dhikr: 'Astaghfirullah (Je demande pardon) - 100x' }
            },
            chakras: [
                {id: 'crown', n:'Akhfa', c:[139,92,246]}, {id: 'third', n:'Khafi', c:[79,70,229]}, {id: 'throat', n:'Ruh', c:[59,130,246]},
                {id: 'heart', n:'Sirr', c:[34,197,94]}, {id: 'solar', n:'Qalb', c:[234,179,8]}, {id: 'sacral', n:'Nafs', c:[249,115,22]}, {id: 'root', n:'Asas', c:[239,68,68]}
            ]
        };

        // --- INIT ---
        window.onload = () => {
            // Pas de chargement d'IA, on signale que le site est pr√™t imm√©diatement
            document.getElementById('status-indicator').classList.replace('bg-slate-600', 'bg-emerald-500');
            console.log("Site pr√™t (Mode Filtre Classique)");
        };

        // --- HANDLERS ---
        function handlePhoto(e) {
            const file = e.target.files[0]; if(!file) return;
            const reader = new FileReader();
            
            reader.onload = (evt) => {
                DOM.photoImg.src = evt.target.result;
                DOM.photoImg.classList.add('hidden'); 
                DOM.overlays.upload.classList.add('hidden');
                
                DOM.photoImg.onload = () => {
                    document.getElementById('btn-clear').classList.remove('hidden');
                    
                    // Ajuster la taille du canvas √† la taille de l'image (non pas la taille d'affichage)
                    DOM.canvasPhoto.width = DOM.photoImg.width; 
                    DOM.canvasPhoto.height = DOM.photoImg.height;
                    
                    // Dessiner l'image originale
                    DOM.ctxPhoto.drawImage(DOM.photoImg, 0, 0); 
                    
                    // --- NOUVEAU: Analyse Filtre Classique ---
                    // On simule une "face" centr√©e pour l'analyse et la visualisation
                    const center_x = DOM.canvasPhoto.width / 2;
                    const center_y = DOM.canvasPhoto.height / 2;
                    const face_w = Math.min(DOM.canvasPhoto.width, DOM.canvasPhoto.height) * 0.4; // 40% de la taille min
                    const face_h = face_w * 1.3; // Proportion de visage
                    
                    const simulatedFace = {
                        x: center_x - face_w / 2, 
                        y: center_y - face_h / 2, 
                        w: face_w, 
                        h: face_h 
                    };
                    
                    processFaceData(simulatedFace, DOM.ctxPhoto, DOM.overlays.photo);
                    
                };
            };
            reader.readAsDataURL(file);
        }
        
        function resetPhoto() {
            DOM.photoImg.src = ""; 
            DOM.overlays.upload.classList.remove('hidden'); 
            document.getElementById('btn-clear').classList.add('hidden'); 
            DOM.ctxPhoto.clearRect(0,0,DOM.canvasPhoto.width, DOM.canvasPhoto.height); 
            DOM.overlays.photo.innerHTML = '';
            document.getElementById('input-photo').value = '';
            
            // Reset Stats UI
            DOM.stats.nur.innerText = "--";
            DOM.stats.coh.innerText = "--%";
            DOM.stats.auraName.innerText = "En attente...";
            DOM.stats.auraCircle.style.backgroundColor = "";
            DOM.stats.auraCircle.style.boxShadow = "";
            DOM.stats.vibBar.style.width = "0%";
            DOM.stats.vibVal.innerText = "0 UB";
            DOM.stats.chakraList.innerHTML = '<div class="text-center py-4 text-slate-600 text-xs border border-dashed border-slate-700 rounded-lg">Chargez une photo pour voir l\'analyse</div>';
        }
        window.clearPhoto = resetPhoto;

        // --- ANALYSIS CORE ---
        function processFaceData(face, ctx, overlayLayer) {
            // Extraire les donn√©es de couleur de la r√©gion centrale simul√©e (visage)
            const cx = face.x + face.w/2;
            const cy = face.y + face.h/2;
            
            // √âchantillonnage de la zone du visage
            const p = ctx.getImageData(face.x, face.y, face.w, face.h).data;
            
            let r=0, g=0, b=0, c=0;
            // √âchantillonner 1 pixel sur 80 pour la vitesse (pas besoin de Blazeface pour √ßa)
            for(let i=0; i<p.length; i+=80) { r+=p[i]; g+=p[i+1]; b+=p[i+2]; c++; }
            r=Math.round(r/c); g=Math.round(g/c); b=Math.round(b/c);
            
            // Couleurs des couches
            const [h, s, l] = rgbToHsl(r,g,b);
            const rgbAstral = hslToRgb((h + 0.1) % 1, s, l);
            const rgbCausal = hslToRgb((h + 0.5) % 1, s*0.8, Math.min(1, l*1.2));
            
            // Dessiner les Halos (Multicouches) par-dessus la photo
            drawLayer(ctx, cx, cy, face.w * 2.0, `rgba(${rgbCausal[0]},${rgbCausal[1]},${rgbCausal[2]}, 0.4)`); // Spirituel
            drawLayer(ctx, cx, cy, face.w * 1.5, `rgba(${rgbAstral[0]},${rgbAstral[1]},${rgbAstral[2]}, 0.5)`); // Astral
            drawLayer(ctx, cx, cy, face.w * 1.05, `rgba(${r},${g},${b}, 0.6)`); // Physique
            
            // Analyse des donn√©es
            const analysis = getSpiritualAnalysis(r,g,b);
            updateUI(analysis, r, g, b);
            
            // Afficher les points Lataifs
            renderLataifs(face, overlayLayer);
        }

        function drawLayer(ctx, cx, cy, radius, color) {
            const grad = ctx.createRadialGradient(cx, cy, radius*0.3, cx, cy, radius);
            grad.addColorStop(0, color);
            grad.addColorStop(1, 'rgba(0,0,0,0)');
            ctx.fillStyle = grad;
            ctx.globalCompositeOperation = 'screen';
            ctx.beginPath();
            ctx.arc(cx, cy, radius, 0, Math.PI*2);
            ctx.fill();
            ctx.globalCompositeOperation = 'source-over';
        }

        function getSpiritualAnalysis(r,g,b) {
            const max = Math.max(r,g,b);
            let color = 'Blanc';
            if(max===r && g<r*0.7) color='Rouge'; else if(max===r) color='Orange';
            else if(max===g) color='Vert'; else if(max===b && r<b*0.7) color='Bleu';
            else if(max===b) color='Violet';
            
            // Calculs simul√©s bas√©s sur la colorim√©trie de la photo
            const luminosity = (r*0.299 + g*0.587 + b*0.114);
            const coh = Math.min(100, Math.max(40, Math.round((luminosity / 255) * 100))); 
            const nur = luminosity > 100 ? 'Illumin√©' : 'Voil√©';
            
            return { color, nur, coh, ...DATA.colors[color] || DATA.colors['Blanc'] };
        }

        function renderLataifs(face, layer) {
            const cx = face.x + face.w/2;
            let html = '';
            // Les positions sont maintenant relatives au centre de la zone de visage simul√©e
            const positions = [{ y: -0.2 }, { y: 0.35 }, { y: 1.1 }, { y: 1.8 }, { y: 2.5 }, { y: 3.2 }, { y: 3.9 }];
            let listHtml = '';

            DATA.chakras.forEach((k, i) => {
                const pos = positions[i];
                if (!pos) return;
                const dotY = face.y + (face.h * pos.y);
                const rgb = `rgb(${k.c.join(',')})`;
                
                // Point sur l'image
                html += `<div class="chakra-dot" style="left:${cx}px; top:${dotY}px; background:${rgb}; width:14px; height:14px; box-shadow: 0 0 15px ${rgb};"></div>`;
                
                // √âl√©ment dans la liste
                const activity = Math.round(Math.random()*20 + 70); // Simulation activit√©
                listHtml += `<div class="flex items-center justify-between text-xs bg-white/5 p-2 rounded hover:bg-white/10 transition-colors border border-white/5"><div class="flex items-center gap-2"><div class="w-2 h-2 rounded-full shadow-[0_0_8px_currentColor]" style="background-color:${rgb}; color:${rgb}"></div><span class="text-slate-300 font-medium">${k.n}</span></div><span class="font-mono text-emerald-300">${activity}%</span></div>`;
            });
            layer.innerHTML = html;
            DOM.stats.chakraList.innerHTML = listHtml;
        }

        function updateUI(res, r, g, b) {
            DOM.stats.nur.innerText = res.nur;
            DOM.stats.coh.innerText = res.coh + '%';
            
            DOM.stats.auraCircle.style.backgroundColor = `rgb(${r},${g},${b})`;
            DOM.stats.auraCircle.style.color = `rgb(${r},${g},${b})`;
            DOM.stats.auraName.innerText = res.color;
            DOM.stats.auraName.style.color = `rgb(${r},${g},${b})`;
            DOM.stats.auraMeaning.innerText = res.meaning;

            const vibration = Math.round(res.coh * 80 + 4000); 
            DOM.stats.vibBar.style.width = res.coh + '%';
            DOM.stats.vibVal.innerText = vibration + " UB";

            DOM.stats.guidance.innerHTML = `
                <div class="mb-3 p-4 bg-slate-800/50 rounded-lg border border-white/5 shadow-lg">
                    <p class="text-[10px] text-emerald-400 uppercase mb-2 font-bold tracking-wider">Verset du Moment</p>
                    <p class="font-arabic text-lg text-white leading-relaxed dir-rtl text-right">"${res.verset}"</p>
                </div>
                <div class="p-4 bg-slate-800/50 rounded-lg border border-white/5 shadow-lg">
                    <p class="text-[10px] text-cyan-400 uppercase mb-2 font-bold tracking-wider">Dhikr Recommand√©</p>
                    <p class="font-bold text-white text-md">${res.dhikr}</p>
                </div>
            `;
        }

        // --- MATH UTILS ---
        function rgbToHsl(r, g, b) {
            r /= 255, g /= 255, b /= 255;
            const max = Math.max(r, g, b), min = Math.min(r, g, b);
            let h, s, l = (max + min) / 2;
            if (max == min) { h = s = 0; } else {
                const d = max - min;
                s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                switch (max) { case r: h = (g - b) / d + (g < b ? 6 : 0); break; case g: h = (b - r) / d + 2; break; case b: h = (r - g) / d + 4; break; }
                h /= 6;
            }
            return [h, s, l];
        }
        function hslToRgb(h, s, l) {
            let r, g, b;
            if (s == 0) { r = g = b = l; } else {
                const hue2rgb = (p, q, t) => { if (t < 0) t += 1; if (t > 1) t -= 1; if (t < 1/6) return p + (q - p) * 6 * t; if (t < 1/2) return q; if (t < 2/3) return p + (q - p) * (2/3 - t) * 6; return p; };
                const q = l < 0.5 ? l * (1 + s) : l + s - l * s; const p = 2 * l - q;
                r = hue2rgb(p, q, h + 1/3); g = hue2rgb(p, q, h); b = hue2rgb(p, q, h - 1/3);
            }
            return [Math.round(r * 255), Math.round(g * 255), Math.round(b * 255)];
        }
    </script>
</body>
</html>
