<!DOCTYPE html>
<html lang="fr" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analyseur de Lumière Spirituelle et Bien-être Islamique</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://unpkg.com/lucide@latest/dist/iconfont/lucide.css" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .gradient-text {
            background: linear-gradient(90deg, #38bdf8, #a78bfa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .aura-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            pointer-events: none;
        }
        .video-feed {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1); /* Effet miroir */
        }
        .card-glow {
            box-shadow: 0 0 15px rgba(167, 139, 250, 0.3), 0 0 5px rgba(56, 189, 248, 0.2);
        }
        .btn-glow:hover {
            box-shadow: 0 0 20px rgba(167, 139, 250, 0.5);
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1e293b;
        }
        ::-webkit-scrollbar-thumb {
            background-color: #4f46e5;
            border-radius: 10px;
            border: 2px solid #1e293b;
        }
        .recording-pulse {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .modal-backdrop {
            background-color: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(8px);
        }
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        .breathing-circle {
            animation: breathe 8s infinite ease-in-out;
        }
        @keyframes breathe {
            0%, 100% { transform: scale(0.8); opacity: 0.8; }
            50% { transform: scale(1); opacity: 1; }
        }
        .chakra-dot {
            transition: all 0.5s ease-in-out;
            animation: chakra-pulse 4s infinite ease-in-out;
        }
        @keyframes chakra-pulse {
            0%, 100% { filter: brightness(1); }
            50% { filter: brightness(1.5); }
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-300 antialiased">

    <!-- Header -->
    <header class="py-4 px-6 md:px-12 border-b border-slate-800 backdrop-blur-sm sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold gradient-text">Harmonie Spirituelle IA</h1>
            <nav class="hidden md:flex space-x-6 text-sm">
                <a href="#analyzer" class="hover:text-sky-400 transition-colors">Analyseur</a>
                <a href="#tools" class="hover:text-sky-400 transition-colors">Outils Spirituels</a>
                <a href="#how-it-works" class="hover:text-sky-400 transition-colors">Principe</a>
                <a href="#disclaimer" class="hover:text-sky-400 transition-colors">Avertissement</a>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-6 py-12 md:px-12 md:py-16">

        <!-- Hero Section -->
        <section id="hero" class="text-center my-16 md:my-24">
            <h2 class="text-4xl md:text-6xl font-extrabold text-slate-100 mb-4">Explorez Votre Lumière Intérieure</h2>
            <p class="max-w-3xl mx-auto text-lg md:text-xl text-slate-400 mb-10 leading-relaxed">
                Découvrez votre état spirituel grâce à notre analyseur et utilisez des outils conformes aux principes islamiques pour trouver la paix et l'équilibre.
            </p>
            <a href="#analyzer" class="bg-indigo-600 text-white font-bold py-3 px-8 rounded-full hover:bg-indigo-500 transition-all duration-300 btn-glow inline-block">
                Démarrer l'analyse
            </a>
        </section>

        <!-- Analyzer Section -->
        <section id="analyzer" class="mb-28 md:mb-32">
            <div class="bg-slate-800/50 rounded-2xl p-6 md:p-8 card-glow backdrop-blur-lg">
                <div class="grid grid-cols-1 lg:grid-cols-5 gap-10">
                    
                    <!-- Analysis Interface Column -->
                    <div class="lg:col-span-3">
                        <div class="flex border-b border-slate-700 mb-4">
                            <button id="liveTabButton" class="px-4 py-2 text-sm font-semibold border-b-2 border-indigo-500 text-white transition-colors duration-200">Analyse en direct</button>
                            <button id="photoTabButton" class="px-4 py-2 text-sm font-semibold border-b-2 border-transparent text-slate-400 hover:text-white transition-colors duration-200">Analyse Photo</button>
                        </div>

                        <!-- Live Analysis Tab -->
                        <div id="liveTabContent">
                            <div id="video-container" class="relative aspect-video bg-slate-900 rounded-lg overflow-hidden flex items-center justify-center">
                                <video id="video" class="video-feed" playsinline autoplay muted style="z-index: 0;"></video>
                                <canvas id="canvas" class="aura-canvas" style="z-index: 1;"></canvas>
                                <!-- Chakra dots container -->
                                <div id="chakra-dots-container" class="absolute inset-0 z-20 pointer-events-none"></div>
                                <div id="loading-spinner" class="absolute z-10 text-white hidden">
                                    <svg class="animate-spin h-10 w-10 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                                </div>
                                <div id="start-message" class="absolute z-30 text-center p-4">
                                    <p class="text-slate-300 mb-4">Cliquez pour activer la caméra et commencer l'analyse.</p>
                                    <button id="startButton" class="bg-indigo-600 text-white font-bold py-3 px-8 rounded-full hover:bg-indigo-500 transition-all duration-300 btn-glow">Activer la caméra</button>
                                </div>
                            </div>
                             <div class="mt-4 flex justify-center items-center gap-4">
                                <button id="stopButton" class="hidden bg-red-600 text-white font-bold py-2 px-6 rounded-full hover:bg-red-500 transition-all duration-300 btn-glow">Arrêter</button>
                                <button id="fullscreenButton" class="hidden text-slate-400 hover:text-white" title="Plein écran">
                                     <i class="lucide lucide-maximize"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Photo Analysis Tab -->
                        <div id="photoTabContent" class="hidden">
                            <div id="photo-container" class="relative aspect-video bg-slate-900 rounded-lg overflow-hidden flex items-center justify-center">
                                <img id="photo-preview" class="hidden absolute top-0 left-0 w-full h-full object-contain" style="z-index: 0;" />
                                <canvas id="photo-canvas" class="aura-canvas" style="object-fit: contain; z-index: 1;"></canvas>
                                 <!-- Photo Chakra dots container -->
                                <div id="photo-chakra-dots-container" class="absolute inset-0 z-20 pointer-events-none"></div>
                                <button id="clearPhotoButton" class="hidden absolute top-3 right-3 z-30 bg-slate-900/60 hover:bg-slate-700/80 p-1.5 rounded-full text-slate-300 hover:text-white transition-colors" title="Effacer la photo"><i class="lucide lucide-x"></i></button>
                                <div id="photo-start-message" class="absolute z-20 text-center p-4">
                                    <p class="text-slate-300 mb-4">Chargez une photo pour analyser sa signature spirituelle.</p>
                                    <input type="file" id="photoInput" class="hidden" accept="image/png, image/jpeg">
                                    <label for="photoInput" class="cursor-pointer bg-indigo-600 text-white font-bold py-3 px-8 rounded-full hover:bg-indigo-500 transition-all duration-300 btn-glow">Charger une Photo</label>
                                </div>
                                 <div id="photo-loading-spinner" class="absolute z-10 text-white hidden">
                                    <svg class="animate-spin h-10 w-10 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                                 </div>
                            </div>
                        </div>
                    </div>

                    <!-- Results Column -->
                    <div class="lg:col-span-2 flex flex-col">
                        <h3 id="analysis-title" class="text-2xl font-bold text-slate-100 mb-4 text-center lg:text-left"></h3>
                        <div id="results-placeholder" class="text-center text-slate-500 pt-16 flex-grow flex items-center justify-center">
                            <p>Les résultats de l'analyse s'afficheront ici.</p>
                        </div>
                        <div id="results" class="hidden space-y-4 overflow-y-auto" style="max-height: 70vh;">
                            
                            <!-- 1. Aura Dominante -->
                            <div class="bg-slate-900/70 p-5 rounded-lg">
                                <h4 class="text-sm font-semibold text-slate-400 mb-2">Lumière Dominante</h4>
                                <div class="flex items-start space-x-4"><div id="dominant-color-preview" class="w-12 h-12 rounded-full border-2 border-slate-700 flex-shrink-0"></div>
                                    <div><p id="dominant-color-name" class="text-xl font-bold text-white">En attente...</p><p id="dominant-color-wavelength" class="text-xs text-sky-400 font-mono">~ ... nm</p></div>
                                </div>
                            </div>

                             <!-- Message du Jour - RE-ADDED TO FIX ERROR -->
                            <div class="bg-slate-900/70 p-5 rounded-lg">
                                <h4 class="text-sm font-semibold text-slate-400 mb-2">Rappel du Jour</h4>
                                <p id="daily-message" class="text-sm text-slate-300 italic"></p>
                            </div>

                            <div class="bg-slate-900/70 p-4 rounded-lg">
                                <label for="showSubtleBodies" class="flex items-center justify-between cursor-pointer">
                                    <span class="text-sm font-semibold text-slate-400">Voir les 7 enveloppes subtiles (Lataif)</span>
                                    <div class="relative">
                                        <input type="checkbox" id="showSubtleBodies" class="sr-only peer">
                                        <div class="w-11 h-6 bg-slate-700 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-600"></div>
                                    </div>
                                </label>
                            </div>
                            
                            <!-- Accordion for details -->
                            <div class="space-y-2">
                                <!-- Aura Interpretation -->
                                <div class="accordion-item bg-slate-900/70 rounded-lg">
                                    <button class="accordion-header w-full flex justify-between items-center p-5 text-left">
                                        <h4 class="text-sm font-semibold text-slate-400">Interprétation Spirituelle</h4>
                                        <i class="lucide lucide-chevron-down transform transition-transform"></i>
                                    </button>
                                    <div class="accordion-content px-5 pb-5 pt-2">
                                        <div id="interpretation-text" class="text-slate-300 text-sm"></div>
                                    </div>
                                </div>
                                <!-- Subtle Bodies Analysis -->
                                <div class="accordion-item bg-slate-900/70 rounded-lg">
                                    <button class="accordion-header w-full flex justify-between items-center p-5 text-left">
                                        <h4 class="text-sm font-semibold text-slate-400">Analyse des Enveloppes Subtiles (Lataif)</h4>
                                        <i class="lucide lucide-chevron-down transform transition-transform"></i>
                                    </button>
                                    <div class="accordion-content px-5 pb-5 pt-2">
                                        <div id="subtle-bodies-content" class="space-y-3 text-sm"></div>
                                    </div>
                                </div>
                                <!-- Chakra Analysis -->
                                <div class="accordion-item bg-slate-900/70 rounded-lg">
                                    <button class="accordion-header w-full flex justify-between items-center p-5 text-left">
                                        <h4 class="text-sm font-semibold text-slate-400">Analyse des Centres Spirituels</h4>
                                        <i class="lucide lucide-chevron-down transform transition-transform"></i>
                                    </button>
                                    <div class="accordion-content px-5 pb-5 pt-2">
                                        <div id="chakra-analysis-content" class="space-y-2"></div>
                                    </div>
                                </div>
                                <!-- Vibrational Rate -->
                                <div class="accordion-item bg-slate-900/70 rounded-lg">
                                    <button class="accordion-header w-full flex justify-between items-center p-5 text-left">
                                        <h4 class="text-sm font-semibold text-slate-400">Niveau de Paix Intérieure (Sakînah)</h4>
                                        <i class="lucide lucide-chevron-down transform transition-transform"></i>
                                    </button>
                                    <div class="accordion-content px-5 pb-5 pt-2">
                                        <div class="flex flex-col items-center gap-4">
                                            <div class="relative w-24 h-24"><svg class="w-full h-full -rotate-90" viewBox="0 0 36 36"><path class="stroke-slate-700" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke-width="3"></path><path id="vibrational-gauge-bar" class="stroke-sky-400 transition-all duration-500" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke-width="3" stroke-dasharray="0, 100" stroke-linecap="round"></path></svg>
                                                <div class="absolute inset-0 flex flex-col items-center justify-center text-center"><span id="vibrational-rate-value" class="text-xl font-bold font-mono text-white">...</span><span class="text-xs text-slate-400">Niveau</span></div>
                                            </div>
                                            <div class="text-center w-full"><p id="vibrational-level-text" class="font-semibold text-md text-white">En attente...</p><p id="vibrational-commentary" class="text-slate-300 text-sm mt-2"></p></div>
                                        </div>
                                    </div>
                                </div>
                                <!-- Aura Shape & Texture -->
                                <div class="accordion-item bg-slate-900/70 rounded-lg">
                                    <button class="accordion-header w-full flex justify-between items-center p-5 text-left">
                                        <h4 class="text-sm font-semibold text-slate-400">Clarté et Cohérence de l'Esprit</h4>
                                        <i class="lucide lucide-chevron-down transform transition-transform"></i>
                                    </button>
                                    <div class="accordion-content px-5 pb-5 pt-2">
                                         <p id="aura-shape-texture" class="text-sm text-slate-300"></p>
                                    </div>
                                </div>
                                 <!-- Energy Balance -->
                                <div class="accordion-item bg-slate-900/70 rounded-lg">
                                    <button class="accordion-header w-full flex justify-between items-center p-5 text-left">
                                        <h4 class="text-sm font-semibold text-slate-400">Équilibre (Mîzân) Jalal/Jamal</h4>
                                        <i class="lucide lucide-chevron-down transform transition-transform"></i>
                                    </button>
                                    <div class="accordion-content px-5 pb-5 pt-2">
                                        <div class="w-full bg-slate-700 rounded-full h-2.5">
                                          <div id="yin-yang-bar" class="bg-gradient-to-r from-indigo-400 to-sky-400 h-2.5 rounded-full" style="width: 50%"></div>
                                        </div>
                                        <div class="flex justify-between text-xs mt-1">
                                            <span>Jamal (Beauté/Grâce)</span>
                                            <span id="yin-yang-text">Équilibré</span>
                                            <span>Jalal (Majesté/Rigueur)</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Recording and Report -->
                            <div class="bg-slate-900/70 p-5 rounded-lg">
                                <h4 class="text-sm font-semibold text-slate-400 mb-2">Session d'Analyse</h4>
                                <div class="flex items-center justify-between gap-4 mt-2">
                                     <button id="recordButton" class="bg-sky-600 text-white text-sm font-bold py-2 px-4 rounded-full hover:bg-sky-500 transition-all duration-300 btn-glow w-full disabled:bg-slate-600 disabled:cursor-not-allowed flex items-center justify-center gap-2" disabled><i class="lucide lucide-circle"></i><span id="recordButtonText">Démarrer</span></button>
                                     <p id="recordTimer" class="font-mono text-lg text-slate-300">00:00</p>
                                </div>
                                <div class="flex items-center justify-between gap-2 mt-2">
                                    <button id="exportButton" class="bg-slate-700 text-white text-xs font-bold py-1 px-3 rounded-full hover:bg-slate-600 transition-all w-full disabled:opacity-50" disabled>Exporter</button>
                                    <button id="historyButton" class="bg-slate-700 text-white text-xs font-bold py-1 px-3 rounded-full hover:bg-slate-600 transition-all w-full">Historique</button>
                                </div>
                                <p id="recordStatus" class="text-xs text-slate-500 mt-2 text-center">Activez la caméra pour enregistrer.</p>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Therapeutic Tools Section -->
        <section id="tools" class="mb-28 md:mb-32 text-center">
            <h2 class="text-3xl md:text-4xl font-bold text-slate-100 mb-6">Outils de Bien-être Spirituel</h2>
            <p class="max-w-3xl mx-auto text-slate-400 mb-16 md:text-lg">
                Utilisez ces outils permis pour harmoniser votre état spirituel, basés sur les résultats de votre analyse.
            </p>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-10">
                 <!-- Breathing Exercise -->
                <div class="bg-slate-800 p-8 rounded-lg">
                    <h3 class="font-bold text-sky-400 mb-4">Respiration Consciente (Dhikr)</h3>
                    <div class="relative w-32 h-32 mx-auto mb-4 flex items-center justify-center">
                        <div class="absolute inset-0 bg-indigo-500/30 rounded-full breathing-circle"></div>
                        <p id="breathing-text" class="z-10 text-white font-semibold">Inspirez... (Ya Chafi)</p>
                    </div>
                    <button id="startBreathingButton" class="bg-indigo-600 text-sm text-white font-bold py-2 px-5 rounded-full hover:bg-indigo-500 transition-all">Commencer</button>
                </div>

                <!-- Sound Therapy -->
                <div class="bg-slate-800 p-8 rounded-lg">
                    <h3 class="font-bold text-sky-400 mb-4">Lecture Apaisante (Coran)</h3>
                    <p class="text-sm mb-4">Lancez une ambiance sonore relaxante inspirée par la récitation pour calmer le coeur.</p>
                    <div id="sound-therapy-ui" class="opacity-50">
                        <p class="text-lg font-mono" id="sound-freq-label">Sourate Recommandée ...</p>
                        <button id="playSoundButton" class="mt-2 bg-indigo-600 text-sm text-white font-bold py-2 px-5 rounded-full hover:bg-indigo-500 transition-all disabled:bg-slate-600 disabled:cursor-not-allowed" disabled><i class="lucide lucide-play"></i> Lancer la Lecture</button>
                    </div>
                </div>

                <!-- Guided Meditation -->
                <div class="bg-slate-800 p-8 rounded-lg">
                    <h3 class="font-bold text-sky-400 mb-4">Méditation sur la Création (Tafakkur)</h3>
                    <p class="text-sm mb-4">Lancez une méditation guidée pour réfléchir aux signes d'Allah.</p>
                     <div id="meditation-ui" class="opacity-50">
                        <p class="text-lg" id="meditation-title">...</p>
                        <button id="playMeditationButton" class="mt-2 bg-indigo-600 text-sm text-white font-bold py-2 px-5 rounded-full hover:bg-indigo-500 transition-all disabled:bg-slate-600 disabled:cursor-not-allowed" disabled><i class="lucide lucide-play"></i> Lancer</button>
                    </div>
                </div>

                <!-- Personalized Affirmations -->
                <div class="bg-slate-800 p-8 rounded-lg">
                     <h3 class="font-bold text-sky-400 mb-4">Invocations (Du'as) Personnalisées</h3>
                     <div id="affirmations-ui" class="h-full flex flex-col justify-center items-center">
                         <p id="affirmation-text" class="text-lg italic text-slate-300">"..."</p>
                         <button id="newAffirmationButton" class="mt-4 text-xs text-slate-400 hover:text-white disabled:opacity-50" disabled>Nouvelle invocation</button>
                     </div>
                </div>
                
                <!-- Prophetic Remedies -->
                <div class="bg-slate-800 p-8 rounded-lg">
                    <h3 class="font-bold text-sky-400 mb-4">Remèdes Prophétiques</h3>
                    <div id="remedies-ui" class="h-full flex flex-col justify-center items-center text-center">
                        <p id="remedy-name" class="font-bold text-white text-lg">...</p>
                        <p id="remedy-description" class="text-sm text-slate-400 mt-1">...</p>
                    </div>
                </div>
                
                <!-- Prophetic Scents -->
                <div class="bg-slate-800 p-8 rounded-lg">
                    <h3 class="font-bold text-sky-400 mb-4">Senteurs Apaisantes (Sunnah)</h3>
                     <div id="aroma-ui" class="h-full flex flex-col justify-center items-center text-center">
                        <p id="aroma-name" class="font-bold text-white text-lg">...</p>
                        <p id="aroma-description" class="text-sm text-slate-400 mt-1">...</p>
                    </div>
                </div>

            </div>
        </section>

        
        <!-- Aura Color Meanings Section -->
        <section id="color-meanings" class="mb-28 md:mb-32">
            <h2 class="text-3xl md:text-4xl font-bold text-slate-100 mb-12 text-center">Symbolique des Couleurs de l'Âme</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <!-- Color meanings will be injected here by JS -->
            </div>
        </section>


        <!-- How It Works Section -->
        <section id="how-it-works" class="mb-28 md:mb-32 text-center">
            <h2 class="text-3xl md:text-4xl font-bold text-slate-100 mb-6">Principe de Fonctionnement</h2>
            <p class="max-w-3xl mx-auto text-slate-400 mb-16 md:text-lg">
                Cette application repose sur des principes de vision par ordinateur pour analyser les micro-variations de chrominance et de luminance comme une métaphore visuelle de l'état spirituel.
            </p>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-10">
                <div class="bg-slate-800 p-8 rounded-lg">
                    <h3 class="font-bold text-sky-400 mb-2">1. Capture & Analyse</h3>
                    <p class="text-sm">L'algorithme analyse la périphérie de la silhouette pour détecter les distributions de couleur et la cohérence du signal lumineux capté par la caméra.</p>
                </div>
                <div class="bg-slate-800 p-8 rounded-lg">
                    <h3 class="font-bold text-sky-400 mb-2">2. Interprétation Symbolique</h3>
                    <p class="text-sm">Les données visuelles sont corrélées à des modèles symboliques (couleurs, centres spirituels) pour générer des interprétations et des recommandations.</p>
                </div>
                <div class="bg-slate-800 p-8 rounded-lg">
                    <h3 class="font-bold text-sky-400 mb-2">3. Harmonisation Interactive</h3>
                    <p class="text-sm">Des outils basés sur la tradition (invocations, méditation, respiration) sont proposés pour aider à trouver la paix intérieure et la sérénité.</p>
                </div>
            </div>
        </section>
        
        <!-- Disclaimer Section -->
        <section id="disclaimer" class="bg-amber-900/20 border border-amber-600/50 rounded-lg p-8 md:p-10 text-center">
             <h2 class="text-2xl font-bold text-amber-300 mb-4">Avertissement Important</h2>
            <p class="max-w-4xl mx-auto text-amber-300/80 leading-relaxed">
                Cet outil est un projet technologique expérimental à des fins d'exploration spirituelle personnelle et de divertissement. Il ne doit pas être utilisé pour un diagnostic médical ou psychologique. Les résultats sont des interprétations algorithmiques symboliques et ne remplacent en aucun cas l'avis d'un professionnel qualifié ou d'un savant religieux. Cet outil ne constitue pas une source de fatwa ou de jugement religieux. L'utilisation des outils proposés doit se faire dans le respect des préceptes de l'Islam.
            </p>
        </section>

    </main>
    
    <!-- Modals -->
    <!-- Report Modal -->
    <div id="report-modal" class="fixed inset-0 z-[60] flex items-center justify-center p-4 hidden modal-backdrop">
        <div class="bg-slate-800 border border-slate-700 rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col">
            <header class="p-4 border-b border-slate-700 flex justify-between items-center flex-shrink-0">
                <h2 class="text-xl font-bold text-slate-100">Rapport de Session</h2>
                <button class="close-modal-button text-slate-400 hover:text-white text-3xl leading-none">&times;</button>
            </header>
            <div id="report-content" class="p-6 overflow-y-auto space-y-6"></div>
             <footer class="p-4 border-t border-slate-700 text-center flex-shrink-0">
                 <button class="close-modal-button bg-indigo-600 text-white font-bold py-2 px-6 rounded-full hover:bg-indigo-500 transition-all">Fermer</button>
             </footer>
        </div>
    </div>
    
    <!-- History Modal -->
    <div id="history-modal" class="fixed inset-0 z-[60] flex items-center justify-center p-4 hidden modal-backdrop">
        <div class="bg-slate-800 border border-slate-700 rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col">
            <header class="p-4 border-b border-slate-700 flex justify-between items-center flex-shrink-0">
                <h2 class="text-xl font-bold text-slate-100">Historique des Sessions</h2>
                <button class="close-modal-button text-slate-400 hover:text-white text-3xl leading-none">&times;</button>
            </header>
            <div id="history-content" class="p-6 overflow-y-auto"></div>
             <footer class="p-4 border-t border-slate-700 text-center flex-shrink-0">
                 <button id="clear-history-button" class="bg-red-600 text-white font-bold py-2 px-6 rounded-full hover:bg-red-500 transition-all">Vider l'historique</button>
             </footer>
        </div>
    </div>
    
    <!-- Meditation Modal -->
    <div id="meditation-modal" class="fixed inset-0 z-[60] flex items-center justify-center p-4 hidden modal-backdrop">
        <div class="bg-slate-800 border border-slate-700 rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col">
            <header class="p-4 border-b border-slate-700 flex justify-between items-center flex-shrink-0">
                <h2 id="meditation-modal-title" class="text-xl font-bold text-slate-100">Méditation Guidée</h2>
                <button class="close-modal-button text-slate-400 hover:text-white text-3xl leading-none">&times;</button>
            </header>
            <div class="p-6 overflow-y-auto">
                <p id="meditation-modal-text" class="text-slate-300 leading-relaxed"></p>
            </div>
             <footer class="p-4 border-t border-slate-700 text-center flex-shrink-0">
                 <button class="close-modal-button bg-indigo-600 text-white font-bold py-2 px-6 rounded-full hover:bg-indigo-500 transition-all">Fermer</button>
             </footer>
        </div>
    </div>


    <!-- Footer -->
    <footer class="text-center py-12 border-t border-slate-800 mt-24">
        <p class="text-sm text-slate-500">&copy; 2024 Projet d'exploration spirituelle. Tous droits réservés.</p>
    </footer>

    <!-- Aura Color Bar -->
    <div id="aura-color-bar" class="fixed bottom-0 left-0 w-full bg-slate-800 text-white text-center py-2 text-sm font-semibold transition-all duration-500 z-50 translate-y-full">
        Couleur Dominante Détectée : <span id="aura-bar-color-name">...</span>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script>
        // --- DOM ELEMENTS ---
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        const startButton = document.getElementById('startButton');
        const stopButton = document.getElementById('stopButton');
        const fullscreenButton = document.getElementById('fullscreenButton');
        const startMessage = document.getElementById('start-message');
        const loadingSpinner = document.getElementById('loading-spinner');
        const resultsContainer = document.getElementById('results');
        const resultsPlaceholder = document.getElementById('results-placeholder');
        const videoContainer = document.getElementById('video-container');
        const analysisTitle = document.getElementById('analysis-title');

        // Tabs
        const liveTabButton = document.getElementById('liveTabButton');
        const photoTabButton = document.getElementById('photoTabButton');
        const liveTabContent = document.getElementById('liveTabContent');
        const photoTabContent = document.getElementById('photoTabContent');
        
        // Photo
        const photoContainer = document.getElementById('photo-container');
        const photoInput = document.getElementById('photoInput');
        const photoPreview = document.getElementById('photo-preview');
        const photoStartMessage = document.getElementById('photo-start-message');
        const photoLoadingSpinner = document.getElementById('photo-loading-spinner');
        const photoCanvas = document.getElementById('photo-canvas');
        const photoCtx = photoCanvas.getContext('2d', { willReadFrequently: true });
        const clearPhotoButton = document.getElementById('clearPhotoButton');

        // Results
        const dominantColorPreview = document.getElementById('dominant-color-preview');
        const dominantColorName = document.getElementById('dominant-color-name');
        const dominantColorWavelength = document.getElementById('dominant-color-wavelength');
        const interpretationText = document.getElementById('interpretation-text');
        const vibrationalGaugeBar = document.getElementById('vibrational-gauge-bar');
        const vibrationalRateValue = document.getElementById('vibrational-rate-value');
        const vibrationalLevelText = document.getElementById('vibrational-level-text');
        const vibrationalCommentary = document.getElementById('vibrational-commentary');
        const dailyMessage = document.getElementById('daily-message');
        const auraShapeTexture = document.getElementById('aura-shape-texture');
        const yinYangBar = document.getElementById('yin-yang-bar');
        const yinYangText = document.getElementById('yin-yang-text');
        const showSubtleBodies = document.getElementById('showSubtleBodies');
        const subtleBodiesContent = document.getElementById('subtle-bodies-content');
        const auraColorBar = document.getElementById('aura-color-bar');
        const auraBarColorName = document.getElementById('aura-bar-color-name');


        // Chakras
        const chakraDotsContainer = document.getElementById('chakra-dots-container');
        const photoChakraDotsContainer = document.getElementById('photo-chakra-dots-container');
        const chakraAnalysisContent = document.getElementById('chakra-analysis-content');

        // Recording & History
        const recordButton = document.getElementById('recordButton');
        const recordButtonText = document.getElementById('recordButtonText');
        const recordTimer = document.getElementById('recordTimer');
        const recordStatus = document.getElementById('recordStatus');
        const exportButton = document.getElementById('exportButton');
        const historyButton = document.getElementById('historyButton');
        
        // Modals
        const reportModal = document.getElementById('report-modal');
        const reportContent = document.getElementById('report-content');
        const historyModal = document.getElementById('history-modal');
        const historyContent = document.getElementById('history-content');
        const clearHistoryButton = document.getElementById('clear-history-button');
        const meditationModal = document.getElementById('meditation-modal');
        const meditationModalTitle = document.getElementById('meditation-modal-title');
        const meditationModalText = document.getElementById('meditation-modal-text');


        // Tools
        const breathingText = document.getElementById('breathing-text');
        const startBreathingButton = document.getElementById('startBreathingButton');
        const soundTherapyUI = document.getElementById('sound-therapy-ui');
        const soundFreqLabel = document.getElementById('sound-freq-label');
        const playSoundButton = document.getElementById('playSoundButton');
        const meditationUI = document.getElementById('meditation-ui');
        const meditationTitle = document.getElementById('meditation-title');
        const playMeditationButton = document.getElementById('playMeditationButton');
        const affirmationText = document.getElementById('affirmation-text');
        const newAffirmationButton = document.getElementById('newAffirmationButton');
        const remedyName = document.getElementById('remedy-name');
        const remedyDescription = document.getElementById('remedy-description');
        const aromaName = document.getElementById('aroma-name');
        const aromaDescription = document.getElementById('aroma-description');
        const colorMeaningsContainer = document.getElementById('color-meanings');

        


        // --- DATA & STATE ---
        // A short, calming vocal hum sound encoded in Base64
        const QURAN_AUDIO_B64 = 'data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA';

        const AURA_DATA = {
            'Rouge': { wavelength: '625-740', interpretation: "Force vitale, courage, patience, connexion à la terre. Un rouge équilibré indique une bonne constitution et une volonté saine au service du bien. En excès, il peut mener à la colère ou au stress, nécessitant un rappel à la patience (sabr).", sourate: "Al-Baqarah", meditation: "Méditation sur la Force d'Allah", affirmation: "Ô Allah, accorde-moi la force et la patience dans mes épreuves.", remede: {name: "Datte Ajwa", desc: "Source d'énergie et de protection"}, senteur: {name: "Ambre", desc: "Ancrant et fortifiant"}},
            'Orange': { wavelength: '590-625', interpretation: "Joie, relations sociales, créativité. Un orange lumineux est signe de bonne humeur et de sociabilité saine. Pâle ou trouble, il peut indiquer un attachement excessif ou des blocages. Se rappeler de la modération.", sourate: "Ar-Rahman", meditation: "Méditation sur la Joie des Bienfaits", affirmation: "Alhamdulillah pour les liens et la joie que Tu m'accordes.", remede: {name: "Figue", desc: "Sucrée et nutritive"}, senteur: {name: "Orange", desc: "Apporte joie et positivité"}},
            'Jaune': { wavelength: '565-590', interpretation: "Intellect, clarté, confiance. Un jaune solaire dénote un esprit clair et une confiance placée en Allah. Un jaune terne peut signaler un surmenage mental ou un besoin de contrôle. Il faut chercher la connaissance utile.", sourate: "Al-Imran", meditation: "Méditation sur la Lumière de la Sagesse", affirmation: "Ô Allah, augmente ma connaissance et ma confiance en Toi.", remede: {name: "Miel", desc: "Guérison et clarté pour l'esprit"}, senteur: {name: "Citron", desc: "Clarifiant et optimiste"}},
            'Vert': { wavelength: '520-565', interpretation: "Équilibre, croissance, compassion, nature. Le vert est la couleur du cœur apaisé (qalb salim). Il indique un état d'équilibre et de miséricorde envers la création. Un vert olive peut indiquer de l'envie, à purifier par l'invocation.", sourate: "Ya-Sin", meditation: "Méditation sur le Cœur Apaisé", affirmation: "Ô Allah, purifie mon cœur et remplis-le de compassion.", remede: {name: "Huile d'Olive", desc: "Bénie et pleine de bienfaits"}, senteur: {name: "Menthe", desc: "Purifiant et rafraîchissant"}},
            'Bleu': { wavelength: '435-520', interpretation: "Communication, paix, vérité, sérénité (sakînah). Un bleu clair et limpide est le signe d'une communication honnête et paisible. Un bleu foncé peut indiquer une introspection profonde ou de la mélancolie, cherchant le réconfort dans le dhikr.", sourate: "Al-Mulk", meditation: "Méditation sur la Paix Intérieure", affirmation: "C'est par l'évocation d'Allah que les cœurs se tranquillisent.", remede: {name: "Eau de Zamzam", desc: "Source de guérison et de paix"}, senteur: {name: "Camomille", desc: "Calmant et apaisant"}},
            'Indigo': { wavelength: '400-435', interpretation: "Intuition, sagesse, perception (firasa). L'indigo est lié à la vision intérieure du croyant. Il indique une forte intuition et une bonne connexion à sa sagesse intérieure. En excès, il peut déconnecter de la réalité, un ancrage est nécessaire.", sourate: "Al-Kahf", meditation: "Méditation sur la Vision Intérieure", affirmation: "Ô Allah, guide-moi par Ta lumière et montre-moi la vérité.", remede: {name: "Graine de Nigelle", desc: "Remède pour tout sauf la mort"}, senteur: {name: "Encens (Oliban)", desc: "Élévation spirituelle et méditatif"}},
            'Violet': { wavelength: '380-400', interpretation: "Spiritualité, connexion au Divin. Le violet est lié à la soumission et à la conscience de la Majesté d'Allah. Il dénote une conscience spirituelle élevée et un désir de proximité avec le Créateur.", sourate: "Al-Waqi'a", meditation: "Méditation de Connexion Divine", affirmation: "Je suis à Allah et c'est à Lui que je retournerai.", remede: {name: "Grenade", desc: "Fruit du Paradis, purifiant"}, senteur: {name: "Lavande", desc: "Équilibrant et purifiant"}},
            'Blanc': { wavelength: 'Spectre large', interpretation: "Pureté, clarté, protection spirituelle. Le blanc est la couleur de la pureté (tahara) et de la lumière divine (Nur). C'est une aura de haute fréquence, souvent un bouclier protecteur contre le mal.", sourate: "An-Nur", meditation: "Méditation de la Lumière Pure", affirmation: "Allah est la Lumière des cieux et de la terre.", remede: {name: "Lait", desc: "Symbole de pureté et de nourriture saine"}, senteur: {name: "Musc Blanc (Misk)", desc: "Pureté et élévation"}},
            'Rose': { wavelength: 'Combinaison', interpretation: "Amour inconditionnel, compassion (rahma), tendresse. Le rose indique un cœur rempli d'amour pour Allah et Sa création. C'est la couleur de l'affection et du pardon.", sourate: "Al-Fatiha", meditation: "Méditation sur la Miséricorde", affirmation: "Au nom d'Allah, le Tout Miséricordieux, le Très Miséricordieux.", remede: {name: "Pétale de Rose", desc: "Apaise le cœur et l'esprit"}, senteur: {name: "Rose", desc: "Amour et compassion"}},
            'Turquoise': { wavelength: '490-520', interpretation: "Guérison, communication de l'âme, protection. Le turquoise est une couleur de protection contre le mauvais œil et de guérison émotionnelle. Il favorise une expression sincère venant du cœur.", sourate: "Al-Falaq", meditation: "Méditation sur la Protection Divine", affirmation: "Je cherche protection auprès du Seigneur de l'aube naissante.", remede: {name: "Miel et Citron", desc: "Purifiant et protecteur"}, senteur: {name: "Eucalyptus", desc: "Nettoyant et clarifiant"}},
            'Or': { wavelength: 'Métallique', interpretation: "Sagesse divine, illumination, connexion spirituelle élevée. L'or symbolise la lumière de la foi (iman) et la certitude (yaqin). C'est une aura de grande sagesse et de guidance divine.", sourate: "Ayat al-Kursi", meditation: "Méditation sur le Trône Divin", affirmation: "Il n'y a de divinité qu'Allah, le Vivant, Celui qui subsiste par Lui-même.", remede: {name: "Safran", desc: "Précieux, apporte la joie"}, senteur: {name: "Oud", desc: "Royal, connexion spirituelle profonde"}},
            'Argent': { wavelength: 'Métallique', interpretation: "Intuition, pureté, connexion aux cycles naturels. L'argent est lié à la lune, qui marque le temps dans le calendrier islamique. Il indique une intuition pure et une réceptivité à la guidance divine.", sourate: "Al-Qamar", meditation: "Méditation sur les Signes d'Allah", affirmation: "Ô Allah, illumine mon chemin et purifie mon intention.", remede: {name: "Siwak", desc: "Purifiant pour le corps et l'esprit"}, senteur: {name: "Santal", desc: "Apaisant et unifiant"}},
            'Noir': { wavelength: 'Absorption', interpretation: "Protection, profondeur, phase de retrait spirituel. Le noir peut symboliser une protection divine impénétrable, comme la nuit qui couvre. C'est aussi un temps pour l'introspection profonde et le repentir.", sourate: "An-Nas", meditation: "Méditation sur le Repos en Allah", affirmation: "Je cherche protection auprès du Seigneur des hommes.", remede: {name: "Charbon végétal", desc: "Détoxifiant et purifiant"}, senteur: {name: "Patchouli", desc: "Ancrage et introspection"}},
        };
        const TAFFAKUR_DATA = {
            'Rouge': { title: "Méditation sur la Création et la Force", text: "Asseyez-vous confortablement et fermez les yeux. Respirez profondément. Pensez à la terre sous vos pieds, ferme et stable. Allah l'a créée comme un fondement pour nous. Méditez sur la force des montagnes, ancrées et immuables, un signe de Sa puissance. Ressentez cette force en vous, une force donnée par le Créateur pour faire face aux défis avec patience. (Coran 13:3)" },
            'Orange': { title: "Méditation sur les Bienfaits et la Joie", text: "Asseyez-vous confortablement et fermez les yeux. Pensez aux fruits que nous mangeons, leurs couleurs vives, leurs goûts sucrés. Chaque fruit est un bienfait et un signe d'Allah. Méditez sur la chaleur du soleil, source de vie. C'est un don d'Ar-Rahman. Laissez la gratitude et la joie remplir votre cœur. (Coran 55:10-13)" },
            'Jaune': { title: "Méditation sur la Lumière de la Sagesse", text: "Asseyez-vous confortablement et fermez les yeux. Pensez à la lumière du soleil qui dissipe les ténèbres et révèle les choses clairement. De même, la connaissance d'Allah illumine l'esprit et le cœur. Cherchez la clarté dans votre esprit, comme la clarté du jour. (Coran 39:22)" },
            'Vert': { title: "Méditation sur le Cœur Apaisé", text: "Asseyez-vous confortablement et fermez les yeux. Visualisez un jardin verdoyant, plein de vie. C'est un symbole de paix et de croissance. Votre cœur peut être comme ce jardin. Méditez sur la miséricorde d'Allah qui, comme la pluie, fait fleurir la foi dans le cœur et apporte la paix. (Coran 48:4)" },
            'Bleu': { title: "Méditation sur la Paix Intérieure", text: "Asseyez-vous confortablement et fermez les yeux. Imaginez un ciel bleu et vaste, ou un océan calme et profond. C'est un symbole de sérénité. Laissez cette tranquillité entrer en vous. C'est par l'évocation d'Allah (dhikr) que les cœurs trouvent l'apaisement. (Coran 13:28)" },
            'Indigo': { title: "Méditation sur la Vision Intérieure", text: "Asseyez-vous confortablement et fermez les yeux. Pensez à l'immensité du ciel nocturne étoilé. Chaque étoile est un signe. Regardez au-delà des apparences et demandez à Allah de vous accorder la perspicacité (firasa) pour voir la vérité et la sagesse dans Sa création. (Coran 51:20-21)" },
            'Violet': { title: "Méditation de Connexion Divine", text: "Asseyez-vous confortablement et fermez les yeux. Prenez conscience de votre existence ici et maintenant. Vous êtes une créature d'Allah. Méditez sur le fait que vous appartenez à Lui et que votre retour se fera vers Lui. Ressentez ce lien profond et la paix qui découle de cette soumission. (Coran 2:156)" },
            'Blanc': { title: "Méditation de la Lumière Pure", text: "Asseyez-vous confortablement et fermez les yeux. Imaginez une lumière blanche pure et éclatante qui vous entoure et remplit votre cœur. C'est une métaphore de la Lumière d'Allah (Nur) qui guide et protège. Laissez cette lumière purifier vos pensées et vos intentions. (Coran 24:35)" },
            'Rose': { title: "Méditation sur la Miséricorde", text: "Asseyez-vous confortablement et fermez les yeux. Pensez à la miséricorde (rahma) d'Allah, qui englobe toute chose. Pensez à l'amour d'une mère pour son enfant. La miséricorde d'Allah est infiniment plus grande. Laissez votre cœur s'adoucir et s'ouvrir à la compassion pour vous-même et pour les autres. (Coran 7:156)" },
            'Turquoise': { title: "Méditation sur la Protection Divine", text: "Asseyez-vous confortablement et fermez les yeux. Pensez à l'océan, parfois agité en surface mais calme dans ses profondeurs. Cherchez ce calme en vous. Répétez les sourates protectrices et demandez à Allah de vous protéger de tout mal, visible et invisible, comme un bouclier impénétrable. (Coran 113:1-5)" },
            'Or': { title: "Méditation sur le Trône Divin", text: "Asseyez-vous confortablement et fermez les yeux. Réfléchissez à la grandeur et à la majesté d'Allah. Le verset du Trône (Ayat al-Kursi) décrit Sa puissance infinie. Méditez sur Sa connaissance qui embrasse tout. Ressentez un profond respect et une confiance totale en Sa sagesse. (Coran 2:255)" },
            'Argent': { title: "Méditation sur les Signes d'Allah", text: "Asseyez-vous confortablement et fermez les yeux. Pensez au cycle de la lune, qui apparaît comme un fin croissant puis grandit pour devenir pleine, avant de diminuer à nouveau. C'est un signe précis et magnifique du pouvoir d'Allah, qui rythme le temps. Demandez à Allah de vous aider à voir Ses signes en toute chose. (Coran 36:39)" },
            'Noir': { title: "Méditation sur le Repos en Allah", text: "Asseyez-vous confortablement et fermez les yeux. Pensez à la nuit, qui apporte le repos et le silence. C'est un moment d'intimité et de protection. C'est dans le calme de l'introspection que l'on peut se tourner vers Allah, reconnaître ses faiblesses et trouver refuge en Lui seul. (Coran 78:10-11)" }
        };

        const CHAKRA_DATA = {
            'Base (Asas)': { color: 'Rouge', yPercent: 0.95 },
            'Sacré (Nafs)': { color: 'Orange', yPercent: 0.85 },
            'Solaire (Qalb)': { color: 'Jaune', yPercent: 0.70 },
            'Cœur (Sirr)': { color: 'Vert', yPercent: 0.55 },
            'Gorge (Ruh)': { color: 'Bleu', yPercent: 0.40 },
            '3ème Œil (Khafi)': { color: 'Indigo', yPercent: 0.25 },
            'Couronne (Akhfa)': { color: 'Violet', yPercent: 0.10 }
        };
        const SUBTLE_BODIES_DATA = [
            { name: 'Corps Physique (Jism)', desc: 'Lié à la santé et aux actions dans ce monde.', radius: 0.42, opacity: 0.35, hueShift: 0, satFactor: 0.8, valFactor: 1.2 },
            { name: 'L\'Âme (Nafs)', desc: 'Centre des désirs et des émotions, à purifier.', radius: 0.48, opacity: 0.5, hueShift: 0.05, satFactor: 1, valFactor: 1 },
            { name: 'Le Cœur (Qalb)', desc: 'Centre de la foi et des pensées. Peut être sain ou malade.', radius: 0.55, opacity: 0.3, hueShift: -0.05, satFactor: 1.2, valFactor: 0.9 },
            { name: 'Le Secret (Sirr)', desc: 'Lieu de la contemplation d\'Allah, pont vers le spirituel.', radius: 0.63, opacity: 0.2, hueShift: 0.08, satFactor: 0.7, valFactor: 1.3 },
            { name: 'L\'Esprit (Ruh)', desc: 'Le souffle divin, source de vie et de conscience.', radius: 0.70, opacity: 0.15, hueShift: 0.12, satFactor: 0.9, valFactor: 1.1 },
            { name: 'Le Caché (Khafi)', desc: 'Niveau de conscience spirituelle avancée.', radius: 0.78, opacity: 0.1, hueShift: 0.15, satFactor: 0.6, valFactor: 1.5 },
            { name: 'Le Plus Caché (Akhfa)', desc: 'Point de l\'annihilation en Dieu, la conscience pure.', radius: 0.85, opacity: 0.08, hueShift: 0, satFactor: 0.3, valFactor: 1.8 }
        ];

        let animationFrameId;
        let photoAnimationFrameId;
        let isRecording = false;
        let recordingStartTime = null;
        let recordIntervalId = null;
        let recordedData = [];
        let particles = [];
        const MAX_PARTICLES = 150;
        let time = 0;

        let breathingInterval;
        let audioContext;
        let recitationAudio, rainNoise, thunderTimeout, ambianceLfo;
        let currentAnalysisData = {};
        

        // --- INITIALIZATION ---
        function initializeApp() {
            hideResults();
            setupAccordions();
            populateColorMeanings();
            
            // Event Listeners
            startButton.addEventListener('click', startLiveAnalysis);
            stopButton.addEventListener('click', stopCamera);
            fullscreenButton.addEventListener('click', toggleFullScreen);
            photoInput.addEventListener('change', handlePhotoUpload);
            clearPhotoButton.addEventListener('click', clearPhoto);
            liveTabButton.addEventListener('click', switchTabs);
            photoTabButton.addEventListener('click', switchTabs);
            recordButton.addEventListener('click', toggleRecording);
            exportButton.addEventListener('click', exportReport);
            historyButton.addEventListener('click', showHistoryModal);
            clearHistoryButton.addEventListener('click', clearHistory);
            document.querySelectorAll('.close-modal-button').forEach(btn => btn.addEventListener('click', closeModal));
            startBreathingButton.addEventListener('click', toggleBreathingExercise);
            playSoundButton.addEventListener('click', toggleSoundTherapy);
            playMeditationButton.addEventListener('click', startTafakkurMeditation);
            newAffirmationButton.addEventListener('click', updateTherapeuticTools);
            
        }

        // --- UI MANAGEMENT & TABS ---
        function showResults(title) {
            analysisTitle.textContent = title;
            resultsContainer.classList.remove('hidden');
            resultsPlaceholder.classList.add('hidden');
            exportButton.disabled = false;
            auraColorBar.classList.remove('translate-y-full');
        }

        function hideResults() {
            analysisTitle.textContent = '';
            resultsContainer.classList.add('hidden');
            resultsPlaceholder.classList.remove('hidden');
            exportButton.disabled = true;
            resetTherapeuticTools();
            auraColorBar.classList.add('translate-y-full');
            // Reset other UI elements
            dominantColorPreview.style.backgroundColor = 'transparent';
            dominantColorName.textContent = 'En attente...';
            dominantColorWavelength.textContent = `~ ... nm`;
            interpretationText.innerHTML = "Démarrez l'analyse pour voir les résultats.";
            vibrationalGaugeBar.style.strokeDasharray = `0, 100`;
            vibrationalRateValue.textContent = '...';
            vibrationalLevelText.textContent = 'En attente...';
            chakraAnalysisContent.innerHTML = '';
            subtleBodiesContent.innerHTML = '';
        }
        
        function switchTabs(e) {
            const isLiveTab = e.currentTarget.id === 'liveTabButton';
            liveTabContent.classList.toggle('hidden', !isLiveTab);
            photoTabContent.classList.toggle('hidden', isLiveTab);
            
            liveTabButton.classList.toggle('border-indigo-500', isLiveTab);
            liveTabButton.classList.toggle('text-white', isLiveTab);
            liveTabButton.classList.toggle('border-transparent', !isLiveTab);
            liveTabButton.classList.toggle('text-slate-400', !isLiveTab);
            
            photoTabButton.classList.toggle('border-indigo-500', !isLiveTab);
            photoTabButton.classList.toggle('text-white', !isLiveTab);
            photoTabButton.classList.toggle('border-transparent', isLiveTab);
            photoTabButton.classList.toggle('text-slate-400', isLiveTab);

            if (isLiveTab) {
                if (!video.srcObject) hideResults();
                stopPhotoAnalysis();
            } else {
                stopCamera();
                if (!photoPreview.src) hideResults();
            }
        }
        
        function setupAccordions() {
            document.querySelectorAll('.accordion-header').forEach(header => {
                header.addEventListener('click', () => {
                    const content = header.nextElementSibling;
                    const icon = header.querySelector('i');
                    const allContents = document.querySelectorAll('.accordion-content');
                    const allIcons = document.querySelectorAll('.accordion-header i');

                    // Close all others
                    allContents.forEach(c => { if(c !== content) c.style.maxHeight = null; });
                    allIcons.forEach(i => { if(i !== icon) i.classList.remove('rotate-180'); });
                    
                    // Toggle current
                    if (content.style.maxHeight) {
                        content.style.maxHeight = null;
                        icon.classList.remove('rotate-180');
                    } else {
                        content.style.maxHeight = content.scrollHeight + "px";
                        icon.classList.add('rotate-180');
                    }
                });
            });
        }
        
        function populateColorMeanings() {
            colorMeaningsContainer.innerHTML = ''; // Clear previous

            const lightBackgroundColors = ['Jaune', 'Blanc', 'Argent', 'Or', 'Turquoise', 'Rose'];

            for (const color in AURA_DATA) {
                const data = AURA_DATA[color];
                const card = document.createElement('div');
                card.className = "rounded-lg p-6"; // Base classes

                let colorValue = color.toLowerCase();
                // Special hex codes for named colors that might not render well or for special cases
                if (color === 'Rouge') colorValue = '#dc2626';
                if (color === 'Jaune') colorValue = '#facc15';
                if (color === 'Vert') colorValue = '#22c55e';
                if (color === 'Bleu') colorValue = '#3b82f6';
                if (color === 'Rose') colorValue = '#ec4899';
                if (color === 'Noir') colorValue = '#1E293B'; // Darker slate
                if (color === 'Blanc') colorValue = '#f1f5f9';
                if (color === 'Or') colorValue = '#f59e0b'; // Amber color
                if (color === 'Argent') colorValue = '#9ca3af'; // Gray color
                if (color === 'Turquoise') colorValue = '#14b8a6';
                if (color === 'Orange') colorValue = '#f97316';
                if (color === 'Indigo') colorValue = '#4f46e5';
                if (color === 'Violet') colorValue = '#8b5cf6';


                // Apply background color to all cards
                card.style.backgroundColor = colorValue;

                // Determine text color based on background
                let textColor = 'text-white';
                if (lightBackgroundColors.includes(color)) {
                    textColor = 'text-slate-900';
                }
                 if (color === 'Noir') {
                    textColor = 'text-slate-300';
                 }


                card.innerHTML = `
                    <h3 class="font-bold text-lg ${textColor}">${color}</h3>
                    <p class="text-sm ${textColor} mt-2 opacity-90">${data.interpretation.split('.')[0]}.</p>
                `;

                colorMeaningsContainer.appendChild(card);
            }
        }
        
        function toggleFullScreen() {
             if (!document.fullscreenElement) {
                videoContainer.requestFullscreen().catch(err => {
                  alert(`Erreur: impossible de passer en plein écran: ${err.message} (${err.name})`);
                });
                fullscreenButton.innerHTML = `<i class="lucide lucide-minimize"></i>`;
            } else {
                document.exitFullscreen();
                fullscreenButton.innerHTML = `<i class="lucide lucide-maximize"></i>`;
            }
        }

        // --- ANALYSIS CORE (LIVE & PHOTO) ---
        async function startLiveAnalysis() {
            startMessage.classList.add('hidden');
            loadingSpinner.classList.remove('hidden');
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'user', width: { ideal: 640 }, height: { ideal: 480 } },
                    audio: false 
                });
                video.srcObject = stream;
                video.onloadedmetadata = () => {
                    video.play();
                    loadingSpinner.classList.add('hidden');
                    stopButton.classList.remove('hidden');
                    fullscreenButton.classList.remove('hidden');
                    showResults('Analyse en direct');
                    recordButton.disabled = false;
                    recordStatus.textContent = "Prêt pour l'enregistrement.";
                    
                    canvas.width = videoContainer.clientWidth;
                    canvas.height = videoContainer.clientHeight;
                    
                    animationFrameId = requestAnimationFrame(liveTick);
                };
            } catch (err) {
                console.error("Erreur d'accès à la caméra:", err);
                startMessage.innerHTML = `<p class="text-red-400">Impossible d'accéder à la caméra. Vérifiez les autorisations.</p>`;
                loadingSpinner.classList.add('hidden');
                startMessage.classList.remove('hidden');
            }
        }

        function stopCamera() {
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
                video.srcObject = null;
            }
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
                animationFrameId = null;
            }
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            chakraDotsContainer.innerHTML = '';
            particles = [];
            startMessage.classList.remove('hidden');
            stopButton.classList.add('hidden');
            fullscreenButton.classList.add('hidden');
            hideResults();
            if(isRecording) toggleRecording();
            recordButton.disabled = true;
            recordStatus.textContent = "Activez la caméra pour pouvoir enregistrer.";
            recordTimer.textContent = '00:00';
        }

        function liveTick() {
            if (!video.srcObject) return;
            const { width, height } = canvas;
            ctx.save();
            ctx.clearRect(0, 0, width, height);
            ctx.translate(width, 0);
            ctx.scale(-1, 1);
            ctx.drawImage(video, 0, 0, width, height);
            ctx.restore();

            const imageData = ctx.getImageData(0, 0, width, height);
            processFrame(imageData);
            
            const { avgR, avgG, avgB, vibrationalRate } = currentAnalysisData;
            
            if (showSubtleBodies.checked) {
                drawSubtleBodies(ctx, width, height, [avgR, avgG, avgB]);
            } else {
                drawAuraLayer(ctx, width, height, [avgR, avgG, avgB], 0.6, 0.6);
            }
            manageParticles(ctx, width, height, avgR, avgG, avgB, vibrationalRate);

            animationFrameId = requestAnimationFrame(liveTick);
        }
        
        function handlePhotoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            photoStartMessage.classList.add('hidden');
            photoLoadingSpinner.classList.remove('hidden');
            photoPreview.classList.add('hidden');
            photoCtx.clearRect(0,0, photoCanvas.width, photoCanvas.height);

            const reader = new FileReader();
            reader.onload = e => {
                const img = new Image();
                img.onload = () => {
                    photoLoadingSpinner.classList.add('hidden');
                    photoPreview.src = e.target.result;
                    photoPreview.classList.remove('hidden');
                    clearPhotoButton.classList.remove('hidden');
                    startPhotoAnalysis(img);
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
        
        function startPhotoAnalysis(img) {
            showResults('Analyse de la Photo');
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d', { willReadFrequently: true });
            tempCanvas.width = img.width;
            tempCanvas.height = img.height;
            tempCtx.drawImage(img, 0, 0);
            const imageData = tempCtx.getImageData(0, 0, img.width, img.height);
            processFrame(imageData);
            
            photoCanvas.width = photoContainer.clientWidth;
            photoCanvas.height = photoContainer.clientHeight;

            if (photoAnimationFrameId) cancelAnimationFrame(photoAnimationFrameId);
            photoAnimationFrameId = requestAnimationFrame(photoTick);
        }

        function photoTick() {
            const { width, height } = photoCanvas;
            photoCtx.clearRect(0, 0, width, height);
            time += 0.02;
            const pulseOpacity = 0.6 + Math.sin(time) * 0.1;

            const { avgR, avgG, avgB, vibrationalRate } = currentAnalysisData;

            if (showSubtleBodies.checked) {
                drawSubtleBodies(photoCtx, width, height, [avgR, avgG, avgB]);
            } else {
                drawAuraLayer(photoCtx, width, height, [avgR, avgG, avgB], 0.7, pulseOpacity);
            }
            manageParticles(photoCtx, width, height, avgR, avgG, avgB, vibrationalRate * 0.5); // Slower particles for static image

            photoAnimationFrameId = requestAnimationFrame(photoTick);
        }

        function stopPhotoAnalysis() {
            if (photoAnimationFrameId) {
                cancelAnimationFrame(photoAnimationFrameId);
                photoAnimationFrameId = null;
            }
            photoCtx.clearRect(0, 0, photoCanvas.width, photoCanvas.height);
            photoChakraDotsContainer.innerHTML = '';
             particles = [];
        }

        function clearPhoto() {
            stopPhotoAnalysis();
            photoPreview.classList.add('hidden');
            photoPreview.src = '';
            clearPhotoButton.classList.add('hidden');
            photoInput.value = null;
            photoStartMessage.classList.remove('hidden');
            hideResults();
        }

        // --- PROCESSING & LOGIC ---
        function processFrame(imageData) {
            const { avgR, avgG, avgB, count, stdDev } = calculateColorStats(imageData);
            if (count === 0) return;
            
            const vibrationalRate = calculateVibrationalRate(avgR, avgG, avgB, stdDev);
            const [h, s, v] = rgbToHsv(avgR, avgG, avgB);
            const colorName = getColorName(h, s, v);
            const chakras = analyzeChakras(imageData);
            const yinYang = calculateYinYang(avgR, avgG, avgB);
            
            currentAnalysisData = { avgR, avgG, avgB, h, s, v, vibrationalRate, colorName, chakras, yinYang, stdDev };

            if(isRecording) {
                 const now = Date.now();
                 if (!recordedData.length || now - recordedData[recordedData.length - 1].t > 1000) {
                     recordedData.push({ t: now, r: avgR, g: avgG, b: avgB, s:s, v:v, vRate: vibrationalRate, chakras });
                 }
            }

            updateUI();
        }

        function calculateColorStats(imageData) {
            const { data, width, height } = imageData;
            let r = 0, g = 0, b = 0, count = 0;
            const radius = Math.min(width, height) * 0.25;
            const centerX = width / 2;
            const centerY = height / 2;
            const pixels = [];

            for (let y = 0; y < height; y += 4) {
                for (let x = 0; x < width; x += 4) {
                    const dist = Math.sqrt(Math.pow(x - centerX, 2) + Math.pow(y - centerY, 2));
                    if (dist > radius * 0.6 && dist < radius) {
                        const index = (y * width + x) * 4;
                        const pr = data[index];
                        const pg = data[index + 1];
                        const pb = data[index + 2];
                        r += pr; g += pg; b += pb;
                        pixels.push(pr, pg, pb);
                        count++;
                    }
                }
            }
            if (count > 0) {
                const avgR = r / count, avgG = g / count, avgB = b / count;
                let stdDev = 0;
                for(let i = 0; i < pixels.length; i += 3) {
                    stdDev += Math.pow(pixels[i] - avgR, 2);
                    stdDev += Math.pow(pixels[i+1] - avgG, 2);
                    stdDev += Math.pow(pixels[i+2] - avgB, 2);
                }
                stdDev = Math.sqrt(stdDev / (pixels.length));
                return { avgR, avgG, avgB, count, stdDev };
            }
            return { avgR: 0, avgG: 0, avgB: 0, count: 0, stdDev: 0 };
        }

        function calculateVibrationalRate(r, g, b, stdDev) {
            const [h, s, v] = rgbToHsv(r, g, b);
            const maxRate = 20000;
            const coherenceFactor = Math.max(0.1, 1 - (stdDev / 100)); // Lower deviation = higher coherence
            let rate = maxRate * (v * 0.6 + s * 0.2 + coherenceFactor * 0.2);
            return Math.max(0, Math.floor(rate));
        }
        
        function calculateYinYang(r, g, b) {
            // Simplistic model: cooler colors (blue/green) are more Jamal, warmer (red/yellow) more Jalal.
            const jamal = b + g;
            const jalal = r + (r+g)/2; // Approximating yellow
            const total = jamal + jalal;
            if (total === 0) return 0.5;
            return Math.max(0, Math.min(1, jalal / total)); // a value from 0 (Jamal) to 1 (Jalal)
        }
        
        function analyzeChakras(imageData) {
            const { data, width, height } = imageData;
            const results = {};
            const chakraKeys = Object.keys(CHAKRA_DATA);

            for (const name of chakraKeys) {
                const chakra = CHAKRA_DATA[name];
                const y = Math.floor(height * chakra.yPercent);
                const x = Math.floor(width / 2);
                let r=0, g=0, b=0, count=0;
                
                // Sample a small area around the chakra point
                for (let j = -2; j <= 2; j++) {
                    for (let i = -2; i <= 2; i++) {
                        const index = ((y + j) * width + (x + i)) * 4;
                        if(index >= 0 && index < data.length) {
                             r += data[index]; g += data[index+1]; b += data[index+2];
                             count++;
                        }
                    }
                }
                const avgR = r/count, avgG = g/count, avgB = b/count;
                const [h, s, v] = rgbToHsv(avgR, avgG, avgB);
                const activity = Math.round((s + v) / 2 * 100);
                results[name] = { r: avgR, g: avgG, b: avgB, activity };
            }
            return results;
        }

        function getColorName(h, s, v) { 
            if (s < 0.1 && v > 0.9) return 'Blanc'; 
            if (v < 0.15) return 'Noir';
            if ((h > 0.9 || h < 0.04) && s > 0.6) return 'Rouge';
            if (h < 0.11) return 'Orange';
            if (h < 0.18) return 'Jaune';
            if (h < 0.45) return 'Vert';
            if (h > 0.48 && h < 0.58) return 'Turquoise';
            if (h < 0.70) return 'Bleu';
            if (h < 0.80) return 'Indigo';
            if (s > 0.5) return 'Violet';
            if (s < 0.2 && v < 0.5) return 'Noir'; // Broader black/dark
            return 'Blanc'; // Default fallback
        }


        // --- UI UPDATES ---
        function updateUI() {
            const { avgR, avgG, avgB, vibrationalRate, colorName, chakras, yinYang, stdDev } = currentAnalysisData;
            
            // Aura
            dominantColorPreview.style.backgroundColor = `rgb(${avgR}, ${avgG}, ${avgB})`;
            dominantColorName.textContent = colorName;
            auraBarColorName.textContent = colorName;
            auraColorBar.style.backgroundColor = `rgb(${avgR}, ${avgG}, ${avgB})`;

            // Make text readable on the bar
            const brightness = (avgR * 299 + avgG * 587 + avgB * 114) / 1000;
            auraColorBar.style.color = brightness > 128 ? 'black' : 'white';


            const colorData = AURA_DATA[colorName];
            if (colorData) {
                dominantColorWavelength.textContent = `~ ${colorData.wavelength} nm`;
                interpretationText.innerHTML = `<strong class="block mb-1 text-slate-100">Signification Générale</strong> ${colorData.interpretation}`;
            }

            // Vibrational
            const tier = getVibrationalTier(vibrationalRate); 
            vibrationalRateValue.textContent = vibrationalRate.toLocaleString('fr-FR'); 
            const percentage = Math.min(100, (vibrationalRate / 20000) * 100); 
            vibrationalGaugeBar.style.strokeDasharray = `${percentage}, 100`; 
            vibrationalGaugeBar.style.stroke = tier.colorHex; 
            vibrationalLevelText.textContent = tier.level; 
            vibrationalCommentary.textContent = tier.commentary;
            
            // Chakras & Subtle Bodies
            updateChakraUI(chakras);
            updateSubtleBodiesUI();
            
            // Shape/Texture
            auraShapeTexture.textContent = getShapeTextureInterpretation(stdDev);
            
            // Yin/Yang
            yinYangBar.style.width = `${yinYang * 100}%`;
            if(yinYang < 0.4) yinYangText.textContent = "Dominante Jamal";
            else if (yinYang > 0.6) yinYangText.textContent = "Dominante Jalal";
            else yinYangText.textContent = "Équilibré";
            
            // Update tools only if they haven't been manually activated
            if (!recitationAudio && !breathingInterval) {
                 updateTherapeuticTools();
            }
        }
        
        function updateChakraUI(chakras) {
             let html = '';
             let dotsHtml = '';
             const isLive = liveTabContent.classList.contains('hidden') === false;

             for (const name in chakras) {
                 const chakra = chakras[name];
                 const chakraInfo = CHAKRA_DATA[name];
                 const balance = chakra.activity > 30 && chakra.activity < 80 ? 'Équilibré' : (chakra.activity <= 30 ? 'Bloqué' : 'Hyperactif');
                 
                 html += `
                     <div class="flex items-center text-sm">
                         <div class="w-4 h-4 rounded-full mr-3" style="background-color: rgb(${chakra.r}, ${chakra.g}, ${chakra.b}); border: 1px solid rgba(255,255,255,0.2)"></div>
                         <div class="flex-1 font-semibold">${name}</div>
                         <div class="w-16 text-right">${balance}</div>
                         <div class="w-12 text-right">${chakra.activity}%</div>
                     </div>`;
                 
                 const dotSize = 4 + (chakra.activity / 100) * 12;
                 dotsHtml += `
                    <div class="absolute chakra-dot" style="
                        left: 50%; top: ${chakraInfo.yPercent * 100}%; 
                        width: ${dotSize}px; height: ${dotSize}px; 
                        transform: translate(-50%, -50%);
                        background-color: rgb(${chakra.r}, ${chakra.g}, ${chakra.b});
                        border-radius: 50%;
                        box-shadow: 0 0 ${dotSize * 1.5}px rgb(${chakra.r}, ${chakra.g}, ${chakra.b});
                    "></div>`;
             }
             chakraAnalysisContent.innerHTML = html;
             if (isLive) {
                chakraDotsContainer.innerHTML = dotsHtml;
                photoChakraDotsContainer.innerHTML = '';
             } else {
                photoChakraDotsContainer.innerHTML = dotsHtml;
                chakraDotsContainer.innerHTML = '';
             }
        }
        
        function updateSubtleBodiesUI() {
            const { h, s, v, stdDev } = currentAnalysisData;
            let html = '';
            
            // Physical body tied to brightness/vitality (v)
            const physicalState = v > 0.7 ? 'Vibrant' : (v < 0.4 ? 'Faible' : 'Stable');
            // Nafs tied to saturation (s)
            const nafsState = s > 0.8 ? 'Agité' : (s < 0.4 ? 'Calme' : 'Équilibré');
            // Qalb tied to coherence (stdDev)
            const qalbState = stdDev < 15 ? 'Clair et Serein' : (stdDev > 40 ? 'Agité' : 'Actif');

            html += `<div><strong>1. Corps Physique (Jism):</strong> ${physicalState} <br><small class="text-slate-400">${SUBTLE_BODIES_DATA[0].desc}</small></div>`;
            html += `<div><strong>2. L'Âme (Nafs):</strong> ${nafsState} <br><small class="text-slate-400">${SUBTLE_BODIES_DATA[1].desc}</small></div>`;
            html += `<div><strong>3. Le Cœur (Qalb):</strong> ${qalbState} <br><small class="text-slate-400">${SUBTLE_BODIES_DATA[2].desc}</small></div>`;

            subtleBodiesContent.innerHTML = html;
        }


        function getShapeTextureInterpretation(stdDev) {
            if (stdDev < 15) return "L'esprit semble clair et cohérent, signe d'un état de paix intérieure et de concentration (khushu).";
            if (stdDev < 30) return "L'esprit a une clarté douce et fluide. Les pensées circulent bien. C'est un état d'équilibre dynamique et de contentement (rida).";
            if (stdDev < 50) return "L'esprit semble quelque peu confus ou agité. Cela peut indiquer des pensées dispersées (waswas) ou des préoccupations. Un besoin de se recentrer sur le dhikr est suggéré.";
            return "L'esprit présente une grande dispersion. Cela peut être lié à un état d'anxiété, ou une forte réaction à l'environnement. Un travail de protection par les invocations est recommandé.";
        }

        // --- THERAPEUTIC TOOLS ---
        function updateTherapeuticTools() {
            const { colorName } = currentAnalysisData;
            if (!colorName) return;
            const data = AURA_DATA[colorName];
            if (!data) return; // Exit if color not in data
            
            // Unblock UI
            [soundTherapyUI, meditationUI, newAffirmationButton, document.getElementById('remedies-ui'), document.getElementById('aroma-ui')].forEach(el => el.classList.remove('opacity-50'));
            [playSoundButton, playMeditationButton, newAffirmationButton].forEach(btn => btn.disabled = false);

            // Sound Therapy
            soundFreqLabel.textContent = `Sourate Recommandée : ${data.sourate}`;
            
            // Meditation
            meditationTitle.textContent = data.meditation;
            
            // Affirmations
            affirmationText.textContent = `"${data.affirmation}"`;

            // Remedies
            remedyName.textContent = data.remede.name;
            remedyDescription.textContent = data.remede.desc;
            
            // Aroma
            aromaName.textContent = data.senteur.name;
            aromaDescription.textContent = data.senteur.desc;
            
            // Daily Message
            if (dailyMessage) {
                dailyMessage.textContent = `Votre lumière ${colorName.toLowerCase()} vous invite aujourd'hui à vous concentrer sur la patience et la gratitude. ${data.affirmation}`;
            }
        }

        function resetTherapeuticTools() {
             [soundTherapyUI, meditationUI, newAffirmationButton, document.getElementById('remedies-ui'), document.getElementById('aroma-ui')].forEach(el => el.classList.add('opacity-50'));
             [playSoundButton, playMeditationButton, newAffirmationButton].forEach(btn => btn.disabled = true);
             if(soundFreqLabel) soundFreqLabel.textContent = '...';
             if(meditationTitle) meditationTitle.textContent = '...';
             if(affirmationText) affirmationText.textContent = '"..."';
             if(remedyName) remedyName.textContent = '...';
             if(aromaName) aromaName.textContent = '...';
             if(dailyMessage) dailyMessage.textContent = '';
        }
        
        
        function toggleBreathingExercise() {
            if (breathingInterval) {
                clearInterval(breathingInterval);
                breathingInterval = null;
                startBreathingButton.textContent = "Commencer";
                breathingText.textContent = "Prêt ?";
            } else {
                startBreathingButton.textContent = "Arrêter";
                let phase = 0;
                const phases = [
                    { text: "Inspirez... (Ya Rahman)", duration: 4000 },
                    { text: "Retenez (Ya Quddus)", duration: 4000 },
                    { text: "Expirez... (Ya Salam)", duration: 4000 },
                    { text: "Pause (Alhamdulillah)", duration: 4000 }
                ];
                
                const nextPhase = () => {
                    breathingText.textContent = phases[phase].text;
                    setTimeout(() => {
                        phase = (phase + 1) % phases.length;
                    }, phases[phase].duration - 200);
                }
                
                breathingInterval = setInterval(nextPhase, 4000);
                nextPhase();
            }
        }
        
        function toggleSoundTherapy() {
            if (recitationAudio && !recitationAudio.paused) { // Sound is playing, stop it
                recitationAudio.pause();
                recitationAudio.currentTime = 0;
                recitationAudio = null;

                if (rainNoise) rainNoise.stop();
                if (ambianceLfo) ambianceLfo.stop();
                if (thunderTimeout) clearTimeout(thunderTimeout);
                
                rainNoise = null;
                ambianceLfo = null;
                thunderTimeout = null;
                
                if (audioContext && audioContext.state !== 'closed') {
                    audioContext.close().then(() => audioContext = null);
                }

                playSoundButton.innerHTML = '<i class="lucide lucide-play"></i> Lancer la Lecture';

            } else { // Sound is stopped, play it
                if (!audioContext || audioContext.state === 'closed') {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                const now = audioContext.currentTime;

                // --- Background Ambiance ---
                
                // 1. Rain Sound with varying intensity
                const rainBufferSize = 2 * audioContext.sampleRate;
                const rainBuffer = audioContext.createBuffer(1, rainBufferSize, audioContext.sampleRate);
                const rainOutput = rainBuffer.getChannelData(0);
                let lastRainOut = 0.0;
                for (let i = 0; i < rainBufferSize; i++) {
                    const white = Math.random() * 2 - 1;
                    rainOutput[i] = (lastRainOut + (0.02 * white)) / 1.02;
                    lastRainOut = rainOutput[i];
                    rainOutput[i] *= 3.5;
                }
                rainNoise = audioContext.createBufferSource();
                rainNoise.buffer = rainBuffer;
                rainNoise.loop = true;
                
                const rainGain = audioContext.createGain();
                rainGain.gain.value = 0.04; // Base volume

                // LFO for volume variation
                ambianceLfo = audioContext.createOscillator();
                ambianceLfo.type = 'sine';
                ambianceLfo.frequency.value = 0.05; // Very slow fluctuation (1 cycle every 20 seconds)
                const lfoGain = audioContext.createGain();
                lfoGain.gain.value = 0.03; // Fluctuation depth

                ambianceLfo.connect(lfoGain).connect(rainGain.gain);
                rainNoise.connect(rainGain).connect(audioContext.destination);
                
                ambianceLfo.start();
                rainNoise.start();

                // 2. Thunder with varying intensity and timing
                const createThunder = () => {
                    if (!audioContext || audioContext.state === 'closed') return;
                    const thunderTime = audioContext.currentTime;
                    const thunderSource = audioContext.createBufferSource();
                    const thunderBufferSize = audioContext.sampleRate * 2;
                    const thunderBuffer = audioContext.createBuffer(1, thunderBufferSize, audioContext.sampleRate);
                    const thunderOutput = thunderBuffer.getChannelData(0);
                    for (let i = 0; i < thunderBufferSize; i++) {
                        thunderOutput[i] = Math.random() * 2 - 1;
                    }
                    thunderSource.buffer = thunderBuffer;

                    const biquadFilter = audioContext.createBiquadFilter();
                    biquadFilter.type = 'lowpass';
                    biquadFilter.frequency.setValueAtTime(400, thunderTime);
                    biquadFilter.frequency.linearRampToValueAtTime(100, thunderTime + 1.5);
                    
                    const thunderGain = audioContext.createGain();
                    thunderGain.gain.setValueAtTime(0, thunderTime);
                    thunderGain.gain.linearRampToValueAtTime(0.15 + Math.random() * 0.2, thunderTime + 0.05); // Random intensity
                    thunderGain.gain.exponentialRampToValueAtTime(0.01, thunderTime + 2.5);

                    thunderSource.connect(biquadFilter).connect(thunderGain).connect(audioContext.destination);
                    thunderSource.start(thunderTime);
                };

                const scheduleThunder = () => {
                    const delay = 15000 + Math.random() * 20000; // Next thunder in 15-35 seconds
                    thunderTimeout = setTimeout(() => {
                        if (!audioContext || audioContext.state === 'closed') return;
                        createThunder();
                        scheduleThunder();
                    }, delay);
                };
                scheduleThunder();

                // --- Play Recitation Audio ---
                recitationAudio = new Audio(QURAN_AUDIO_B64);
                recitationAudio.loop = true;
                recitationAudio.play();
                
                playSoundButton.innerHTML = '<i class="lucide lucide-stop-circle"></i> Arrêter';
            }
        }
        
        function startTafakkurMeditation() {
            const { colorName } = currentAnalysisData;
            if (!colorName || !TAFFAKUR_DATA[colorName]) {
                // Default message if no analysis is done
                meditationModalTitle.textContent = "Méditation Guidée";
                meditationModalText.textContent = "Veuillez d'abord lancer une analyse pour recevoir une méditation personnalisée.";
            } else {
                const meditationData = TAFFAKUR_DATA[colorName];
                meditationModalTitle.textContent = meditationData.title;
                meditationModalText.textContent = meditationData.text;
            }
            meditationModal.classList.remove('hidden');
        }

        // --- RECORDING, REPORTING, HISTORY ---
        function toggleRecording() {
             isRecording = !isRecording; 
             if(isRecording) { 
                 recordedData = []; 
                 recordingStartTime = Date.now(); 
                 recordButtonText.textContent = "Arrêter"; 
                 recordButton.classList.add('bg-red-600', 'hover:bg-red-500', 'recording-pulse'); 
                 recordButton.classList.remove('bg-sky-600', 'hover:bg-sky-500'); 
                 recordStatus.textContent = "Enregistrement en cours..."; 
                 recordIntervalId = setInterval(updateTimer, 1000); 
             } else { 
                 clearInterval(recordIntervalId);
                 recordIntervalId = null;
                 recordButtonText.textContent = "Démarrer"; 
                 recordButton.classList.remove('bg-red-600', 'hover:bg-red-500', 'recording-pulse'); 
                 recordButton.classList.add('bg-sky-600', 'hover:bg-sky-500'); 
                 recordStatus.textContent = `Enregistrement terminé.`; 
                 generateReport(recordedData); 
             }
        }
        
        function updateTimer() { 
             const elapsedSeconds = Math.floor((Date.now() - recordingStartTime) / 1000); 
             recordTimer.textContent = formatTime(elapsedSeconds);
        }
        
        function formatTime(seconds) {
             const m = Math.floor(seconds / 60).toString().padStart(2, '0'); 
             const s = (seconds % 60).toString().padStart(2, '0'); 
             return `${m}:${s}`;
        }

        function generateReport(data) {
            if (data.length < 2) {
                reportContent.innerHTML = `<p class="text-center">Pas assez de données pour un rapport fiable.</p>`;
                reportModal.classList.remove('hidden');
                return;
            };
            
            const vRates = data.map(d => d.vRate);
            const avgVRate = Math.round(vRates.reduce((a, b) => a + b, 0) / vRates.length);
            const avgTier = getVibrationalTier(avgVRate);
            const colorAggregates = {};
            data.forEach(d => {
                const colorName = getColorName(rgbToHsv(d.r, d.g, d.b)[0], d.s, d.v);
                colorAggregates[colorName] = (colorAggregates[colorName] || 0) + 1;
            });
            const dominantColor = Object.keys(colorAggregates).reduce((a, b) => colorAggregates[a] > colorAggregates[b] ? a : b);
            
            const sessionReport = {
                date: new Date().toISOString(),
                duration: data.length,
                dominantColor,
                avgVRate,
                timeline: data.map(d => `rgb(${Math.round(d.r)}, ${Math.round(d.g)}, ${Math.round(d.b)})`),
            };
            
            saveSession(sessionReport);

            reportContent.innerHTML = `
                <div class="text-center mb-4"><p>Session du ${new Date(sessionReport.date).toLocaleString('fr-FR')}</p></div>
                <div><h3 class="font-semibold text-sky-400 mb-2">Ligne de Temps Énergétique</h3>
                    <div class="w-full h-10 bg-slate-900 rounded-lg flex overflow-hidden">
                        ${sessionReport.timeline.map(c => `<div style="flex-grow: 1; background-color: ${c};"></div>`).join('')}
                    </div>
                </div>
                <div><h3 class="font-semibold text-sky-400 mb-2">Synthèse</h3>
                    <p><strong>Couleur Dominante:</strong> ${dominantColor}</p>
                    <p><strong>Niveau de Paix Intérieure Moyen:</strong> ${avgVRate.toLocaleString('fr-FR')} (${avgTier.level})</p>
                </div>`;
            reportModal.classList.remove('hidden');
        }
        
        function saveSession(report) {
            let history = JSON.parse(localStorage.getItem('auraHistory') || '[]');
            history.unshift(report); // Add to the beginning
            history = history.slice(0, 50); // Keep max 50 sessions
            localStorage.setItem('auraHistory', JSON.stringify(history));
        }

        function showHistoryModal() {
            let history = JSON.parse(localStorage.getItem('auraHistory') || '[]');
            if (history.length === 0) {
                 historyContent.innerHTML = `<p class="text-center text-slate-400">Aucun enregistrement trouvé.</p>`;
            } else {
                historyContent.innerHTML = history.map(session => `
                    <div class="bg-slate-900/50 p-4 rounded-lg mb-4">
                        <p class="font-bold">Session du ${new Date(session.date).toLocaleString('fr-FR')}</p>
                        <p class="text-sm">Durée: ${session.duration}s | Couleur dom: ${session.dominantColor} | Paix moy: ${session.avgVRate}</p>
                         <div class="w-full h-6 bg-slate-900 rounded-lg flex overflow-hidden mt-2">
                            ${session.timeline.map(c => `<div style="flex-grow: 1; background-color: ${c};"></div>`).join('')}
                        </div>
                    </div>
                `).join('');
            }
            historyModal.classList.remove('hidden');
        }
        
        function clearHistory() {
            if(confirm("Voulez-vous vraiment supprimer tout l'historique des sessions ?")) {
                localStorage.removeItem('auraHistory');
                historyContent.innerHTML = `<p class="text-center text-slate-400">Historique effacé.</p>`;
            }
        }
        
        function exportReport() {
            const resultsNode = document.getElementById('results');
            html2canvas(resultsNode, { backgroundColor: "#1e293b" }).then(canvas => {
                const link = document.createElement('a');
                link.download = `rapport-spirituel-${new Date().toISOString().slice(0,10)}.png`;
                link.href = canvas.toDataURL();
                link.click();
            });
        }
        
        function closeModal() {
            reportModal.classList.add('hidden');
            historyModal.classList.add('hidden');
            meditationModal.classList.add('hidden');
        }

        // --- UTILITIES ---
        function getVibrationalTier(rate) { 
            const tiers = { tres_bas: {level:'Très Bas', colorHex:'#ef4444', commentary:'Signal dispersé, ghaflah (insouciance) ou tristesse profonde.'}, bas: {level:'Bas', colorHex:'#f97316', commentary:'Faible cohérence, préoccupations mondaines ou tension.'}, equilibre: {level:'Équilibré', colorHex:'#22c55e', commentary:'Signal stable, état de contentement général (rida).'}, eleve: {level:'Élevé', colorHex:'#38bdf8', commentary:'Forte cohérence, clarté mentale et bien-être (ihsan).'}, optimal: {level:'Optimal', colorHex:'#8b5cf6', commentary:'Pic de cohérence, paix intérieure profonde (sakînah).'}};
            if (rate <= 4000) return tiers.tres_bas; 
            if (rate <= 7500) return tiers.bas; 
            if (rate <= 11000) return tiers.equilibre; 
            if (rate <= 15000) return tiers.eleve; 
            return tiers.optimal;
        }

        function rgbToHsv(r, g, b) {
            r /= 255, g /= 255, b /= 255; 
            let max = Math.max(r, g, b), min = Math.min(r, g, b); 
            let h, s, v = max; 
            let d = max - min; 
            s = max == 0 ? 0 : d / max; 
            if (max == min) h = 0;
            else { 
                switch (max) { 
                    case r: h = (g - b) / d + (g < b ? 6 : 0); break; 
                    case g: h = (b - r) / d + 2; break; 
                    case b: h = (r - g) / d + 4; break; 
                } 
                h /= 6; 
            } 
            return [h, s, v];
        }
        
        function hsvToRgb(h, s, v) {
            let r, g, b;
            let i = Math.floor(h * 6);
            let f = h * 6 - i;
            let p = v * (1 - s);
            let q = v * (1 - f * s);
            let t = v * (1 - (1 - f) * s);
            switch (i % 6) {
                case 0: r = v, g = t, b = p; break;
                case 1: r = q, g = v, b = p; break;
                case 2: r = p, g = v, b = t; break;
                case 3: r = p, g = q, b = v; break;
                case 4: r = t, g = p, b = v; break;
                case 5: r = v, g = p, b = q; break;
            }
            return [Math.round(r * 255), Math.round(g * 255), Math.round(b * 255)];
        }
        
        // --- VISUALIZATION ---
        function drawAuraLayer(currentCtx, width, height, rgb, radiusFactor, opacity) {
            const gradient = currentCtx.createRadialGradient(
                width / 2, height / 2, width * (radiusFactor * 0.5),
                width / 2, height / 2, width * radiusFactor
            );
            gradient.addColorStop(0, `rgba(${rgb[0]}, ${rgb[1]}, ${rgb[2]}, ${opacity * 0.8})`);
            gradient.addColorStop(1, `rgba(${rgb[0]}, ${rgb[1]}, ${rgb[2]}, 0)`);
            
            currentCtx.globalCompositeOperation = 'lighter';
            currentCtx.fillStyle = gradient;
            currentCtx.fillRect(0, 0, width, height);
            currentCtx.globalCompositeOperation = 'source-over';
        }
        
        function drawSubtleBodies(currentCtx, width, height, baseRgb) {
            time += 0.02;
            const [h, s, v] = rgbToHsv(baseRgb[0], baseRgb[1], baseRgb[2]);
            const pulse = Math.sin(time) * 0.01;

            SUBTLE_BODIES_DATA.forEach(body => {
                const bodyH = (h + body.hueShift + 1) % 1;
                const bodyS = Math.max(0, Math.min(1, s * body.satFactor));
                const bodyV = Math.max(0, Math.min(1, v * body.valFactor));
                const bodyRgb = hsvToRgb(bodyH, bodyS, bodyV);
                const bodyRadius = body.radius + pulse * (body.radius * 0.5);
                drawAuraLayer(currentCtx, width, height, bodyRgb, bodyRadius, body.opacity);
            });
        }

        function manageParticles(currentCtx, width, height, r, g, b, vibrationalRate) {
            const baseSpeed = Math.max(0.5, vibrationalRate / 10000);

            if (particles.length < MAX_PARTICLES && Math.random() > 0.5) {
                const angle = Math.random() * Math.PI * 2;
                const radius = (width * 0.3) + Math.random() * (width * 0.3);
                const x = width / 2 + Math.cos(angle) * radius;
                const y = height / 2 + Math.sin(angle) * radius;
                particles.push({ x, y, vx: (Math.random() - 0.5) * baseSpeed, vy: (Math.random() - 0.5) * baseSpeed, life: 1, size: Math.random() * 2 + 1, r, g, b });
            }

            currentCtx.globalCompositeOperation = 'lighter';
            for (let i = particles.length - 1; i >= 0; i--) {
                let p = particles[i];
                p.x += p.vx; p.y += p.vy; p.life -= 0.01;
                if (p.life <= 0) { particles.splice(i, 1); continue; }
                currentCtx.beginPath();
                currentCtx.fillStyle = `rgba(${p.r}, ${p.g}, ${p.b}, ${p.life * 0.8})`;
                currentCtx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                currentCtx.fill();
            }
            currentCtx.globalCompositeOperation = 'source-over';
        }

        // --- Start the app ---
        document.addEventListener('DOMContentLoaded', initializeApp);

    </script>
</body>
</html>

