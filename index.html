<!DOCTYPE html>
<html lang="fr" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analyseur Spirituel Halal - IA Avanc√©e 2025</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.11.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/blazeface@0.0.7"></script>
    
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --glass-bg: rgba(15, 23, 42, 0.7);
            --glass-border: rgba(255, 255, 255, 0.1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
            background-attachment: fixed;
            overflow-x: hidden;
        }
        
        /* Advanced Glassmorphism */
        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid var(--glass-border);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }
        
        .glass-card-hover {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .glass-card-hover:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 60px 0 rgba(102, 126, 234, 0.3);
            border-color: rgba(102, 126, 234, 0.5);
        }
        
        /* Gradient Text */
        .gradient-text {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: gradient-shift 3s ease infinite;
            background-size: 200% 200%;
        }
        
        @keyframes gradient-shift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        
        /* Advanced Video Container */
        .video-container-advanced {
            position: relative;
            border-radius: 24px;
            overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }
        
        .video-feed {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
        }
        
        .aura-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            mix-blend-mode: screen;
        }
        
        /* Neural Network Animation */
        .neural-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            opacity: 0.03;
            pointer-events: none;
        }
        
        /* Advanced Button Styles */
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            font-weight: 600;
            padding: 14px 32px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 10px 25px -5px rgba(102, 126, 234, 0.4);
            position: relative;
            overflow: hidden;
        }
        
        .btn-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s;
        }
        
        .btn-primary:hover::before {
            left: 100%;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 35px -5px rgba(102, 126, 234, 0.6);
        }
        
        .btn-primary:active {
            transform: translateY(0);
        }
        
        /* Chakra Visualization */
        .chakra-dot {
            position: absolute;
            border-radius: 50%;
            animation: chakra-pulse 2s ease-in-out infinite;
            filter: drop-shadow(0 0 10px currentColor);
        }
        
        @keyframes chakra-pulse {
            0%, 100% { transform: translate(-50%, -50%) scale(1); opacity: 0.8; }
            50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
        }
        
        /* Advanced Accordion */
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .accordion-header {
            transition: all 0.3s ease;
        }
        
        .accordion-header:hover {
            background: rgba(102, 126, 234, 0.1);
        }
        
        /* Particle System */
        .particle {
            position: absolute;
            border-radius: 50%;
            pointer-events: none;
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0) translateX(0); }
            50% { transform: translateY(-20px) translateX(10px); }
        }
        
        /* Loading Spinner */
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(102, 126, 234, 0.2);
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Vibrational Gauge */
        .gauge-container {
            position: relative;
            width: 200px;
            height: 200px;
        }
        
        .gauge-bg {
            stroke: rgba(100, 116, 139, 0.2);
        }
        
        .gauge-fill {
            stroke: url(#gaugeGradient);
            stroke-linecap: round;
            transition: stroke-dasharray 1s cubic-bezier(0.4, 0, 0.2, 1);
            filter: drop-shadow(0 0 8px rgba(102, 126, 234, 0.6));
        }
        
        /* Modal Backdrop */
        .modal-backdrop {
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(10px);
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
        }
        
        ::-webkit-scrollbar-track {
            background: #1e293b;
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
        }
        
        /* Breathing Circle */
        .breathing-circle {
            animation: breathe 8s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        @keyframes breathe {
            0%, 100% { transform: scale(0.85); opacity: 0.7; }
            50% { transform: scale(1.15); opacity: 1; }
        }
        
        /* Color Bar */
        .color-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 16px;
            text-align: center;
            font-weight: 600;
            z-index: 100;
            transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 -10px 30px rgba(0, 0, 0, 0.3);
        }
        
        /* Tab System */
        .tab-button {
            position: relative;
            padding: 12px 24px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .tab-button::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }
        
        .tab-button.active::after {
            transform: scaleX(1);
        }
        
        /* Tool Cards */
        .tool-card {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 32px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .tool-card:hover {
            transform: translateY(-8px) scale(1.02);
            border-color: rgba(102, 126, 234, 0.5);
            box-shadow: 0 20px 60px rgba(102, 126, 234, 0.3);
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .gauge-container {
                width: 150px;
                height: 150px;
            }
            
            .btn-primary {
                padding: 12px 24px;
                font-size: 14px;
            }
        }
        
        /* Advanced Animations */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .fade-in-up {
            animation: fadeInUp 0.6s ease-out;
        }
        
        /* Glow Effects */
        .glow-effect {
            position: relative;
        }
        
        .glow-effect::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(135deg, #667eea, #764ba2, #f093fb);
            border-radius: inherit;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: -1;
            filter: blur(10px);
        }
        
        .glow-effect:hover::before {
            opacity: 0.7;
        }
    </style>
</head>
<body>
    <!-- Neural Network Background -->
    <canvas class="neural-bg" id="neuralBg"></canvas>

    <!-- Header -->
    <header class="sticky top-0 z-50 glass-card border-b border-slate-700/50">
        <div class="container mx-auto px-6 py-4">
            <div class="flex justify-between items-center">
                <h1 class="text-2xl font-bold gradient-text">‚ú® Analyseur Spirituel Halal IA</h1>
                <nav class="hidden md:flex space-x-8 text-sm font-medium">
                    <a href="#analyzer" class="text-slate-300 hover:text-white transition-colors">Analyseur</a>
                    <a href="#tools" class="text-slate-300 hover:text-white transition-colors">Outils</a>
                    <a href="#how-it-works" class="text-slate-300 hover:text-white transition-colors">Principe</a>
                    <a href="#disclaimer" class="text-slate-300 hover:text-white transition-colors">Avertissement</a>
                </nav>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-6 py-12 relative z-10">
        
        <!-- Hero Section -->
        <section id="hero" class="text-center my-20 fade-in-up">
            <h2 class="text-5xl md:text-7xl font-extrabold text-white mb-6 leading-tight">
                Explorez Votre<br><span class="gradient-text">Lumi√®re Int√©rieure</span>
            </h2>
            <p class="max-w-3xl mx-auto text-xl text-slate-300 mb-12 leading-relaxed">
                Technologie IA avanc√©e 2025 pour analyser votre √©tat spirituel avec pr√©cision et conformit√© islamique
            </p>
            <a href="#analyzer" class="btn-primary inline-block text-lg">
                üöÄ D√©marrer l'Analyse IA
            </a>
        </section>

        <!-- Analyzer Section -->
        <section id="analyzer" class="mb-32">
            <div class="glass-card rounded-3xl p-8 md:p-12">
                <div class="grid grid-cols-1 lg:grid-cols-5 gap-12">
                    
                    <!-- Analysis Interface -->
                    <div class="lg:col-span-3">
                        <!-- Tabs -->
                        <div class="flex border-b border-slate-700 mb-6">
                            <button id="liveTabButton" class="tab-button active text-white">
                                üìπ Analyse en Direct
                            </button>
                            <button id="photoTabButton" class="tab-button text-slate-400">
                                üì∏ Analyse Photo
                            </button>
                        </div>

                        <!-- Live Analysis -->
                        <div id="liveTabContent">
                            <div id="video-container" class="video-container-advanced relative aspect-video bg-slate-900 flex items-center justify-center">
                                <video id="video" class="video-feed" playsinline autoplay muted></video>
                                <canvas id="canvas" class="aura-canvas"></canvas>
                                <div id="chakra-dots-container" class="absolute inset-0 z-20 pointer-events-none"></div>
                                
                                <div id="loading-spinner" class="absolute z-10 hidden">
                                    <div class="spinner"></div>
                                </div>
                                
                                <div id="start-message" class="absolute z-30 text-center p-8">
                                    <div class="mb-6">
                                        <svg class="w-20 h-20 mx-auto text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                        </svg>
                                    </div>
                                    <p class="text-slate-300 mb-6 text-lg">Activez votre cam√©ra pour commencer l'analyse IA</p>
                                    <button id="startButton" class="btn-primary">
                                        üé• Activer la Cam√©ra
                                    </button>
                                </div>
                            </div>
                            
                            <div class="mt-6 flex justify-center items-center gap-4">
                                <button id="stopButton" class="hidden bg-red-600 hover:bg-red-500 text-white font-bold py-3 px-8 rounded-xl transition-all">
                                    ‚èπÔ∏è Arr√™ter
                                </button>
                                <button id="fullscreenButton" class="hidden text-slate-400 hover:text-white p-3 rounded-xl hover:bg-slate-800 transition-all" title="Plein √©cran">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>

                        <!-- Photo Analysis -->
                        <div id="photoTabContent" class="hidden">
                            <div id="photo-container" class="video-container-advanced relative aspect-video bg-slate-900 flex items-center justify-center">
                                <img id="photo-preview" class="hidden absolute top-0 left-0 w-full h-full object-contain" />
                                <canvas id="photo-canvas" class="aura-canvas"></canvas>
                                <div id="photo-chakra-dots-container" class="absolute inset-0 z-20 pointer-events-none"></div>
                                
                                <button id="clearPhotoButton" class="hidden absolute top-4 right-4 z-30 bg-red-600 hover:bg-red-500 p-3 rounded-full text-white transition-all" title="Effacer">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                                
                                <div id="photo-start-message" class="absolute z-20 text-center p-8">
                                    <div class="mb-6">
                                        <svg class="w-20 h-20 mx-auto text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                        </svg>
                                    </div>
                                    <p class="text-slate-300 mb-6 text-lg">Chargez une photo pour l'analyse IA</p>
                                    <input type="file" id="photoInput" class="hidden" accept="image/*">
                                    <label for="photoInput" class="btn-primary inline-block cursor-pointer">
                                        üì§ Charger une Photo
                                    </label>
                                </div>
                                
                                <div id="photo-loading-spinner" class="absolute z-10 hidden">
                                    <div class="spinner"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Results Panel -->
                    <div class="lg:col-span-2 flex flex-col">
                        <h3 id="analysis-title" class="text-3xl font-bold text-white mb-6"></h3>
                        
                        <div id="results-placeholder" class="text-center text-slate-500 py-20 flex-grow flex flex-col items-center justify-center">
                            <svg class="w-24 h-24 mb-4 text-slate-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                            </svg>
                            <p class="text-lg">Les r√©sultats appara√Ætront ici</p>
                        </div>
                        
                        <div id="results" class="hidden space-y-6 overflow-y-auto" style="max-height: 75vh;">
                            
                            <!-- Dominant Aura -->
                            <div class="glass-card rounded-2xl p-6">
                                <h4 class="text-sm font-semibold text-slate-400 mb-4 uppercase tracking-wider">Lumi√®re Dominante</h4>
                                <div class="flex items-center space-x-4">
                                    <div id="dominant-color-preview" class="w-16 h-16 rounded-2xl border-2 border-slate-600 shadow-lg"></div>
                                    <div>
                                        <p id="dominant-color-name" class="text-2xl font-bold text-white">En attente...</p>
                                        <p id="dominant-color-wavelength" class="text-sm text-indigo-400 font-mono mt-1">~ ... nm</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Daily Message -->
                            <div class="glass-card rounded-2xl p-6">
                                <h4 class="text-sm font-semibold text-slate-400 mb-3 uppercase tracking-wider">üìø Rappel du Jour</h4>
                                <p id="daily-message" class="text-sm text-slate-300 italic leading-relaxed"></p>
                            </div>

                            <!-- Subtle Bodies Toggle -->
                            <div class="glass-card rounded-2xl p-5">
                                <label for="showSubtleBodies" class="flex items-center justify-between cursor-pointer">
                                    <span class="text-sm font-semibold text-slate-300">üåü Voir les 7 Lataif</span>
                                    <div class="relative">
                                        <input type="checkbox" id="showSubtleBodies" class="sr-only peer">
                                        <div class="w-14 h-7 bg-slate-700 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[4px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-gradient-to-r peer-checked:from-indigo-600 peer-checked:to-purple-600"></div>
                                    </div>
                                </label>
                            </div>
                            
                            <!-- Accordions -->
                            <div class="space-y-3">
                                
                                <!-- Interpretation -->
                                <div class="accordion-item glass-card rounded-2xl overflow-hidden">
                                    <button class="accordion-header w-full flex justify-between items-center p-6 text-left">
                                        <h4 class="text-sm font-semibold text-slate-300 uppercase tracking-wider">üí´ Interpr√©tation Spirituelle</h4>
                                        <svg class="w-5 h-5 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                        </svg>
                                    </button>
                                    <div class="accordion-content px-6 pb-6">
                                        <div id="interpretation-text" class="text-slate-300 text-sm leading-relaxed"></div>
                                    </div>
                                </div>

                                <!-- Subtle Bodies -->
                                <div class="accordion-item glass-card rounded-2xl overflow-hidden">
                                    <button class="accordion-header w-full flex justify-between items-center p-6 text-left">
                                        <h4 class="text-sm font-semibold text-slate-300 uppercase tracking-wider">üåà Analyse des Lataif</h4>
                                        <svg class="w-5 h-5 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                        </svg>
                                    </button>
                                    <div class="accordion-content px-6 pb-6">
                                        <div id="subtle-bodies-content" class="space-y-4 text-sm"></div>
                                    </div>
                                </div>

                                <!-- Chakras -->
                                <div class="accordion-item glass-card rounded-2xl overflow-hidden">
                                    <button class="accordion-header w-full flex justify-between items-center p-6 text-left">
                                        <h4 class="text-sm font-semibold text-slate-300 uppercase tracking-wider">‚ö° Centres Spirituels</h4>
                                        <svg class="w-5 h-5 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                        </svg>
                                    </button>
                                    <div class="accordion-content px-6 pb-6">
                                        <div id="chakra-analysis-content" class="space-y-3"></div>
                                    </div>
                                </div>

                                <!-- Vibrational Rate -->
                                <div class="accordion-item glass-card rounded-2xl overflow-hidden">
                                    <button class="accordion-header w-full flex justify-between items-center p-6 text-left">
                                        <h4 class="text-sm font-semibold text-slate-300 uppercase tracking-wider">üïäÔ∏è Niveau Sak√Ænah</h4>
                                        <svg class="w-5 h-5 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                        </svg>
                                    </button>
                                    <div class="accordion-content px-6 pb-6">
                                        <div class="flex flex-col items-center gap-6">
                                            <div class="gauge-container">
                                                <svg class="w-full h-full -rotate-90" viewBox="0 0 36 36">
                                                    <defs>
                                                        <linearGradient id="gaugeGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                                            <stop offset="0%" style="stop-color:#667eea;stop-opacity:1" />
                                                            <stop offset="100%" style="stop-color:#764ba2;stop-opacity:1" />
                                                        </linearGradient>
                                                    </defs>
                                                    <path class="gauge-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke-width="3"></path>
                                                    <path id="vibrational-gauge-bar" class="gauge-fill" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke-width="3" stroke-dasharray="0, 100"></path>
                                                </svg>
                                                <div class="absolute inset-0 flex flex-col items-center justify-center">
                                                    <span id="vibrational-rate-value" class="text-3xl font-bold text-white">...</span>
                                                    <span class="text-xs text-slate-400 mt-1">Niveau</span>
                                                </div>
                                            </div>
                                            <div class="text-center">
                                                <p id="vibrational-level-text" class="font-bold text-xl text-white mb-2">En attente...</p>
                                                <p id="vibrational-commentary" class="text-slate-300 text-sm"></p>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Clarity -->
                                <div class="accordion-item glass-card rounded-2xl overflow-hidden">
                                    <button class="accordion-header w-full flex justify-between items-center p-6 text-left">
                                        <h4 class="text-sm font-semibold text-slate-300 uppercase tracking-wider">üß† Clart√© de l'Esprit</h4>
                                        <svg class="w-5 h-5 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                        </svg>
                                    </button>
                                    <div class="accordion-content px-6 pb-6">
                                        <p id="aura-shape-texture" class="text-sm text-slate-300 leading-relaxed"></p>
                                    </div>
                                </div>

                                <!-- Balance -->
                                <div class="accordion-item glass-card rounded-2xl overflow-hidden">
                                    <button class="accordion-header w-full flex justify-between items-center p-6 text-left">
                                        <h4 class="text-sm font-semibold text-slate-300 uppercase tracking-wider">‚öñÔ∏è √âquilibre Jalal/Jamal</h4>
                                        <svg class="w-5 h-5 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                        </svg>
                                    </button>
                                    <div class="accordion-content px-6 pb-6">
                                        <div class="w-full bg-slate-700 rounded-full h-3 overflow-hidden">
                                            <div id="yin-yang-bar" class="h-full rounded-full transition-all duration-1000" style="width: 50%; background: linear-gradient(90deg, #667eea, #764ba2)"></div>
                                        </div>
                                        <div class="flex justify-between text-xs mt-3 text-slate-400">
                                            <span>Jamal (Gr√¢ce)</span>
                                            <span id="yin-yang-text" class="font-semibold text-white">√âquilibr√©</span>
                                            <span>Jalal (Rigueur)</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Recording Controls -->
                            <div class="glass-card rounded-2xl p-6">
                                <h4 class="text-sm font-semibold text-slate-400 mb-4 uppercase tracking-wider">üé¨ Session d'Analyse</h4>
                                <div class="flex items-center justify-between gap-4 mb-4">
                                    <button id="recordButton" class="flex-1 bg-gradient-to-r from-sky-600 to-blue-600 hover:from-sky-500 hover:to-blue-500 text-white font-bold py-3 px-6 rounded-xl transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2" disabled>
                                        <span id="recordButtonText">‚è∫Ô∏è D√©marrer</span>
                                    </button>
                                    <p id="recordTimer" class="font-mono text-2xl text-white font-bold">00:00</p>
                                </div>
                                <div class="flex gap-3">
                                    <button id="exportButton" class="flex-1 bg-slate-700 hover:bg-slate-600 text-white text-sm font-bold py-2 px-4 rounded-xl transition-all disabled:opacity-50" disabled>
                                        üíæ Exporter
                                    </button>
                                    <button id="historyButton" class="flex-1 bg-slate-700 hover:bg-slate-600 text-white text-sm font-bold py-2 px-4 rounded-xl transition-all">
                                        üìö Historique
                                    </button>
                                </div>
                                <p id="recordStatus" class="text-xs text-slate-500 mt-3 text-center">Activez la cam√©ra pour enregistrer</p>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Therapeutic Tools -->
        <section id="tools" class="mb-32">
            <div class="text-center mb-16">
                <h2 class="text-4xl md:text-5xl font-bold text-white mb-4">Outils de Bien-√™tre Spirituel</h2>
                <p class="max-w-3xl mx-auto text-lg text-slate-300">
                    Outils conformes aux principes islamiques pour harmoniser votre √©tat spirituel
                </p>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                
                <!-- Breathing -->
                <div class="tool-card glow-effect">
                    <h3 class="font-bold text-xl text-indigo-400 mb-4">üå¨Ô∏è Respiration Consciente</h3>
                    <div class="relative w-40 h-40 mx-auto mb-6 flex items-center justify-center">
                        <div class="absolute inset-0 bg-gradient-to-br from-indigo-500/30 to-purple-500/30 rounded-full breathing-circle"></div>
                        <p id="breathing-text" class="z-10 text-white font-semibold text-center px-4">Pr√™t ?</p>
                    </div>
                    <button id="startBreathingButton" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-500 hover:to-purple-500 text-white font-bold py-3 px-6 rounded-xl transition-all">
                        Commencer
                    </button>
                </div>

                <!-- Sound Therapy -->
                <div class="tool-card glow-effect">
                    <h3 class="font-bold text-xl text-indigo-400 mb-4">üéµ Lecture Apaisante</h3>
                    <p class="text-sm text-slate-300 mb-6">Ambiance sonore relaxante inspir√©e de la r√©citation coranique</p>
                    <div id="sound-therapy-ui" class="opacity-50 transition-opacity">
                        <p id="sound-freq-label" class="text-lg font-semibold text-white mb-4">Sourate Recommand√©e ...</p>
                        <button id="playSoundButton" class="w-full bg-gradient-to-r from-green-600 to-teal-600 hover:from-green-500 hover:to-teal-500 text-white font-bold py-3 px-6 rounded-xl transition-all disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            ‚ñ∂Ô∏è Lancer
                        </button>
                    </div>
                </div>

                <!-- Meditation -->
                <div class="tool-card glow-effect">
                    <h3 class="font-bold text-xl text-indigo-400 mb-4">üßò Tafakkur (M√©ditation)</h3>
                    <p class="text-sm text-slate-300 mb-6">M√©ditation guid√©e sur les signes d'Allah dans la cr√©ation</p>
                    <div id="meditation-ui" class="opacity-50 transition-opacity">
                        <p id="meditation-title" class="text-lg font-semibold text-white mb-4">...</p>
                        <button id="playMeditationButton" class="w-full bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-500 hover:to-pink-500 text-white font-bold py-3 px-6 rounded-xl transition-all disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            ‚ñ∂Ô∏è Lancer
                        </button>
                    </div>
                </div>

                <!-- Affirmations -->
                <div class="tool-card glow-effect">
                    <h3 class="font-bold text-xl text-indigo-400 mb-4">ü§≤ Du'as Personnalis√©es</h3>
                    <div id="affirmations-ui" class="h-full flex flex-col justify-center">
                        <p id="affirmation-text" class="text-lg italic text-slate-300 mb-6 text-center">"..."</p>
                        <button id="newAffirmationButton" class="text-sm text-indigo-400 hover:text-indigo-300 disabled:opacity-50 transition-colors" disabled>
                            üîÑ Nouvelle invocation
                        </button>
                    </div>
                </div>

                <!-- Remedies -->
                <div class="tool-card glow-effect">
                    <h3 class="font-bold text-xl text-indigo-400 mb-4">üåø Rem√®des Proph√©tiques</h3>
                    <div id="remedies-ui" class="h-full flex flex-col justify-center text-center">
                        <p id="remedy-name" class="font-bold text-white text-xl mb-2">...</p>
                        <p id="remedy-description" class="text-sm text-slate-400">...</p>
                    </div>
                </div>

                <!-- Scents -->
                <div class="tool-card glow-effect">
                    <h3 class="font-bold text-xl text-indigo-400 mb-4">üå∏ Senteurs Sunnah</h3>
                    <div id="aroma-ui" class="h-full flex flex-col justify-center text-center">
                        <p id="aroma-name" class="font-bold text-white text-xl mb-2">...</p>
                        <p id="aroma-description" class="text-sm text-slate-400">...</p>
                    </div>
                </div>

            </div>
        </section>

        <!-- Color Meanings -->
        <section id="color-meanings" class="mb-32">
            <div class="text-center mb-16">
                <h2 class="text-4xl md:text-5xl font-bold text-white mb-4">Symbolique des Couleurs</h2>
                <p class="max-w-3xl mx-auto text-lg text-slate-300">
                    D√©couvrez la signification spirituelle de chaque couleur
                </p>
            </div>
            <div id="color-meanings-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <!-- Populated by JS -->
            </div>
        </section>

        <!-- How It Works -->
        <section id="how-it-works" class="mb-32">
            <div class="text-center mb-16">
                <h2 class="text-4xl md:text-5xl font-bold text-white mb-4">Principe de Fonctionnement</h2>
                <p class="max-w-3xl mx-auto text-lg text-slate-300">
                    Technologie IA avanc√©e combinant vision par ordinateur et analyse spirituelle
                </p>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <div class="tool-card text-center glass-card-hover">
                    <div class="w-20 h-20 mx-auto mb-6 bg-gradient-to-br from-indigo-500 to-purple-500 rounded-2xl flex items-center justify-center text-4xl">
                        üéØ
                    </div>
                    <h3 class="font-bold text-xl text-indigo-400 mb-3">1. Capture & Analyse IA</h3>
                    <p class="text-sm text-slate-300 leading-relaxed">
                        Algorithmes de deep learning analysent les micro-variations de chrominance et luminance avec pr√©cision
                    </p>
                </div>
                
                <div class="tool-card text-center glass-card-hover">
                    <div class="w-20 h-20 mx-auto mb-6 bg-gradient-to-br from-purple-500 to-pink-500 rounded-2xl flex items-center justify-center text-4xl">
                        üß†
                    </div>
                    <h3 class="font-bold text-xl text-indigo-400 mb-3">2. Interpr√©tation Symbolique</h3>
                    <p class="text-sm text-slate-300 leading-relaxed">
                        Corr√©lation des donn√©es visuelles avec mod√®les spirituels islamiques pour recommandations personnalis√©es
                    </p>
                </div>
                
                <div class="tool-card text-center glass-card-hover">
                    <div class="w-20 h-20 mx-auto mb-6 bg-gradient-to-br from-pink-500 to-red-500 rounded-2xl flex items-center justify-center text-4xl">
                        ‚ú®
                    </div>
                    <h3 class="font-bold text-xl text-indigo-400 mb-3">3. Harmonisation Interactive</h3>
                    <p class="text-sm text-slate-300 leading-relaxed">
                        Outils bas√©s sur la tradition islamique pour trouver la paix int√©rieure et la s√©r√©nit√©
                    </p>
                </div>
            </div>
        </section>

        <!-- Disclaimer -->
        <section id="disclaimer" class="glass-card rounded-3xl p-10 border-2 border-amber-600/30">
            <div class="text-center">
                <div class="w-16 h-16 mx-auto mb-6 bg-amber-600/20 rounded-2xl flex items-center justify-center text-3xl">
                    ‚ö†Ô∏è
                </div>
                <h2 class="text-3xl font-bold text-amber-300 mb-6">Avertissement Important</h2>
                <p class="max-w-4xl mx-auto text-amber-200/90 leading-relaxed text-lg">
                    Cet outil est un projet technologique exp√©rimental √† des fins d'exploration spirituelle personnelle et de divertissement. Il ne doit pas √™tre utilis√© pour un diagnostic m√©dical ou psychologique. Les r√©sultats sont des interpr√©tations algorithmiques symboliques et ne remplacent en aucun cas l'avis d'un professionnel qualifi√© ou d'un savant religieux. Cet outil ne constitue pas une source de fatwa ou de jugement religieux. L'utilisation des outils propos√©s doit se faire dans le respect des pr√©ceptes de l'Islam.
                </p>
            </div>
        </section>

    </main>

    <!-- Modals -->
    <!-- Report Modal -->
    <div id="report-modal" class="fixed inset-0 z-[100] flex items-center justify-center p-4 hidden modal-backdrop">
        <div class="glass-card rounded-3xl shadow-2xl w-full max-w-3xl max-h-[90vh] flex flex-col border border-slate-700">
            <header class="p-6 border-b border-slate-700 flex justify-between items-center">
                <h2 class="text-2xl font-bold text-white">üìä Rapport de Session</h2>
                <button class="close-modal-button text-slate-400 hover:text-white text-3xl leading-none transition-colors">&times;</button>
            </header>
            <div id="report-content" class="p-8 overflow-y-auto space-y-6"></div>
            <footer class="p-6 border-t border-slate-700 text-center">
                <button class="close-modal-button btn-primary">Fermer</button>
            </footer>
        </div>
    </div>

    <!-- History Modal -->
    <div id="history-modal" class="fixed inset-0 z-[100] flex items-center justify-center p-4 hidden modal-backdrop">
        <div class="glass-card rounded-3xl shadow-2xl w-full max-w-5xl max-h-[90vh] flex flex-col border border-slate-700">
            <header class="p-6 border-b border-slate-700 flex justify-between items-center">
                <h2 class="text-2xl font-bold text-white">üìö Historique des Sessions</h2>
                <button class="close-modal-button text-slate-400 hover:text-white text-3xl leading-none transition-colors">&times;</button>
            </header>
            <div id="history-content" class="p-8 overflow-y-auto"></div>
            <footer class="p-6 border-t border-slate-700 text-center">
                <button id="clear-history-button" class="bg-red-600 hover:bg-red-500 text-white font-bold py-3 px-8 rounded-xl transition-all">
                    üóëÔ∏è Vider l'historique
                </button>
            </footer>
        </div>
    </div>

    <!-- Meditation Modal -->
    <div id="meditation-modal" class="fixed inset-0 z-[100] flex items-center justify-center p-4 hidden modal-backdrop">
        <div class="glass-card rounded-3xl shadow-2xl w-full max-w-3xl max-h-[90vh] flex flex-col border border-slate-700">
            <header class="p-6 border-b border-slate-700 flex justify-between items-center">
                <h2 id="meditation-modal-title" class="text-2xl font-bold text-white">üßò M√©ditation Guid√©e</h2>
                <button class="close-modal-button text-slate-400 hover:text-white text-3xl leading-none transition-colors">&times;</button>
            </header>
            <div class="p-8 overflow-y-auto">
                <p id="meditation-modal-text" class="text-slate-300 leading-relaxed text-lg"></p>
            </div>
            <footer class="p-6 border-t border-slate-700 text-center">
                <button class="close-modal-button btn-primary">Fermer</button>
            </footer>
        </div>
    </div>

    <!-- Color Bar -->
    <div id="aura-color-bar" class="color-bar translate-y-full">
        Couleur Dominante : <span id="aura-bar-color-name">...</span>
    </div>

    <!-- Footer -->
    <footer class="text-center py-12 border-t border-slate-800 mt-24 relative z-10">
        <p class="text-sm text-slate-500">¬© 2025 Analyseur Spirituel Halal IA - Technologie Avanc√©e</p>
    </footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script>
        // ============================================
        // ADVANCED SPIRITUAL ANALYZER 2025
        // Professional-grade implementation
        // ============================================

        // DOM Elements
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d', { willReadFrequently: true, alpha: true });
        const startButton = document.getElementById('startButton');
        const stopButton = document.getElementById('stopButton');
        const fullscreenButton = document.getElementById('fullscreenButton');
        const startMessage = document.getElementById('start-message');
        const loadingSpinner = document.getElementById('loading-spinner');
        const resultsContainer = document.getElementById('results');
        const resultsPlaceholder = document.getElementById('results-placeholder');
        const videoContainer = document.getElementById('video-container');
        const analysisTitle = document.getElementById('analysis-title');

        // Tabs
        const liveTabButton = document.getElementById('liveTabButton');
        const photoTabButton = document.getElementById('photoTabButton');
        const liveTabContent = document.getElementById('liveTabContent');
        const photoTabContent = document.getElementById('photoTabContent');
        
        // Photo
        const photoContainer = document.getElementById('photo-container');
        const photoInput = document.getElementById('photoInput');
        const photoPreview = document.getElementById('photo-preview');
        const photoStartMessage = document.getElementById('photo-start-message');
        const photoLoadingSpinner = document.getElementById('photo-loading-spinner');
        const photoCanvas = document.getElementById('photo-canvas');
        const photoCtx = photoCanvas.getContext('2d', { willReadFrequently: true, alpha: true });
        const clearPhotoButton = document.getElementById('clearPhotoButton');

        // Results
        const dominantColorPreview = document.getElementById('dominant-color-preview');
        const dominantColorName = document.getElementById('dominant-color-name');
        const dominantColorWavelength = document.getElementById('dominant-color-wavelength');
        const interpretationText = document.getElementById('interpretation-text');
        const vibrationalGaugeBar = document.getElementById('vibrational-gauge-bar');
        const vibrationalRateValue = document.getElementById('vibrational-rate-value');
        const vibrationalLevelText = document.getElementById('vibrational-level-text');
        const vibrationalCommentary = document.getElementById('vibrational-commentary');
        const dailyMessage = document.getElementById('daily-message');
        const auraShapeTexture = document.getElementById('aura-shape-texture');
        const yinYangBar = document.getElementById('yin-yang-bar');
        const yinYangText = document.getElementById('yin-yang-text');
        const showSubtleBodies = document.getElementById('showSubtleBodies');
        const subtleBodiesContent = document.getElementById('subtle-bodies-content');
        const auraColorBar = document.getElementById('aura-color-bar');
        const auraBarColorName = document.getElementById('aura-bar-color-name');

        // Chakras
        const chakraDotsContainer = document.getElementById('chakra-dots-container');
        const photoChakraDotsContainer = document.getElementById('photo-chakra-dots-container');
        const chakraAnalysisContent = document.getElementById('chakra-analysis-content');

        // Recording
        const recordButton = document.getElementById('recordButton');
        const recordButtonText = document.getElementById('recordButtonText');
        const recordTimer = document.getElementById('recordTimer');
        const recordStatus = document.getElementById('recordStatus');
        const exportButton = document.getElementById('exportButton');
        const historyButton = document.getElementById('historyButton');
        
        // Modals
        const reportModal = document.getElementById('report-modal');
        const reportContent = document.getElementById('report-content');
        const historyModal = document.getElementById('history-modal');
        const historyContent = document.getElementById('history-content');
        const clearHistoryButton = document.getElementById('clear-history-button');
        const meditationModal = document.getElementById('meditation-modal');
        const meditationModalTitle = document.getElementById('meditation-modal-title');
        const meditationModalText = document.getElementById('meditation-modal-text');

        // Tools
        const breathingText = document.getElementById('breathing-text');
        const startBreathingButton = document.getElementById('startBreathingButton');
        const soundTherapyUI = document.getElementById('sound-therapy-ui');
        const soundFreqLabel = document.getElementById('sound-freq-label');
        const playSoundButton = document.getElementById('playSoundButton');
        const meditationUI = document.getElementById('meditation-ui');
        const meditationTitle = document.getElementById('meditation-title');
        const playMeditationButton = document.getElementById('playMeditationButton');
        const affirmationText = document.getElementById('affirmation-text');
        const newAffirmationButton = document.getElementById('newAffirmationButton');
        const remedyName = document.getElementById('remedy-name');
        const remedyDescription = document.getElementById('remedy-description');
        const aromaName = document.getElementById('aroma-name');
        const aromaDescription = document.getElementById('aroma-description');
        const colorMeaningsGrid = document.getElementById('color-meanings-grid');

        // State
        let animationFrameId;
        let photoAnimationFrameId;
        let isRecording = false;
        let recordingStartTime = null;
        let recordIntervalId = null;
        let recordedData = [];
        let particles = [];
        const MAX_PARTICLES = 200;
        let time = 0;
        let breathingInterval;
        let audioContext;
        let recitationAudio, rainNoise, thunderTimeout, ambianceLfo;
        let currentAnalysisData = {};
        let faceDetectionModel = null;

        // Audio Data
        const QURAN_AUDIO_B64 = 'data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA';

        // Spiritual Data
        const AURA_DATA = {
            'Rouge': { wavelength: '625-740', interpretation: "Force vitale, courage, patience, connexion √† la terre. Un rouge √©quilibr√© indique une bonne constitution et une volont√© saine au service du bien. En exc√®s, il peut mener √† la col√®re ou au stress, n√©cessitant un rappel √† la patience (sabr).", sourate: "Al-Baqarah", meditation: "M√©ditation sur la Force d'Allah", affirmation: "√î Allah, accorde-moi la force et la patience dans mes √©preuves.", remede: {name: "Datte Ajwa", desc: "Source d'√©nergie et de protection"}, senteur: {name: "Ambre", desc: "Ancrant et fortifiant"}},
            'Orange': { wavelength: '590-625', interpretation: "Joie, relations sociales, cr√©ativit√©. Un orange lumineux est signe de bonne humeur et de sociabilit√© saine. P√¢le ou trouble, il peut indiquer un attachement excessif ou des blocages. Se rappeler de la mod√©ration.", sourate: "Ar-Rahman", meditation: "M√©ditation sur la Joie des Bienfaits", affirmation: "Alhamdulillah pour les liens et la joie que Tu m'accordes.", remede: {name: "Figue", desc: "Sucr√©e et nutritive"}, senteur: {name: "Orange", desc: "Apporte joie et positivit√©"}},
            'Jaune': { wavelength: '565-590', interpretation: "Intellect, clart√©, confiance. Un jaune solaire d√©note un esprit clair et une confiance plac√©e en Allah. Un jaune terne peut signaler un surmenage mental ou un besoin de contr√¥le. Il faut chercher la connaissance utile.", sourate: "Al-Imran", meditation: "M√©ditation sur la Lumi√®re de la Sagesse", affirmation: "√î Allah, augmente ma connaissance et ma confiance en Toi.", remede: {name: "Miel", desc: "Gu√©rison et clart√© pour l'esprit"}, senteur: {name: "Citron", desc: "Clarifiant et optimiste"}},
            'Vert': { wavelength: '520-565', interpretation: "√âquilibre, croissance, compassion, nature. Le vert est la couleur du c≈ìur apais√© (qalb salim). Il indique un √©tat d'√©quilibre et de mis√©ricorde envers la cr√©ation. Un vert olive peut indiquer de l'envie, √† purifier par l'invocation.", sourate: "Ya-Sin", meditation: "M√©ditation sur le C≈ìur Apais√©", affirmation: "√î Allah, purifie mon c≈ìur et remplis-le de compassion.", remede: {name: "Huile d'Olive", desc: "B√©nie et pleine de bienfaits"}, senteur: {name: "Menthe", desc: "Purifiant et rafra√Æchissant"}},
            'Bleu': { wavelength: '435-520', interpretation: "Communication, paix, v√©rit√©, s√©r√©nit√© (sak√Ænah). Un bleu clair et limpide est le signe d'une communication honn√™te et paisible. Un bleu fonc√© peut indiquer une introspection profonde ou de la m√©lancolie, cherchant le r√©confort dans le dhikr.", sourate: "Al-Mulk", meditation: "M√©ditation sur la Paix Int√©rieure", affirmation: "C'est par l'√©vocation d'Allah que les c≈ìurs se tranquillisent.", remede: {name: "Eau de Zamzam", desc: "Source de gu√©rison et de paix"}, senteur: {name: "Camomille", desc: "Calmant et apaisant"}},
            'Indigo': { wavelength: '400-435', interpretation: "Intuition, sagesse, perception (firasa). L'indigo est li√© √† la vision int√©rieure du croyant. Il indique une forte intuition et une bonne connexion √† sa sagesse int√©rieure. En exc√®s, il peut d√©connecter de la r√©alit√©, un ancrage est n√©cessaire.", sourate: "Al-Kahf", meditation: "M√©ditation sur la Vision Int√©rieure", affirmation: "√î Allah, guide-moi par Ta lumi√®re et montre-moi la v√©rit√©.", remede: {name: "Graine de Nigelle", desc: "Rem√®de pour tout sauf la mort"}, senteur: {name: "Encens (Oliban)", desc: "√âl√©vation spirituelle et m√©ditatif"}},
            'Violet': { wavelength: '380-400', interpretation: "Spiritualit√©, connexion au Divin. Le violet est li√© √† la soumission et √† la conscience de la Majest√© d'Allah. Il d√©note une conscience spirituelle √©lev√©e et un d√©sir de proximit√© avec le Cr√©ateur.", sourate: "Al-Waqi'a", meditation: "M√©ditation de Connexion Divine", affirmation: "Je suis √† Allah et c'est √† Lui que je retournerai.", remede: {name: "Grenade", desc: "Fruit du Paradis, purifiant"}, senteur: {name: "Lavande", desc: "√âquilibrant et purifiant"}},
            'Blanc': { wavelength: 'Spectre large', interpretation: "Puret√©, clart√©, protection spirituelle. Le blanc est la couleur de la puret√© (tahara) et de la lumi√®re divine (Nur). C'est une aura de haute fr√©quence, souvent un bouclier protecteur contre le mal.", sourate: "An-Nur", meditation: "M√©ditation de la Lumi√®re Pure", affirmation: "Allah est la Lumi√®re des cieux et de la terre.", remede: {name: "Lait", desc: "Symbole de puret√© et de nourriture saine"}, senteur: {name: "Musc Blanc (Misk)", desc: "Puret√© et √©l√©vation"}},
            'Rose': { wavelength: 'Combinaison', interpretation: "Amour inconditionnel, compassion (rahma), tendresse. Le rose indique un c≈ìur rempli d'amour pour Allah et Sa cr√©ation. C'est la couleur de l'affection et du pardon.", sourate: "Al-Fatiha", meditation: "M√©ditation sur la Mis√©ricorde", affirmation: "Au nom d'Allah, le Tout Mis√©ricordieux, le Tr√®s Mis√©ricordieux.", remede: {name: "P√©tale de Rose", desc: "Apaise le c≈ìur et l'esprit"}, senteur: {name: "Rose", desc: "Amour et compassion"}},
            'Turquoise': { wavelength: '490-520', interpretation: "Gu√©rison, communication de l'√¢me, protection. Le turquoise est une couleur de protection contre le mauvais ≈ìil et de gu√©rison √©motionnelle. Il favorise une expression sinc√®re venant du c≈ìur.", sourate: "Al-Falaq", meditation: "M√©ditation sur la Protection Divine", affirmation: "Je cherche protection aupr√®s du Seigneur de l'aube naissante.", remede: {name: "Miel et Citron", desc: "Purifiant et protecteur"}, senteur: {name: "Eucalyptus", desc: "Nettoyant et clarifiant"}},
            'Or': { wavelength: 'M√©tallique', interpretation: "Sagesse divine, illumination, connexion spirituelle √©lev√©e. L'or symbolise la lumi√®re de la foi (iman) et la certitude (yaqin). C'est une aura de grande sagesse et de guidance divine.", sourate: "Ayat al-Kursi", meditation: "M√©ditation sur le Tr√¥ne Divin", affirmation: "Il n'y a de divinit√© qu'Allah, le Vivant, Celui qui subsiste par Lui-m√™me.", remede: {name: "Safran", desc: "Pr√©cieux, apporte la joie"}, senteur: {name: "Oud", desc: "Royal, connexion spirituelle profonde"}},
            'Argent': { wavelength: 'M√©tallique', interpretation: "Intuition, puret√©, connexion aux cycles naturels. L'argent est li√© √† la lune, qui marque le temps dans le calendrier islamique. Il indique une intuition pure et une r√©ceptivit√© √† la guidance divine.", sourate: "Al-Qamar", meditation: "M√©ditation sur les Signes d'Allah", affirmation: "√î Allah, illumine mon chemin et purifie mon intention.", remede: {name: "Siwak", desc: "Purifiant pour le corps et l'esprit"}, senteur: {name: "Santal", desc: "Apaisant et unifiant"}},
            'Noir': { wavelength: 'Absorption', interpretation: "Protection, profondeur, phase de retrait spirituel. Le noir peut symboliser une protection divine imp√©n√©trable, comme la nuit qui couvre. C'est aussi un temps pour l'introspection profonde et le repentir.", sourate: "An-Nas", meditation: "M√©ditation sur le Repos en Allah", affirmation: "Je cherche protection aupr√®s du Seigneur des hommes.", remede: {name: "Charbon v√©g√©tal", desc: "D√©toxifiant et purifiant"}, senteur: {name: "Patchouli", desc: "Ancrage et introspection"}},
        };

        const TAFFAKUR_DATA = {
            'Rouge': { title: "M√©ditation sur la Cr√©ation et la Force", text: "Asseyez-vous confortablement et fermez les yeux. Respirez profond√©ment. Pensez √† la terre sous vos pieds, ferme et stable. Allah l'a cr√©√©e comme un fondement pour nous. M√©ditez sur la force des montagnes, ancr√©es et immuables, un signe de Sa puissance. Ressentez cette force en vous, une force donn√©e par le Cr√©ateur pour faire face aux d√©fis avec patience. (Coran 13:3)" },
            'Orange': { title: "M√©ditation sur les Bienfaits et la Joie", text: "Asseyez-vous confortablement et fermez les yeux. Pensez aux fruits que nous mangeons, leurs couleurs vives, leurs go√ªts sucr√©s. Chaque fruit est un bienfait et un signe d'Allah. M√©ditez sur la chaleur du soleil, source de vie. C'est un don d'Ar-Rahman. Laissez la gratitude et la joie remplir votre c≈ìur. (Coran 55:10-13)" },
            'Jaune': { title: "M√©ditation sur la Lumi√®re de la Sagesse", text: "Asseyez-vous confortablement et fermez les yeux. Pensez √† la lumi√®re du soleil qui dissipe les t√©n√®bres et r√©v√®le les choses clairement. De m√™me, la connaissance d'Allah illumine l'esprit et le c≈ìur. Cherchez la clart√© dans votre esprit, comme la clart√© du jour. (Coran 39:22)" },
            'Vert': { title: "M√©ditation sur le C≈ìur Apais√©", text: "Asseyez-vous confortablement et fermez les yeux. Visualisez un jardin verdoyant, plein de vie. C'est un symbole de paix et de croissance. Votre c≈ìur peut √™tre comme ce jardin. M√©ditez sur la mis√©ricorde d'Allah qui, comme la pluie, fait fleurir la foi dans le c≈ìur et apporte la paix. (Coran 48:4)" },
            'Bleu': { title: "M√©ditation sur la Paix Int√©rieure", text: "Asseyez-vous confortablement et fermez les yeux. Imaginez un ciel bleu et vaste, ou un oc√©an calme et profond. C'est un symbole de s√©r√©nit√©. Laissez cette tranquillit√© entrer en vous. C'est par l'√©vocation d'Allah (dhikr) que les c≈ìurs trouvent l'apaisement. (Coran 13:28)" },
            'Indigo': { title: "M√©ditation sur la Vision Int√©rieure", text: "Asseyez-vous confortablement et fermez les yeux. Pensez √† l'immensit√© du ciel nocturne √©toil√©. Chaque √©toile est un signe. Regardez au-del√† des apparences et demandez √† Allah de vous accorder la perspicacit√© (firasa) pour voir la v√©rit√© et la sagesse dans Sa cr√©ation. (Coran 51:20-21)" },
            'Violet': { title: "M√©ditation de Connexion Divine", text: "Asseyez-vous confortablement et fermez les yeux. Prenez conscience de votre existence ici et maintenant. Vous √™tes une cr√©ature d'Allah. M√©ditez sur le fait que vous appartenez √† Lui et que votre retour se fera vers Lui. Ressentez ce lien profond et la paix qui d√©coule de cette soumission. (Coran 2:156)" },
            'Blanc': { title: "M√©ditation de la Lumi√®re Pure", text: "Asseyez-vous confortablement et fermez les yeux. Imaginez une lumi√®re blanche pure et √©clatante qui vous entoure et remplit votre c≈ìur. C'est une m√©taphore de la Lumi√®re d'Allah (Nur) qui guide et prot√®ge. Laissez cette lumi√®re purifier vos pens√©es et vos intentions. (Coran 24:35)" },
            'Rose': { title: "M√©ditation sur la Mis√©ricorde", text: "Asseyez-vous confortablement et fermez les yeux. Pensez √† la mis√©ricorde (rahma) d'Allah, qui englobe toute chose. Pensez √† l'amour d'une m√®re pour son enfant. La mis√©ricorde d'Allah est infiniment plus grande. Laissez votre c≈ìur s'adoucir et s'ouvrir √† la compassion pour vous-m√™me et pour les autres. (Coran 7:156)" },
            'Turquoise': { title: "M√©ditation sur la Protection Divine", text: "Asseyez-vous confortablement et fermez les yeux. Pensez √† l'oc√©an, parfois agit√© en surface mais calme dans ses profondeurs. Cherchez ce calme en vous. R√©p√©tez les sourates protectrices et demandez √† Allah de vous prot√©ger de tout mal, visible et invisible, comme un bouclier imp√©n√©trable. (Coran 113:1-5)" },
            'Or': { title: "M√©ditation sur le Tr√¥ne Divin", text: "Asseyez-vous confortablement et fermez les yeux. R√©fl√©chissez √† la grandeur et √† la majest√© d'Allah. Le verset du Tr√¥ne (Ayat al-Kursi) d√©crit Sa puissance infinie. M√©ditez sur Sa connaissance qui embrasse tout. Ressentez un profond respect et une confiance totale en Sa sagesse. (Coran 2:255)" },
            'Argent': { title: "M√©ditation sur les Signes d'Allah", text: "Asseyez-vous confortablement et fermez les yeux. Pensez au cycle de la lune, qui appara√Æt comme un fin croissant puis grandit pour devenir pleine, avant de diminuer √† nouveau. C'est un signe pr√©cis et magnifique du pouvoir d'Allah, qui rythme le temps. Demandez √† Allah de vous aider √† voir Ses signes en toute chose. (Coran 36:39)" },
            'Noir': { title: "M√©ditation sur le Repos en Allah", text: "Asseyez-vous confortablement et fermez les yeux. Pensez √† la nuit, qui apporte le repos et le silence. C'est un moment d'intimit√© et de protection. C'est dans le calme de l'introspection que l'on peut se tourner vers Allah, reconna√Ætre ses faiblesses et trouver refuge en Lui seul. (Coran 78:10-11)" }
        };

        const CHAKRA_DATA = {
            'Base (Asas)': { color: 'Rouge', yPercent: 0.95 },
            'Sacr√© (Nafs)': { color: 'Orange', yPercent: 0.85 },
            'Solaire (Qalb)': { color: 'Jaune', yPercent: 0.70 },
            'C≈ìur (Sirr)': { color: 'Vert', yPercent: 0.55 },
            'Gorge (Ruh)': { color: 'Bleu', yPercent: 0.40 },
            '3√®me ≈íil (Khafi)': { color: 'Indigo', yPercent: 0.25 },
            'Couronne (Akhfa)': { color: 'Violet', yPercent: 0.10 }
        };

        const SUBTLE_BODIES_DATA = [
            { name: 'Corps Physique (Jism)', desc: 'Li√© √† la sant√© et aux actions dans ce monde.', radius: 0.42, opacity: 0.35, hueShift: 0, satFactor: 0.8, valFactor: 1.2 },
            { name: 'L\'√Çme (Nafs)', desc: 'Centre des d√©sirs et des √©motions, √† purifier.', radius: 0.48, opacity: 0.5, hueShift: 0.05, satFactor: 1, valFactor: 1 },
            { name: 'Le C≈ìur (Qalb)', desc: 'Centre de la foi et des pens√©es. Peut √™tre sain ou malade.', radius: 0.55, opacity: 0.3, hueShift: -0.05, satFactor: 1.2, valFactor: 0.9 },
            { name: 'Le Secret (Sirr)', desc: 'Lieu de la contemplation d\'Allah, pont vers le spirituel.', radius: 0.63, opacity: 0.2, hueShift: 0.08, satFactor: 0.7, valFactor: 1.3 },
            { name: 'L\'Esprit (Ruh)', desc: 'Le souffle divin, source de vie et de conscience.', radius: 0.70, opacity: 0.15, hueShift: 0.12, satFactor: 0.9, valFactor: 1.1 },
            { name: 'Le Cach√© (Khafi)', desc: 'Niveau de conscience spirituelle avanc√©e.', radius: 0.78, opacity: 0.1, hueShift: 0.15, satFactor: 0.6, valFactor: 1.5 },
            { name: 'Le Plus Cach√© (Akhfa)', desc: 'Point de l\'annihilation en Dieu, la conscience pure.', radius: 0.85, opacity: 0.08, hueShift: 0, satFactor: 0.3, valFactor: 1.8 }
        ];

        // ============================================
        // INITIALIZATION
        // ============================================
        async function initializeApp() {
            hideResults();
            setupAccordions();
            populateColorMeanings();
            initNeuralBackground();
            
            // Load TensorFlow model
            try {
                faceDetectionModel = await blazeface.load();
                console.log('‚úÖ Face detection model loaded');
            } catch (err) {
                console.warn('‚ö†Ô∏è Face detection unavailable:', err);
            }
            
            // Event Listeners
            startButton.addEventListener('click', startLiveAnalysis);
            stopButton.addEventListener('click', stopCamera);
            fullscreenButton.addEventListener('click', toggleFullScreen);
            photoInput.addEventListener('change', handlePhotoUpload);
            clearPhotoButton.addEventListener('click', clearPhoto);
            liveTabButton.addEventListener('click', () => switchTabs(true));
            photoTabButton.addEventListener('click', () => switchTabs(false));
            recordButton.addEventListener('click', toggleRecording);
            exportButton.addEventListener('click', exportReport);
            historyButton.addEventListener('click', showHistoryModal);
            clearHistoryButton.addEventListener('click', clearHistory);
            document.querySelectorAll('.close-modal-button').forEach(btn => btn.addEventListener('click', closeModal));
            startBreathingButton.addEventListener('click', toggleBreathingExercise);
            playSoundButton.addEventListener('click', toggleSoundTherapy);
            playMeditationButton.addEventListener('click', startTafakkurMeditation);
            newAffirmationButton.addEventListener('click', updateTherapeuticTools);
        }

        // ============================================
        // NEURAL NETWORK BACKGROUND
        // ============================================
        function initNeuralBackground() {
            const neuralCanvas = document.getElementById('neuralBg');
            const neuralCtx = neuralCanvas.getContext('2d');
            neuralCanvas.width = window.innerWidth;
            neuralCanvas.height = window.innerHeight;
            
            const nodes = [];
            const nodeCount = 50;
            
            for (let i = 0; i < nodeCount; i++) {
                nodes.push({
                    x: Math.random() * neuralCanvas.width,
                    y: Math.random() * neuralCanvas.height,
                    vx: (Math.random() - 0.5) * 0.5,
                    vy: (Math.random() - 0.5) * 0.5
                });
            }
            
            function animateNeural() {
                neuralCtx.fillStyle = 'rgba(15, 23, 42, 0.1)';
                neuralCtx.fillRect(0, 0, neuralCanvas.width, neuralCanvas.height);
                
                nodes.forEach((node, i) => {
                    node.x += node.vx;
                    node.y += node.vy;
                    
                    if (node.x < 0 || node.x > neuralCanvas.width) node.vx *= -1;
                    if (node.y < 0 || node.y > neuralCanvas.height) node.vy *= -1;
                    
                    neuralCtx.beginPath();
                    neuralCtx.arc(node.x, node.y, 2, 0, Math.PI * 2);
                    neuralCtx.fillStyle = 'rgba(102, 126, 234, 0.5)';
                    neuralCtx.fill();
                    
                    nodes.forEach((otherNode, j) => {
                        if (i !== j) {
                            const dist = Math.hypot(node.x - otherNode.x, node.y - otherNode.y);
                            if (dist < 150) {
                                neuralCtx.beginPath();
                                neuralCtx.moveTo(node.x, node.y);
                                neuralCtx.lineTo(otherNode.x, otherNode.y);
                                neuralCtx.strokeStyle = `rgba(102, 126, 234, ${0.2 * (1 - dist / 150)})`;
                                neuralCtx.stroke();
                            }
                        }
                    });
                });
                
                requestAnimationFrame(animateNeural);
            }
            
            animateNeural();
            
            window.addEventListener('resize', () => {
                neuralCanvas.width = window.innerWidth;
                neuralCanvas.height = window.innerHeight;
            });
        }

        // ============================================
        // UI MANAGEMENT
        // ============================================
        function showResults(title) {
            analysisTitle.textContent = title;
            resultsContainer.classList.remove('hidden');
            resultsPlaceholder.classList.add('hidden');
            exportButton.disabled = false;
            auraColorBar.classList.remove('translate-y-full');
        }

        function hideResults() {
            analysisTitle.textContent = '';
            resultsContainer.classList.add('hidden');
            resultsPlaceholder.classList.remove('hidden');
            exportButton.disabled = true;
            resetTherapeuticTools();
            auraColorBar.classList.add('translate-y-full');
            dominantColorPreview.style.backgroundColor = 'transparent';
            dominantColorName.textContent = 'En attente...';
            dominantColorWavelength.textContent = '~ ... nm';
            interpretationText.innerHTML = "D√©marrez l'analyse pour voir les r√©sultats.";
            vibrationalGaugeBar.style.strokeDasharray = '0, 100';
            vibrationalRateValue.textContent = '...';
            vibrationalLevelText.textContent = 'En attente...';
            chakraAnalysisContent.innerHTML = '';
            subtleBodiesContent.innerHTML = '';
        }
        
        function switchTabs(isLive) {
            liveTabContent.classList.toggle('hidden', !isLive);
            photoTabContent.classList.toggle('hidden', isLive);
            
            liveTabButton.classList.toggle('active', isLive);
            liveTabButton.classList.toggle('text-white', isLive);
            liveTabButton.classList.toggle('text-slate-400', !isLive);
            
            photoTabButton.classList.toggle('active', !isLive);
            photoTabButton.classList.toggle('text-white', !isLive);
            photoTabButton.classList.toggle('text-slate-400', isLive);

            if (isLive) {
                if (!video.srcObject) hideResults();
                stopPhotoAnalysis();
            } else {
                stopCamera();
                if (!photoPreview.src) hideResults();
            }
        }
        
        function setupAccordions() {
            document.querySelectorAll('.accordion-header').forEach(header => {
                header.addEventListener('click', () => {
                    const content = header.nextElementSibling;
                    const icon = header.querySelector('svg');
                    const allContents = document.querySelectorAll('.accordion-content');
                    const allIcons = document.querySelectorAll('.accordion-header svg');

                    allContents.forEach(c => { if(c !== content) c.style.maxHeight = null; });
                    allIcons.forEach(i => { if(i !== icon) i.classList.remove('rotate-180'); });
                    
                    if (content.style.maxHeight) {
                        content.style.maxHeight = null;
                        icon.classList.remove('rotate-180');
                    } else {
                        content.style.maxHeight = content.scrollHeight + "px";
                        icon.classList.add('rotate-180');
                    }
                });
            });
        }
        
        function populateColorMeanings() {
            const colorHexMap = {
                'Rouge': '#dc2626', 'Orange': '#f97316', 'Jaune': '#facc15',
                'Vert': '#22c55e', 'Bleu': '#3b82f6', 'Indigo': '#4f46e5',
                'Violet': '#8b5cf6', 'Rose': '#ec4899', 'Turquoise': '#14b8a6',
                'Blanc': '#f1f5f9', 'Noir': '#1e293b', 'Or': '#f59e0b',
                'Argent': '#9ca3af'
            };
            
            const lightColors = ['Jaune', 'Blanc', 'Argent', 'Or', 'Turquoise', 'Rose'];

            for (const color in AURA_DATA) {
                const data = AURA_DATA[color];
                const card = document.createElement('div');
                card.className = "rounded-2xl p-6 glass-card-hover cursor-pointer transition-all";
                card.style.backgroundColor = colorHexMap[color] || color.toLowerCase();
                
                const textColor = lightColors.includes(color) ? 'text-slate-900' : 'text-white';
                if (color === 'Noir') card.style.color = '#cbd5e1';

                card.innerHTML = `
                    <h3 class="font-bold text-xl ${textColor} mb-2">${color}</h3>
                    <p class="text-sm ${textColor} opacity-90">${data.interpretation.split('.')[0]}.</p>
                `;

                colorMeaningsGrid.appendChild(card);
            }
        }
        
        function toggleFullScreen() {
            if (!document.fullscreenElement) {
                videoContainer.requestFullscreen().catch(err => {
                    alert(`Erreur plein √©cran: ${err.message}`);
                });
            } else {
                document.exitFullscreen();
            }
        }

        // ============================================
        // LIVE ANALYSIS
        // ============================================
        async function startLiveAnalysis() {
            startMessage.classList.add('hidden');
            loadingSpinner.classList.remove('hidden');
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'user', width: { ideal: 1280 }, height: { ideal: 720 } },
                    audio: false 
                });
                
                video.srcObject = stream;
                video.onloadedmetadata = () => {
                    video.play();
                    loadingSpinner.classList.add('hidden');
                    stopButton.classList.remove('hidden');
                    fullscreenButton.classList.remove('hidden');
                    showResults('üé• Analyse en Direct');
                    recordButton.disabled = false;
                    recordStatus.textContent = "Pr√™t pour l'enregistrement";
                    
                    canvas.width = videoContainer.clientWidth;
                    canvas.height = videoContainer.clientHeight;
                    
                    animationFrameId = requestAnimationFrame(liveTick);
                };
            } catch (err) {
                console.error("Erreur cam√©ra:", err);
                startMessage.innerHTML = `<p class="text-red-400">‚ùå Impossible d'acc√©der √† la cam√©ra</p>`;
                loadingSpinner.classList.add('hidden');
                startMessage.classList.remove('hidden');
            }
        }

        function stopCamera() {
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
                video.srcObject = null;
            }
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
                animationFrameId = null;
            }
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            chakraDotsContainer.innerHTML = '';
            particles = [];
            startMessage.classList.remove('hidden');
            stopButton.classList.add('hidden');
            fullscreenButton.classList.add('hidden');
            hideResults();
            if(isRecording) toggleRecording();
            recordButton.disabled = true;
            recordStatus.textContent = "Activez la cam√©ra pour enregistrer";
            recordTimer.textContent = '00:00';
        }

        async function liveTick() {
            if (!video.srcObject) return;
            
            const { width, height } = canvas;
            ctx.save();
            ctx.clearRect(0, 0, width, height);
            ctx.translate(width, 0);
            ctx.scale(-1, 1);
            ctx.drawImage(video, 0, 0, width, height);
            ctx.restore();

            const imageData = ctx.getImageData(0, 0, width, height);
            await processFrame(imageData);
            
            const { avgR, avgG, avgB, vibrationalRate } = currentAnalysisData;
            
            if (showSubtleBodies.checked) {
                drawSubtleBodies(ctx, width, height, [avgR, avgG, avgB]);
            } else {
                drawAuraLayer(ctx, width, height, [avgR, avgG, avgB], 0.6, 0.6);
            }
            
            manageParticles(ctx, width, height, avgR, avgG, avgB, vibrationalRate);

            animationFrameId = requestAnimationFrame(liveTick);
        }

        // ============================================
        // PHOTO ANALYSIS
        // ============================================
        function handlePhotoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            photoStartMessage.classList.add('hidden');
            photoLoadingSpinner.classList.remove('hidden');
            photoPreview.classList.add('hidden');
            photoCtx.clearRect(0, 0, photoCanvas.width, photoCanvas.height);

            const reader = new FileReader();
            reader.onload = e => {
                const img = new Image();
                img.onload = () => {
                    photoLoadingSpinner.classList.add('hidden');
                    photoPreview.src = e.target.result;
                    photoPreview.classList.remove('hidden');
                    clearPhotoButton.classList.remove('hidden');
                    startPhotoAnalysis(img);
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
        
        async function startPhotoAnalysis(img) {
            showResults('üì∏ Analyse Photo');
            
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d', { willReadFrequently: true });
            tempCanvas.width = img.width;
            tempCanvas.height = img.height;
            tempCtx.drawImage(img, 0, 0);
            const imageData = tempCtx.getImageData(0, 0, img.width, img.height);
            await processFrame(imageData);
            
            photoCanvas.width = photoContainer.clientWidth;
            photoCanvas.height = photoContainer.clientHeight;

            if (photoAnimationFrameId) cancelAnimationFrame(photoAnimationFrameId);
            photoAnimationFrameId = requestAnimationFrame(photoTick);
        }

        function photoTick() {
            const { width, height } = photoCanvas;
            photoCtx.clearRect(0, 0, width, height);
            time += 0.02;
            const pulseOpacity = 0.6 + Math.sin(time) * 0.1;

            const { avgR, avgG, avgB, vibrationalRate } = currentAnalysisData;

            if (showSubtleBodies.checked) {
                drawSubtleBodies(photoCtx, width, height, [avgR, avgG, avgB]);
            } else {
                drawAuraLayer(photoCtx, width, height, [avgR, avgG, avgB], 0.7, pulseOpacity);
            }
            
            manageParticles(photoCtx, width, height, avgR, avgG, avgB, vibrationalRate * 0.5);

            photoAnimationFrameId = requestAnimationFrame(photoTick);
        }

        function stopPhotoAnalysis() {
            if (photoAnimationFrameId) {
                cancelAnimationFrame(photoAnimationFrameId);
                photoAnimationFrameId = null;
            }
            photoCtx.clearRect(0, 0, photoCanvas.width, photoCanvas.height);
            photoChakraDotsContainer.innerHTML = '';
            particles = [];
        }

        function clearPhoto() {
            stopPhotoAnalysis();
            photoPreview.classList.add('hidden');
            photoPreview.src = '';
            clearPhotoButton.classList.add('hidden');
            photoInput.value = null;
            photoStartMessage.classList.remove('hidden');
            hideResults();
        }

        // ============================================
        // CORE PROCESSING
        // ============================================
        async function processFrame(imageData) {
            const { avgR, avgG, avgB, count, stdDev } = calculateColorStats(imageData);
            if (count === 0) return;
            
            const vibrationalRate = calculateVibrationalRate(avgR, avgG, avgB, stdDev);
            const [h, s, v] = rgbToHsv(avgR, avgG, avgB);
            const colorName = getColorName(h, s, v);
            const chakras = analyzeChakras(imageData);
            const yinYang = calculateYinYang(avgR, avgG, avgB);
            
            currentAnalysisData = { avgR, avgG, avgB, h, s, v, vibrationalRate, colorName, chakras, yinYang, stdDev };

            if(isRecording) {
                const now = Date.now();
                if (!recordedData.length || now - recordedData[recordedData.length - 1].t > 1000) {
                    recordedData.push({ t: now, r: avgR, g: avgG, b: avgB, s, v, vRate: vibrationalRate, chakras });
                }
            }

            updateUI();
        }

        function calculateColorStats(imageData) {
            const { data, width, height } = imageData;
            let r = 0, g = 0, b = 0, count = 0;
            const radius = Math.min(width, height) * 0.3;
            const centerX = width / 2;
            const centerY = height / 2;
            const pixels = [];

            for (let y = 0; y < height; y += 3) {
                for (let x = 0; x < width; x += 3) {
                    const dist = Math.sqrt(Math.pow(x - centerX, 2) + Math.pow(y - centerY, 2));
                    if (dist > radius * 0.7 && dist < radius) {
                        const index = (y * width + x) * 4;
                        const pr = data[index];
                        const pg = data[index + 1];
                        const pb = data[index + 2];
                        r += pr; g += pg; b += pb;
                        pixels.push(pr, pg, pb);
                        count++;
                    }
                }
            }
            
            if (count > 0) {
                const avgR = r / count, avgG = g / count, avgB = b / count;
                let stdDev = 0;
                for(let i = 0; i < pixels.length; i += 3) {
                    stdDev += Math.pow(pixels[i] - avgR, 2);
                    stdDev += Math.pow(pixels[i+1] - avgG, 2);
                    stdDev += Math.pow(pixels[i+2] - avgB, 2);
                }
                stdDev = Math.sqrt(stdDev / pixels.length);
                return { avgR, avgG, avgB, count, stdDev };
            }
            return { avgR: 0, avgG: 0, avgB: 0, count: 0, stdDev: 0 };
        }

        function calculateVibrationalRate(r, g, b, stdDev) {
            const [h, s, v] = rgbToHsv(r, g, b);
            const maxRate = 20000;
            const coherenceFactor = Math.max(0.1, 1 - (stdDev / 100));
            let rate = maxRate * (v * 0.6 + s * 0.2 + coherenceFactor * 0.2);
            return Math.max(0, Math.floor(rate));
        }
        
        function calculateYinYang(r, g, b) {
            const jamal = b + g;
            const jalal = r + (r + g) / 2;
            const total = jamal + jalal;
            if (total === 0) return 0.5;
            return Math.max(0, Math.min(1, jalal / total));
        }
        
        function analyzeChakras(imageData) {
            const { data, width, height } = imageData;
            const results = {};

            for (const name in CHAKRA_DATA) {
                const chakra = CHAKRA_DATA[name];
                const y = Math.floor(height * chakra.yPercent);
                const x = Math.floor(width / 2);
                let r = 0, g = 0, b = 0, count = 0;
                
                for (let j = -3; j <= 3; j++) {
                    for (let i = -3; i <= 3; i++) {
                        const index = ((y + j) * width + (x + i)) * 4;
                        if(index >= 0 && index < data.length) {
                            r += data[index]; 
                            g += data[index + 1]; 
                            b += data[index + 2];
                            count++;
                        }
                    }
                }
                
                const avgR = r / count, avgG = g / count, avgB = b / count;
                const [h, s, v] = rgbToHsv(avgR, avgG, avgB);
                const activity = Math.round((s + v) / 2 * 100);
                results[name] = { r: avgR, g: avgG, b: avgB, activity };
            }
            return results;
        }

        function getColorName(h, s, v) { 
            if (s < 0.1 && v > 0.9) return 'Blanc'; 
            if (v < 0.15) return 'Noir';
            if ((h > 0.9 || h < 0.04) && s > 0.6) return 'Rouge';
            if (h < 0.11) return 'Orange';
            if (h < 0.18) return 'Jaune';
            if (h < 0.45) return 'Vert';
            if (h > 0.48 && h < 0.58) return 'Turquoise';
            if (h < 0.70) return 'Bleu';
            if (h < 0.80) return 'Indigo';
            if (s > 0.5) return 'Violet';
            if (s < 0.2 && v < 0.5) return 'Noir';
            return 'Blanc';
        }

        // ============================================
        // UI UPDATES
        // ============================================
        function updateUI() {
            const { avgR, avgG, avgB, vibrationalRate, colorName, chakras, yinYang, stdDev } = currentAnalysisData;
            
            dominantColorPreview.style.backgroundColor = `rgb(${avgR}, ${avgG}, ${avgB})`;
            dominantColorName.textContent = colorName;
            auraBarColorName.textContent = colorName;
            auraColorBar.style.backgroundColor = `rgb(${avgR}, ${avgG}, ${avgB})`;

            const brightness = (avgR * 299 + avgG * 587 + avgB * 114) / 1000;
            auraColorBar.style.color = brightness > 128 ? 'black' : 'white';

            const colorData = AURA_DATA[colorName];
            if (colorData) {
                dominantColorWavelength.textContent = `~ ${colorData.wavelength} nm`;
                interpretationText.innerHTML = `<strong class="block mb-2 text-white text-base">Signification G√©n√©rale</strong> ${colorData.interpretation}`;
            }

            const tier = getVibrationalTier(vibrationalRate); 
            vibrationalRateValue.textContent = vibrationalRate.toLocaleString('fr-FR'); 
            const percentage = Math.min(100, (vibrationalRate / 20000) * 100); 
            vibrationalGaugeBar.style.strokeDasharray = `${percentage}, 100`; 
            vibrationalLevelText.textContent = tier.level; 
            vibrationalCommentary.textContent = tier.commentary;
            
            updateChakraUI(chakras);
            updateSubtleBodiesUI();
            
            auraShapeTexture.textContent = getShapeTextureInterpretation(stdDev);
            
            yinYangBar.style.width = `${yinYang * 100}%`;
            if(yinYang < 0.4) yinYangText.textContent = "Dominante Jamal";
            else if (yinYang > 0.6) yinYangText.textContent = "Dominante Jalal";
            else yinYangText.textContent = "√âquilibr√©";
            
            if (!recitationAudio && !breathingInterval) {
                updateTherapeuticTools();
            }
        }
        
        function updateChakraUI(chakras) {
            let html = '';
            let dotsHtml = '';
            const isLive = !liveTabContent.classList.contains('hidden');

            for (const name in chakras) {
                const chakra = chakras[name];
                const chakraInfo = CHAKRA_DATA[name];
                const balance = chakra.activity > 30 && chakra.activity < 80 ? '√âquilibr√©' : (chakra.activity <= 30 ? 'Bloqu√©' : 'Hyperactif');
                
                html += `
                    <div class="flex items-center text-sm bg-slate-900/30 p-3 rounded-lg">
                        <div class="w-5 h-5 rounded-full mr-3 flex-shrink-0" style="background-color: rgb(${chakra.r}, ${chakra.g}, ${chakra.b}); box-shadow: 0 0 10px rgb(${chakra.r}, ${chakra.g}, ${chakra.b});"></div>
                        <div class="flex-1 font-semibold text-white">${name}</div>
                        <div class="w-20 text-right text-slate-400">${balance}</div>
                        <div class="w-12 text-right font-bold text-indigo-400">${chakra.activity}%</div>
                    </div>`;
                
                const dotSize = 6 + (chakra.activity / 100) * 14;
                dotsHtml += `
                    <div class="absolute chakra-dot" style="
                        left: 50%; top: ${chakraInfo.yPercent * 100}%; 
                        width: ${dotSize}px; height: ${dotSize}px; 
                        transform: translate(-50%, -50%);
                        background-color: rgb(${chakra.r}, ${chakra.g}, ${chakra.b});
                        box-shadow: 0 0 ${dotSize * 2}px rgb(${chakra.r}, ${chakra.g}, ${chakra.b});
                    "></div>`;
            }
            
            chakraAnalysisContent.innerHTML = html;
            if (isLive) {
                chakraDotsContainer.innerHTML = dotsHtml;
                photoChakraDotsContainer.innerHTML = '';
            } else {
                photoChakraDotsContainer.innerHTML = dotsHtml;
                chakraDotsContainer.innerHTML = '';
            }
        }
        
        function updateSubtleBodiesUI() {
            const { h, s, v, stdDev } = currentAnalysisData;
            let html = '';
            
            const physicalState = v > 0.7 ? 'Vibrant ‚ú®' : (v < 0.4 ? 'Faible üí§' : 'Stable üåü');
            const nafsState = s > 0.8 ? 'Agit√© üåä' : (s < 0.4 ? 'Calme üïäÔ∏è' : '√âquilibr√© ‚öñÔ∏è');
            const qalbState = stdDev < 15 ? 'Clair et Serein üíé' : (stdDev > 40 ? 'Agit√© üå™Ô∏è' : 'Actif üî•');

            html += `<div class="bg-slate-900/30 p-4 rounded-lg"><strong class="text-white">1. Corps Physique (Jism):</strong> ${physicalState} <br><small class="text-slate-400">${SUBTLE_BODIES_DATA[0].desc}</small></div>`;
            html += `<div class="bg-slate-900/30 p-4 rounded-lg"><strong class="text-white">2. L'√Çme (Nafs):</strong> ${nafsState} <br><small class="text-slate-400">${SUBTLE_BODIES_DATA[1].desc}</small></div>`;
            html += `<div class="bg-slate-900/30 p-4 rounded-lg"><strong class="text-white">3. Le C≈ìur (Qalb):</strong> ${qalbState} <br><small class="text-slate-400">${SUBTLE_BODIES_DATA[2].desc}</small></div>`;

            subtleBodiesContent.innerHTML = html;
        }

        function getShapeTextureInterpretation(stdDev) {
            if (stdDev < 15) return "‚ú® L'esprit semble clair et coh√©rent, signe d'un √©tat de paix int√©rieure et de concentration (khushu).";
            if (stdDev < 30) return "üåä L'esprit a une clart√© douce et fluide. Les pens√©es circulent bien. C'est un √©tat d'√©quilibre dynamique et de contentement (rida).";
            if (stdDev < 50) return "üåÄ L'esprit semble quelque peu confus ou agit√©. Cela peut indiquer des pens√©es dispers√©es (waswas) ou des pr√©occupations. Un besoin de se recentrer sur le dhikr est sugg√©r√©.";
            return "‚ö° L'esprit pr√©sente une grande dispersion. Cela peut √™tre li√© √† un √©tat d'anxi√©t√©, ou une forte r√©action √† l'environnement. Un travail de protection par les invocations est recommand√©.";
        }

        // ============================================
        // THERAPEUTIC TOOLS
        // ============================================
        function updateTherapeuticTools() {
            const { colorName } = currentAnalysisData;
            if (!colorName) return;
            const data = AURA_DATA[colorName];
            if (!data) return;
            
            [soundTherapyUI, meditationUI].forEach(el => el.classList.remove('opacity-50'));
            [playSoundButton, playMeditationButton, newAffirmationButton].forEach(btn => btn.disabled = false);

            soundFreqLabel.textContent = `Sourate : ${data.sourate}`;
            meditationTitle.textContent = data.meditation;
            affirmationText.textContent = `"${data.affirmation}"`;
            remedyName.textContent = data.remede.name;
            remedyDescription.textContent = data.remede.desc;
            aromaName.textContent = data.senteur.name;
            aromaDescription.textContent = data.senteur.desc;
            
            if (dailyMessage) {
                dailyMessage.textContent = `Votre lumi√®re ${colorName.toLowerCase()} vous invite aujourd'hui √† vous concentrer sur la patience et la gratitude. ${data.affirmation}`;
            }
        }

        function resetTherapeuticTools() {
            [soundTherapyUI, meditationUI].forEach(el => el.classList.add('opacity-50'));
            [playSoundButton, playMeditationButton, newAffirmationButton].forEach(btn => btn.disabled = true);
            soundFreqLabel.textContent = '...';
            meditationTitle.textContent = '...';
            affirmationText.textContent = '"..."';
            remedyName.textContent = '...';
            aromaName.textContent = '...';
            if(dailyMessage) dailyMessage.textContent = '';
        }
        
        function toggleBreathingExercise() {
            if (breathingInterval) {
                clearInterval(breathingInterval);
                breathingInterval = null;
                startBreathingButton.textContent = "Commencer";
                breathingText.textContent = "Pr√™t ?";
            } else {
                startBreathingButton.textContent = "Arr√™ter";
                let phase = 0;
                const phases = [
                    { text: "Inspirez... (Ya Rahman)", duration: 4000 },
                    { text: "Retenez (Ya Quddus)", duration: 4000 },
                    { text: "Expirez... (Ya Salam)", duration: 4000 },
                    { text: "Pause (Alhamdulillah)", duration: 4000 }
                ];
                
                const nextPhase = () => {
                    breathingText.textContent = phases[phase].text;
                    setTimeout(() => {
                        phase = (phase + 1) % phases.length;
                    }, phases[phase].duration - 200);
                }
                
                breathingInterval = setInterval(nextPhase, 4000);
                nextPhase();
            }
        }
        
        function toggleSoundTherapy() {
            if (recitationAudio && !recitationAudio.paused) {
                recitationAudio.pause();
                recitationAudio.currentTime = 0;
                recitationAudio = null;

                if (rainNoise) rainNoise.stop();
                if (ambianceLfo) ambianceLfo.stop();
                if (thunderTimeout) clearTimeout(thunderTimeout);
                
                rainNoise = null;
                ambianceLfo = null;
                thunderTimeout = null;
                
                if (audioContext && audioContext.state !== 'closed') {
                    audioContext.close().then(() => audioContext = null);
                }

                playSoundButton.innerHTML = '‚ñ∂Ô∏è Lancer';
            } else {
                if (!audioContext || audioContext.state === 'closed') {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }

                const rainBufferSize = 2 * audioContext.sampleRate;
                const rainBuffer = audioContext.createBuffer(1, rainBufferSize, audioContext.sampleRate);
                const rainOutput = rainBuffer.getChannelData(0);
                let lastRainOut = 0.0;
                for (let i = 0; i < rainBufferSize; i++) {
                    const white = Math.random() * 2 - 1;
                    rainOutput[i] = (lastRainOut + (0.02 * white)) / 1.02;
                    lastRainOut = rainOutput[i];
                    rainOutput[i] *= 3.5;
                }
                
                rainNoise = audioContext.createBufferSource();
                rainNoise.buffer = rainBuffer;
                rainNoise.loop = true;
                
                const rainGain = audioContext.createGain();
                rainGain.gain.value = 0.04;

                ambianceLfo = audioContext.createOscillator();
                ambianceLfo.type = 'sine';
                ambianceLfo.frequency.value = 0.05;
                const lfoGain = audioContext.createGain();
                lfoGain.gain.value = 0.03;

                ambianceLfo.connect(lfoGain).connect(rainGain.gain);
                rainNoise.connect(rainGain).connect(audioContext.destination);
                
                ambianceLfo.start();
                rainNoise.start();

                recitationAudio = new Audio(QURAN_AUDIO_B64);
                recitationAudio.loop = true;
                recitationAudio.play();
                
                playSoundButton.innerHTML = '‚èπÔ∏è Arr√™ter';
            }
        }
        
        function startTafakkurMeditation() {
            const { colorName } = currentAnalysisData;
            if (!colorName || !TAFFAKUR_DATA[colorName]) {
                meditationModalTitle.textContent = "M√©ditation Guid√©e";
                meditationModalText.textContent = "Veuillez d'abord lancer une analyse pour recevoir une m√©ditation personnalis√©e.";
            } else {
                const meditationData = TAFFAKUR_DATA[colorName];
                meditationModalTitle.textContent = meditationData.title;
                meditationModalText.textContent = meditationData.text;
            }
            meditationModal.classList.remove('hidden');
        }

        // ============================================
        // RECORDING & HISTORY
        // ============================================
        function toggleRecording() {
            isRecording = !isRecording; 
            if(isRecording) { 
                recordedData = []; 
                recordingStartTime = Date.now(); 
                recordButtonText.textContent = "‚èπÔ∏è Arr√™ter"; 
                recordButton.classList.add('recording-pulse'); 
                recordStatus.textContent = "üî¥ Enregistrement en cours..."; 
                recordIntervalId = setInterval(updateTimer, 1000); 
            } else { 
                clearInterval(recordIntervalId);
                recordIntervalId = null;
                recordButtonText.textContent = "‚è∫Ô∏è D√©marrer"; 
                recordButton.classList.remove('recording-pulse'); 
                recordStatus.textContent = "‚úÖ Enregistrement termin√©"; 
                generateReport(recordedData); 
            }
        }
        
        function updateTimer() { 
            const elapsedSeconds = Math.floor((Date.now() - recordingStartTime) / 1000); 
            recordTimer.textContent = formatTime(elapsedSeconds);
        }
        
        function formatTime(seconds) {
            const m = Math.floor(seconds / 60).toString().padStart(2, '0'); 
            const s = (seconds % 60).toString().padStart(2, '0'); 
            return `${m}:${s}`;
        }

        function generateReport(data) {
            if (data.length < 2) {
                reportContent.innerHTML = `<p class="text-center text-slate-400">‚ö†Ô∏è Pas assez de donn√©es pour un rapport fiable.</p>`;
                reportModal.classList.remove('hidden');
                return;
            }
            
            const vRates = data.map(d => d.vRate);
            const avgVRate = Math.round(vRates.reduce((a, b) => a + b, 0) / vRates.length);
            const avgTier = getVibrationalTier(avgVRate);
            const colorAggregates = {};
            data.forEach(d => {
                const colorName = getColorName(rgbToHsv(d.r, d.g, d.b)[0], d.s, d.v);
                colorAggregates[colorName] = (colorAggregates[colorName] || 0) + 1;
            });
            const dominantColor = Object.keys(colorAggregates).reduce((a, b) => colorAggregates[a] > colorAggregates[b] ? a : b);
            
            const sessionReport = {
                date: new Date().toISOString(),
                duration: data.length,
                dominantColor,
                avgVRate,
                timeline: data.map(d => `rgb(${Math.round(d.r)}, ${Math.round(d.g)}, ${Math.round(d.b)})`),
            };
            
            saveSession(sessionReport);

            reportContent.innerHTML = `
                <div class="text-center mb-6">
                    <p class="text-lg text-slate-300">üìÖ ${new Date(sessionReport.date).toLocaleString('fr-FR')}</p>
                </div>
                <div class="mb-6">
                    <h3 class="font-semibold text-indigo-400 mb-3 text-lg">üìä Ligne de Temps √ânerg√©tique</h3>
                    <div class="w-full h-12 bg-slate-900 rounded-xl flex overflow-hidden shadow-lg">
                        ${sessionReport.timeline.map(c => `<div style="flex-grow: 1; background-color: ${c};"></div>`).join('')}
                    </div>
                </div>
                <div class="glass-card rounded-xl p-6">
                    <h3 class="font-semibold text-indigo-400 mb-4 text-lg">üìà Synth√®se</h3>
                    <p class="text-slate-300 mb-2"><strong>Couleur Dominante:</strong> ${dominantColor}</p>
                    <p class="text-slate-300"><strong>Niveau Sak√Ænah Moyen:</strong> ${avgVRate.toLocaleString('fr-FR')} (${avgTier.level})</p>
                </div>`;
            reportModal.classList.remove('hidden');
        }
        
        function saveSession(report) {
            let history = JSON.parse(localStorage.getItem('auraHistory') || '[]');
            history.unshift(report);
            history = history.slice(0, 50);
            localStorage.setItem('auraHistory', JSON.stringify(history));
        }

        function showHistoryModal() {
            let history = JSON.parse(localStorage.getItem('auraHistory') || '[]');
            if (history.length === 0) {
                historyContent.innerHTML = `<p class="text-center text-slate-400">üì≠ Aucun enregistrement trouv√©.</p>`;
            } else {
                historyContent.innerHTML = history.map(session => `
                    <div class="glass-card rounded-xl p-6 mb-4">
                        <p class="font-bold text-white mb-2">üìÖ ${new Date(session.date).toLocaleString('fr-FR')}</p>
                        <p class="text-sm text-slate-400 mb-3">Dur√©e: ${session.duration}s | Couleur: ${session.dominantColor} | Sak√Ænah: ${session.avgVRate}</p>
                        <div class="w-full h-8 bg-slate-900 rounded-lg flex overflow-hidden">
                            ${session.timeline.map(c => `<div style="flex-grow: 1; background-color: ${c};"></div>`).join('')}
                        </div>
                    </div>
                `).join('');
            }
            historyModal.classList.remove('hidden');
        }
        
        function clearHistory() {
            if(confirm("üóëÔ∏è Voulez-vous vraiment supprimer tout l'historique ?")) {
                localStorage.removeItem('auraHistory');
                historyContent.innerHTML = `<p class="text-center text-slate-400">‚úÖ Historique effac√©.</p>`;
            }
        }
        
        function exportReport() {
            const resultsNode = document.getElementById('results');
            html2canvas(resultsNode, { backgroundColor: "#1e293b" }).then(canvas => {
                const link = document.createElement('a');
                link.download = `rapport-spirituel-${new Date().toISOString().slice(0,10)}.png`;
                link.href = canvas.toDataURL();
                link.click();
            });
        }
        
        function closeModal() {
            reportModal.classList.add('hidden');
            historyModal.classList.add('hidden');
            meditationModal.classList.add('hidden');
        }

        // ============================================
        // UTILITIES
        // ============================================
        function getVibrationalTier(rate) { 
            const tiers = {
                tres_bas: {level:'Tr√®s Bas', commentary:'Signal dispers√©, ghaflah (insouciance) ou tristesse profonde.'},
                bas: {level:'Bas', commentary:'Faible coh√©rence, pr√©occupations mondaines ou tension.'},
                equilibre: {level:'√âquilibr√©', commentary:'Signal stable, √©tat de contentement g√©n√©ral (rida).'},
                eleve: {level:'√âlev√©', commentary:'Forte coh√©rence, clart√© mentale et bien-√™tre (ihsan).'},
                optimal: {level:'Optimal', commentary:'Pic de coh√©rence, paix int√©rieure profonde (sak√Ænah).'}
            };
            if (rate <= 4000) return tiers.tres_bas; 
            if (rate <= 7500) return tiers.bas; 
            if (rate <= 11000) return tiers.equilibre; 
            if (rate <= 15000) return tiers.eleve; 
            return tiers.optimal;
        }

        function rgbToHsv(r, g, b) {
            r /= 255, g /= 255, b /= 255; 
            let max = Math.max(r, g, b), min = Math.min(r, g, b); 
            let h, s, v = max; 
            let d = max - min; 
            s = max == 0 ? 0 : d / max; 
            if (max == min) h = 0;
            else { 
                switch (max) { 
                    case r: h = (g - b) / d + (g < b ? 6 : 0); break; 
                    case g: h = (b - r) / d + 2; break; 
                    case b: h = (r - g) / d + 4; break; 
                } 
                h /= 6; 
            } 
            return [h, s, v];
        }
        
        function hsvToRgb(h, s, v) {
            let r, g, b;
            let i = Math.floor(h * 6);
            let f = h * 6 - i;
            let p = v * (1 - s);
            let q = v * (1 - f * s);
            let t = v * (1 - (1 - f) * s);
            switch (i % 6) {
                case 0: r = v, g = t, b = p; break;
                case 1: r = q, g = v, b = p; break;
                [object Object]
                    case 2: r = p, g = v, b = t; break;
                case 3: r = p, g = q, b = v; break;
                case 4: r = t, g = p, b = v; break;
                case 5: r = v, g = p, b = q; break;
            }
            return [Math.round(r * 255), Math.round(g * 255), Math.round(b * 255)];
        }
        
        // ============================================
        // ADVANCED VISUALIZATION
        // ============================================
        function drawAuraLayer(currentCtx, width, height, rgb, radiusFactor, opacity) {
            const centerX = width / 2;
            const centerY = height / 2;
            const maxRadius = Math.min(width, height) * radiusFactor;
            
            // Create radial gradient with multiple color stops
            const gradient = currentCtx.createRadialGradient(
                centerX, centerY, maxRadius * 0.3,
                centerX, centerY, maxRadius
            );
            
            gradient.addColorStop(0, `rgba(${rgb[0]}, ${rgb[1]}, ${rgb[2]}, ${opacity * 0.9})`);
            gradient.addColorStop(0.5, `rgba(${rgb[0]}, ${rgb[1]}, ${rgb[2]}, ${opacity * 0.6})`);
            gradient.addColorStop(0.8, `rgba(${rgb[0]}, ${rgb[1]}, ${rgb[2]}, ${opacity * 0.3})`);
            gradient.addColorStop(1, `rgba(${rgb[0]}, ${rgb[1]}, ${rgb[2]}, 0)`);
            
            currentCtx.save();
            currentCtx.globalCompositeOperation = 'screen';
            currentCtx.fillStyle = gradient;
            currentCtx.fillRect(0, 0, width, height);
            currentCtx.restore();
        }
        
        function drawSubtleBodies(currentCtx, width, height, baseRgb) {
            time += 0.015;
            const [h, s, v] = rgbToHsv(baseRgb[0], baseRgb[1], baseRgb[2]);
            const pulse = Math.sin(time) * 0.015;

            SUBTLE_BODIES_DATA.forEach((body, index) => {
                const bodyH = (h + body.hueShift + 1) % 1;
                const bodyS = Math.max(0, Math.min(1, s * body.satFactor));
                const bodyV = Math.max(0, Math.min(1, v * body.valFactor));
                const bodyRgb = hsvToRgb(bodyH, bodyS, bodyV);
                
                // Add wave effect to each layer
                const waveOffset = Math.sin(time + index * 0.5) * 0.02;
                const bodyRadius = body.radius + pulse * (body.radius * 0.3) + waveOffset;
                
                drawAuraLayer(currentCtx, width, height, bodyRgb, bodyRadius, body.opacity);
            });
        }

        function manageParticles(currentCtx, width, height, r, g, b, vibrationalRate) {
            const baseSpeed = Math.max(0.3, vibrationalRate / 12000);
            const spawnRate = Math.max(0.3, vibrationalRate / 15000);

            // Spawn new particles
            if (particles.length < MAX_PARTICLES && Math.random() > (1 - spawnRate)) {
                const angle = Math.random() * Math.PI * 2;
                const radius = (width * 0.25) + Math.random() * (width * 0.35);
                const x = width / 2 + Math.cos(angle) * radius;
                const y = height / 2 + Math.sin(angle) * radius;
                
                // Add color variation
                const colorVar = 30;
                const pr = Math.max(0, Math.min(255, r + (Math.random() - 0.5) * colorVar));
                const pg = Math.max(0, Math.min(255, g + (Math.random() - 0.5) * colorVar));
                const pb = Math.max(0, Math.min(255, b + (Math.random() - 0.5) * colorVar));
                
                particles.push({ 
                    x, 
                    y, 
                    vx: (Math.random() - 0.5) * baseSpeed * 2, 
                    vy: (Math.random() - 0.5) * baseSpeed * 2, 
                    life: 1, 
                    size: Math.random() * 3 + 1, 
                    r: pr, 
                    g: pg, 
                    b: pb 
                });
            }

            // Update and draw particles
            currentCtx.save();
            currentCtx.globalCompositeOperation = 'screen';
            
            for (let i = particles.length - 1; i >= 0; i--) {
                let p = particles[i];
                
                // Update position
                p.x += p.vx; 
                p.y += p.vy; 
                p.life -= 0.008;
                
                // Add slight attraction to center
                const dx = (width / 2) - p.x;
                const dy = (height / 2) - p.y;
                const dist = Math.sqrt(dx * dx + dy * dy);
                if (dist > 0) {
                    p.vx += (dx / dist) * 0.01;
                    p.vy += (dy / dist) * 0.01;
                }
                
                // Remove dead particles
                if (p.life <= 0) { 
                    particles.splice(i, 1); 
                    continue; 
                }
                
                // Draw particle with glow
                const alpha = p.life * 0.9;
                
                // Outer glow
                currentCtx.beginPath();
                currentCtx.fillStyle = `rgba(${p.r}, ${p.g}, ${p.b}, ${alpha * 0.3})`;
                currentCtx.arc(p.x, p.y, p.size * 2, 0, Math.PI * 2);
                currentCtx.fill();
                
                // Inner particle
                currentCtx.beginPath();
                currentCtx.fillStyle = `rgba(${p.r}, ${p.g}, ${p.b}, ${alpha})`;
                currentCtx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                currentCtx.fill();
            }
            
            currentCtx.restore();
        }

        // ============================================
        // INITIALIZATION ON LOAD
        // ============================================
        document.addEventListener('DOMContentLoaded', initializeApp);

    </script>
</body>
</html>
