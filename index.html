<!DOCTYPE html>
<html lang="fr" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analyseur d'aura de RTN</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .gradient-text {
            background: linear-gradient(90deg, #38bdf8, #a78bfa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .aura-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            pointer-events: none;
        }
        .video-feed {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1); /* Effet miroir */
        }
        .card-glow {
            box-shadow: 0 0 15px rgba(167, 139, 250, 0.3), 0 0 5px rgba(56, 189, 248, 0.2);
        }
        .btn-glow:hover {
            box-shadow: 0 0 20px rgba(167, 139, 250, 0.5);
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1e293b;
        }
        ::-webkit-scrollbar-thumb {
            background-color: #4f46e5;
            border-radius: 10px;
            border: 2px solid #1e293b;
        }
        .recording-pulse {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.7;
            }
        }
        .modal-backdrop {
            background-color: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(8px);
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-300 antialiased">

    <!-- Header -->
    <header class="py-4 px-6 md:px-12 border-b border-slate-800 backdrop-blur-sm sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold gradient-text">Analyseur d'aura de RTN</h1>
            <nav class="hidden md:flex space-x-6 text-sm">
                <a href="#analyzer" class="hover:text-sky-400 transition-colors">Analyseur</a>
                <a href="#how-it-works" class="hover:text-sky-400 transition-colors">Principe</a>
                <a href="#disclaimer" class="hover:text-sky-400 transition-colors">Avertissement</a>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto p-6 md:p-12">

        <!-- Hero Section -->
        <section id="hero" class="text-center my-12 md:my-20">
            <h2 class="text-4xl md:text-6xl font-extrabold text-slate-100 mb-4">Visualisez Votre Signature Énergétique</h2>
            <p class="max-w-3xl mx-auto text-lg text-slate-400 mb-8">
                Une exploration technologique des micro-variations lumineuses capturées par votre webcam ou une photo.
                Cette application utilise des algorithmes de vision par ordinateur pour interpréter les données de votre flux vidéo ou image.
            </p>
            <a href="#analyzer" class="bg-indigo-600 text-white font-bold py-3 px-8 rounded-full hover:bg-indigo-500 transition-all duration-300 btn-glow inline-block">
                Démarrer l'analyse
            </a>
        </section>

        <!-- Analyzer Section -->
        <section id="analyzer" class="mb-24">
            <div class="bg-slate-800/50 rounded-2xl p-6 md:p-8 card-glow backdrop-blur-lg">
                <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
                    
                    <!-- Analysis Interface Column -->
                    <div class="lg:col-span-3">
                         <!-- Tab Buttons -->
                        <div class="flex border-b border-slate-700 mb-4">
                            <button id="liveTabButton" class="px-4 py-2 text-sm font-semibold border-b-2 border-indigo-500 text-white transition-colors duration-200">Analyse en direct</button>
                            <button id="photoTabButton" class="px-4 py-2 text-sm font-semibold border-b-2 border-transparent text-slate-400 hover:text-white transition-colors duration-200">Analyse Photo</button>
                        </div>

                        <!-- Live Analysis Tab -->
                        <div id="liveTabContent">
                            <div id="video-container" class="relative aspect-video bg-slate-900 rounded-lg overflow-hidden flex items-center justify-center">
                                <video id="video" class="video-feed" playsinline autoplay muted style="z-index: 0;"></video>
                                <canvas id="canvas" class="aura-canvas" style="z-index: 1;"></canvas>
                                <div id="loading-spinner" class="absolute z-10 text-white hidden">
                                    <svg class="animate-spin h-10 w-10 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                </div>
                                <div id="start-message" class="absolute z-20 text-center p-4">
                                    <p class="text-slate-300 mb-4">Cliquez pour activer la caméra et commencer l'analyse.</p>
                                    <button id="startButton" class="bg-indigo-600 text-white font-bold py-3 px-8 rounded-full hover:bg-indigo-500 transition-all duration-300 btn-glow">Activer la caméra</button>
                                </div>
                            </div>
                            <div class="mt-4 text-center">
                                <button id="stopButton" class="hidden bg-red-600 text-white font-bold py-2 px-6 rounded-full hover:bg-red-500 transition-all duration-300 btn-glow">Arrêter l'analyse</button>
                            </div>
                        </div>

                        <!-- Photo Analysis Tab -->
                        <div id="photoTabContent" class="hidden">
                            <div id="photo-container" class="relative aspect-video bg-slate-900 rounded-lg overflow-hidden flex items-center justify-center">
                                <img id="photo-preview" class="hidden absolute top-0 left-0 w-full h-full object-contain" style="z-index: 0;" />
                                <canvas id="photo-canvas" class="aura-canvas" style="object-fit: contain; z-index: 1;"></canvas>
                                <button id="clearPhotoButton" class="hidden absolute top-3 right-3 z-30 bg-slate-900/60 hover:bg-slate-700/80 p-1.5 rounded-full text-slate-300 hover:text-white transition-colors" title="Effacer la photo">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                      <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                </button>
                                <div id="photo-start-message" class="absolute z-20 text-center p-4">
                                    <p class="text-slate-300 mb-4">Chargez une photo pour analyser sa signature énergétique.</p>
                                    <input type="file" id="photoInput" class="hidden" accept="image/png, image/jpeg">
                                    <label for="photoInput" class="cursor-pointer bg-indigo-600 text-white font-bold py-3 px-8 rounded-full hover:bg-indigo-500 transition-all duration-300 btn-glow">
                                        Charger une Photo
                                    </label>
                                </div>
                                 <div id="photo-loading-spinner" class="absolute z-10 text-white hidden">
                                    <svg class="animate-spin h-10 w-10 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                 </div>
                            </div>
                        </div>
                    </div>

                    <!-- Results Column -->
                    <div class="lg:col-span-2 flex flex-col justify-between">
                        <div>
                            <h3 id="analysis-title" class="text-2xl font-bold text-slate-100 mb-4"></h3>
                            <div id="results" class="space-y-4 hidden">
                                <div class="bg-slate-900/70 p-4 rounded-lg">
                                    <h4 class="text-sm font-semibold text-slate-400 mb-2">Couleur Dominante de l'Aura</h4>
                                    <div class="flex items-start space-x-4">
                                        <div id="dominant-color-preview" class="w-12 h-12 rounded-full border-2 border-slate-700 flex-shrink-0"></div>
                                        <div>
                                            <p id="dominant-color-name" class="text-xl font-bold text-white">En attente...</p>
                                            <p id="dominant-color-wavelength" class="text-xs text-sky-400 font-mono">~ ... nm</p>
                                            <div id="dominant-color-keywords" class="mt-2 flex flex-wrap gap-x-2 gap-y-1">
                                                <!-- Les mots-clés seront injectés ici -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Analyse Vibratoire Section -->
                                <div class="bg-slate-900/70 p-4 rounded-lg">
                                    <h4 class="text-sm font-semibold text-slate-400 mb-4">Analyse du Taux Vibratoire</h4>
                                    <div class="flex flex-col items-center gap-4">
                                        <div class="relative w-32 h-32">
                                            <svg id="vibrational-gauge" class="w-full h-full -rotate-90" viewBox="0 0 36 36">
                                                <path class="stroke-slate-700"
                                                      d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                                                      fill="none" stroke-width="3"></path>
                                                <path id="vibrational-gauge-bar" class="stroke-sky-400 transition-all duration-500"
                                                      d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                                                      fill="none" stroke-width="3" stroke-dasharray="0, 100" stroke-linecap="round"></path>
                                            </svg>
                                            <div class="absolute inset-0 flex flex-col items-center justify-center text-center">
                                                <span id="vibrational-rate-value" class="text-2xl font-bold font-mono text-white">...</span>
                                                <span class="text-xs text-slate-400">UBQ</span>
                                            </div>
                                        </div>
                                        <div class="text-center w-full">
                                             <p id="vibrational-level-text" class="font-semibold text-lg text-white">En attente...</p>
                                             <p id="vibrational-commentary" class="text-slate-300 text-sm h-24 overflow-y-auto mt-2 px-2">L'analyse vibratoire débutera avec l'activation de la caméra. Elle se base sur la cohérence et la luminance du signal bio-photonique capté.</p>
                                        </div>
                                    </div>
                                </div>

                                <div class="bg-slate-900/70 p-4 rounded-lg">
                                    <h4 class="text-sm font-semibold text-slate-400 mb-2">Analyse Détaillée de l'Aura</h4>
                                    <div id="interpretation-text" class="text-slate-300 text-sm h-32 overflow-y-auto">L'analyse débutera lorsque la caméra sera active. Le système interprète les variations de chrominance et de luminance comme des indicateurs potentiels de l'état physiologique.</div>
                                </div>

                                 <div class="bg-slate-900/70 p-4 rounded-lg">
                                      <h4 class="text-sm font-semibold text-slate-400 mb-2">Enregistrement de Session</h4>
                                      <div class="flex items-center justify-between gap-4 mt-2">
                                           <button id="recordButton" class="bg-sky-600 text-white text-sm font-bold py-2 px-4 rounded-full hover:bg-sky-500 transition-all duration-300 btn-glow w-full disabled:bg-slate-600 disabled:cursor-not-allowed" disabled>Démarrer</button>
                                           <p id="recordTimer" class="font-mono text-lg text-slate-300">00:00</p>
                                      </div>
                                      <p id="recordStatus" class="text-xs text-slate-500 mt-2 text-center">Activez la caméra pour pouvoir enregistrer.</p>
                                 </div>

                            </div>
                            <div id="results-placeholder" class="text-center text-slate-500 pt-16">
                                <p>Les résultats de l'analyse s'afficheront ici.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- How It Works Section -->
        <section id="how-it-works" class="mb-24 text-center">
            <h2 class="text-3xl md:text-4xl font-bold text-slate-100 mb-4">Principe de Fonctionnement</h2>
            <p class="max-w-3xl mx-auto text-slate-400 mb-12">
                Cette application n'utilise aucune méthode surnaturelle. Son fonctionnement repose sur des principes de vision par ordinateur et d'analyse de données.
            </p>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <div class="bg-slate-800 p-6 rounded-lg">
                    <h3 class="font-bold text-sky-400 mb-2">1. Capture Vidéo / Photo</h3>
                    <p class="text-sm">L'application accède au flux vidéo de votre webcam ou analyse une photo que vous chargez via votre navigateur.</p>
                </div>
                <div class="bg-slate-800 p-6 rounded-lg">
                    <h3 class="font-bold text-sky-400 mb-2">2. Analyse Algorithmique</h3>
                    <p class="text-sm">Un algorithme analyse la périphérie de la silhouette pour détecter les distributions de couleur, la luminance et la cohérence du signal lumineux.</p>
                </div>
                <div class="bg-slate-800 p-6 rounded-lg">
                    <h3 class="font-bold text-sky-400 mb-2">3. Visualisation des Données</h3>
                    <p class="text-sm">Les données sont traduites en visualisations (halo, jauges). L'interprétation est une corrélation statistique et non un diagnostic.</p>
                </div>
            </div>
        </section>
        
        <!-- Disclaimer Section -->
        <section id="disclaimer" class="bg-amber-900/20 border border-amber-600/50 rounded-lg p-6 md:p-8 text-center">
             <h2 class="text-2xl font-bold text-amber-300 mb-4">Avertissement Important</h2>
            <p class="max-w-4xl mx-auto text-amber-300/80">
                Cet outil est un projet technologique expérimental et ne doit pas être utilisé à des fins de diagnostic médical, psychologique ou spirituel. Les résultats sont des interprétations algorithmiques de données visuelles.
                Les interprétations symboliques des couleurs sont basées sur des concepts issus de la psychologie des couleurs et de diverses approches holistiques. Elles sont fournies à titre informatif et exploratoire uniquement.
                 <br><br>
                L'analyse du "taux vibratoire" est une métrique algorithmique dérivée de la cohérence et de la luminance du signal vidéo. Elle ne représente aucune mesure spirituelle ou ésotérique. Les termes employés (ex: UBQ - Unités Bovis Quantiques) sont des unités conceptuelles propres à cet outil pour quantifier la qualité du signal. Cette fonctionnalité est proposée comme un indicateur de l'état de calme ou de stress physiologique, dans un cadre purement technologique et informationnel.
                 <br><br>
                Ce projet a été développé dans le respect de toutes les convictions. Il ne promeut aucune croyance, idéologie ou pratique contraire aux principes fondamentaux des diverses confessions, y compris l'Islam. Il se distance explicitement de toute forme de divination, de voyance ou de pratiques associées au surnaturel, qui sont des concepts étrangers à sa nature purement technique.
            </p>
        </section>

    </main>
    
    <!-- Report Modal -->
    <div id="report-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden modal-backdrop">
        <div class="bg-slate-800 border border-slate-700 rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col">
            <header class="p-4 border-b border-slate-700 flex justify-between items-center flex-shrink-0">
                <h2 class="text-xl font-bold text-slate-100">Rapport de Session d'Analyse</h2>
                <button id="close-modal-button" class="text-slate-400 hover:text-white text-3xl leading-none">&times;</button>
            </header>
            <div id="report-content" class="p-6 overflow-y-auto space-y-6">
                <!-- Content generated by JS -->
            </div>
             <footer class="p-4 border-t border-slate-700 text-center flex-shrink-0">
                 <button id="close-modal-button-2" class="bg-indigo-600 text-white font-bold py-2 px-6 rounded-full hover:bg-indigo-500 transition-all duration-300">Fermer</button>
             </footer>
        </div>
    </div>


    <!-- Footer -->
    <footer class="text-center py-8 border-t border-slate-800 mt-16">
        <p class="text-sm text-slate-500">&copy; 2024 Bio-Résonance Project. Conçu pour l'exploration technologique.</p>
    </footer>

    <script>
        // --- DOM ELEMENTS ---
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        const startButton = document.getElementById('startButton');
        const stopButton = document.getElementById('stopButton');
        const startMessage = document.getElementById('start-message');
        const loadingSpinner = document.getElementById('loading-spinner');
        const resultsContainer = document.getElementById('results');
        const resultsPlaceholder = document.getElementById('results-placeholder');
        const videoContainer = document.getElementById('video-container');
        const analysisTitle = document.getElementById('analysis-title');

        // Tabs elements
        const liveTabButton = document.getElementById('liveTabButton');
        const photoTabButton = document.getElementById('photoTabButton');
        const liveTabContent = document.getElementById('liveTabContent');
        const photoTabContent = document.getElementById('photoTabContent');
        
        // Photo elements
        const photoInput = document.getElementById('photoInput');
        const photoPreview = document.getElementById('photo-preview');
        const photoStartMessage = document.getElementById('photo-start-message');
        const photoLoadingSpinner = document.getElementById('photo-loading-spinner');
        const photoCanvas = document.getElementById('photo-canvas');
        const photoCtx = photoCanvas.getContext('2d', { willReadFrequently: true });
        const clearPhotoButton = document.getElementById('clearPhotoButton');

        // Aura elements
        const dominantColorPreview = document.getElementById('dominant-color-preview');
        const dominantColorName = document.getElementById('dominant-color-name');
        const dominantColorWavelength = document.getElementById('dominant-color-wavelength');
        const dominantColorKeywords = document.getElementById('dominant-color-keywords');
        const interpretationText = document.getElementById('interpretation-text');
        
        // Vibrational elements
        const vibrationalGaugeBar = document.getElementById('vibrational-gauge-bar');
        const vibrationalRateValue = document.getElementById('vibrational-rate-value');
        const vibrationalLevelText = document.getElementById('vibrational-level-text');
        const vibrationalCommentary = document.getElementById('vibrational-commentary');

        // Recording elements
        const recordButton = document.getElementById('recordButton');
        const recordTimer = document.getElementById('recordTimer');
        const recordStatus = document.getElementById('recordStatus');

        // Modal elements
        const reportModal = document.getElementById('report-modal');
        const closeModalButton = document.getElementById('close-modal-button');
        const closeModalButton2 = document.getElementById('close-modal-button-2');
        const reportContent = document.getElementById('report-content');
        
        // --- CONSTANTS & STATE ---
        const COLOR_DATA = {
            'Rouge': { wavelength: '625-740', keywords: ['Vitalité', 'Force', 'Action'] },
            'Orange': { wavelength: '590-625', keywords: ['Créativité', 'Joie', 'Sociabilité'] },
            'Jaune': { wavelength: '565-590', keywords: ['Intellect', 'Confiance', 'Optimisme'] },
            'Vert': { wavelength: '520-565', keywords: ['Équilibre', 'Harmonie', 'Guérison'] },
            'Bleu': { wavelength: '435-520', keywords: ['Calme', 'Communication', 'Sérénité'] },
            'Indigo': { wavelength: '400-435', keywords: ['Intuition', 'Sagesse', 'Perception'] },
            'Violet': { wavelength: '380-400', keywords: ['Spiritualité', 'Transformation', 'Imagination'] },
            'Blanc': { wavelength: 'Spectre large', keywords: ['Pureté', 'Clarté', 'Potentiel'] }
        };

        // --- [NEW] EXPANDED INTERPRETATIONS FOR REPORT ANALYSIS ---
        const INTERPRETATIONS = {
            'Rouge': {
                pale: "Un rouge pâle ou rosé signale une énergie vitale en phase de réveil. C'est le dégel après l'hiver : la force de vie revient doucement, la passion s'éveille sans bruit. Peut indiquer une convalescence, un nouveau départ prudent ou un amour naissant. C'est une force tranquille, pleine de potentiel.",
                equilibre: "Un rouge rubis, équilibré, est la signature d'une vitalité saine et d'un ancrage solide. L'énergie est abondante mais maîtrisée. C'est la force de l'athlète, la passion de l'artiste engagé, le courage du leader. Il y a une harmonie entre le corps, la volonté et l'action.",
                intense: "Un rouge profond ou écarlate révèle une énergie vitale intense, presque volcanique. C'est une force brute qui peut se traduire par une grande ambition ou une colère explosive. Souvent lié à des questions de survie, de territoire ou de stress intense. Cette puissance demande à être canalisée avec conscience pour ne pas devenir destructrice.",
                pale_equilibre: "Une vitalité en phase de construction. L'énergie de base se stabilise, passant d'un état de convalescence à une force tranquille et assurée. C'est le chemin de l'ancrage retrouvé et de la confiance qui s'installe.",
                equilibre_intense: "Une force de vie maîtrisée, mais traversée par des pics de passion et de volonté. L'énergie est globalement stable, mais capable de puissantes accélérations pour surmonter les défis ou poursuivre un but concret.",
                pale_intense: "Une dynamique de contraste, où des sursauts d'énergie intense émergent d'un fond de fatigue ou de réserve. Cela peut indiquer une lutte pour l'action ou des passions qui s'éveillent malgré un manque de ressources vitales."
            },
            'Orange': {
                pale: "L'orange pâle, couleur pêche, évoque une sensualité et une créativité qui s'éveillent en douceur. Les émotions sont présentes mais feutrées. C'est le début d'une ouverture aux autres, une socialisation timide mais sincère. L'optimisme est là, en germe.",
                equilibre: "Un orange mandarine, stable et joyeux, est le signe d'un équilibre émotionnel sain. La créativité est fluide, les relations sont nourrissantes. C'est l'énergie de l'enthousiasme, de l'aventure partagée et du plaisir de vivre. Le rapport aux autres est sain et constructif.",
                intense: "L'orange vif, presque fluorescent, traduit une forte charge émotionnelle ou un désir intense d'expériences. La créativité est explosive, mais peut mener à la recherche de sensations fortes ou à une dépendance affective. C'est une énergie d'expansion qui a besoin de cadre pour ne pas s'éparpiller.",
                pale_equilibre: "La créativité et la joie s'épanouissent doucement. Une ouverture progressive aux autres se met en place, passant d'une timidité initiale à des interactions sociales plus fluides et nourrissantes.",
                equilibre_intense: "Un équilibre émotionnel dynamique, où une joie de vivre stable est amplifiée par des moments d'enthousiasme et de créativité débordante. Les relations sont à la fois saines et passionnées.",
                pale_intense: "Une sensibilité émotionnelle fluctuante. Des élans de créativité ou de socialisation intense alternent avec des moments de retrait, suggérant un besoin de recharger ses batteries émotionnelles."
            },
            'Jaune': {
                pale: "Le jaune pâle est la lueur de l'intellect qui s'éveille. C'est la curiosité, l'émergence de nouvelles idées, la joie d'apprendre. La confiance en soi se construit, l'esprit est flexible et optimiste. C'est l'étudiant, le chercheur en début de parcours.",
                equilibre: "Le jaune d'or, solaire et rayonnant, est le signe d'un intellect clair et d'une personnalité affirmée. La confiance en soi est bien établie, la joie est naturelle. C'est le pouvoir personnel utilisé avec sagesse et discernement. L'esprit est vif, organisé et efficace.",
                intense: "Un jaune acide ou moutarde signale une surchauffe mentale. L'intellect est sur-sollicité, menant à la critique, au cynisme ou à un besoin de tout contrôler. C'est une énergie nerveuse, qui a grand besoin de se reconnecter au corps et à l'intuition pour retrouver la paix.",
                pale_equilibre: "L'intellect s'éclaircit et gagne en confiance. Les idées sont explorées avec un optimisme croissant, passant de la simple curiosité à une application plus structurée et affirmée des connaissances.",
                equilibre_intense: "Un mental vif et organisé, capable de périodes d'hyper-concentration. La clarté intellectuelle est la norme, mais elle peut s'intensifier pour résoudre des problèmes complexes, au risque d'une certaine fatigue nerveuse.",
                pale_intense: "Des fulgurances intellectuelles sur fond de doute. Des idées géniales peuvent émerger, mais leur expression est entravée par une confiance en soi fragile, créant une tension entre la vision et la réalisation."
            },
            'Vert': {
                pale: "Un vert pâle, mentholé, indique une phase de guérison. Le cœur, peut-être blessé, apprend à se rouvrir. C'est une énergie de renouveau fragile, un besoin de paix, d'espace et de compassion envers soi-même. Un nouveau cycle de croissance commence.",
                equilibre: "Le vert émeraude, riche et profond, est la couleur du cœur ouvert et en paix. C'est l'amour inconditionnel en action : la compassion, l'harmonie, l'équilibre. Une forte connexion à la nature et aux autres. C'est le point central où toutes les énergies s'équilibrent.",
                intense: "Un vert olive ou trop sombre peut signaler un cœur qui se ferme. Cela peut être le signe de jalousie, de ressentiment, ou d'un attachement rigide au passé. La stabilité devient stagnation. C'est une invitation à pardonner et à laisser aller pour que l'énergie puisse à nouveau circuler.",
                pale_equilibre: "Un processus de guérison du cœur est en bonne voie. La paix intérieure s'installe progressivement, permettant une connexion plus stable et harmonieuse avec soi-même et avec les autres.",
                equilibre_intense: "Un amour profond et stable, qui peut parfois se muer en attachement excessif ou en possessivité. Le besoin d'harmonie est si fort qu'il peut conduire à une résistance au changement, par peur de perdre l'équilibre.",
                pale_intense: "Le cœur oscille entre le besoin de se protéger et le désir de se connecter. Des moments de grande compassion peuvent alterner avec des phases de retrait, indiquant une blessure émotionnelle qui demande encore de l'attention."
            },
            'Bleu': {
                pale: "Le bleu ciel, léger et aérien, est le souffle de la paix. Il indique une communication douce, une pensée calme et une nature sincère. C'est l'énergie de l'inspiration, de la dévotion. Un esprit tranquille qui aspire à la sérénité et à l'expression de sa vérité intérieure.",
                equilibre: "Le bleu roi, stable et affirmé, est le signe d'une communication claire et honnête. La parole est juste, l'écoute est attentive. C'est la force tranquille de celui qui connaît sa vérité et l'exprime avec intégrité. Parfait pour enseigner, conseiller ou diriger.",
                intense: "Un bleu marine ou nuit, très dense, indique une plongée dans l'introspection. L'esprit est tourné vers l'intérieur, cherchant la vérité dans les profondeurs de l'être. Peut mener à un sentiment de solitude ou de mélancolie si la communication avec l'extérieur est coupée.",
                pale_equilibre: "La communication gagne en assurance. Une expression initialement timide ou douce se transforme en une parole plus claire et affirmée, signe d'une confiance grandissante en sa propre vérité.",
                equilibre_intense: "Une communication habituellement claire et posée, qui tend vers une introspection profonde. La recherche de vérité intérieure est prédominante, ce qui peut parfois réduire les échanges avec l'extérieur au profit de la réflexion.",
                pale_intense: "Une dualité entre le désir de s'exprimer et la peur de le faire. Des moments de communication inspirée peuvent être suivis de périodes de silence ou d'introspection, reflétant une quête de légitimité pour sa propre parole."
            },
            'Indigo': {
                pale: "L'indigo pâle est le murmure de l'intuition. Les perceptions subtiles s'éveillent, les rêves deviennent plus vifs. C'est l'ouverture du 'troisième œil', une invitation à regarder au-delà du visible et à faire confiance à ses ressentis profonds.",
                equilibre: "L'indigo, riche et vibrant, est la marque d'une intuition claire et d'une grande sagesse intérieure. La personne perçoit les schémas, les symboles, et comprend les situations avec une profondeur remarquable. C'est l'énergie de la clairvoyance et de la vision juste.",
                intense: "Un indigo très sombre ou électrique peut signaler un mental surchargé d'informations subtiles. Le risque est de se perdre dans des mondes imaginaires ou des théories complexes, et de se déconnecter de la réalité pratique. L'ancrage est essentiel.",
                pale_equilibre: "L'intuition se structure et devient un guide fiable. Les perceptions subtiles, d'abord fugaces, s'intègrent dans une compréhension plus large et sage des événements, menant à une vision plus claire.",
                equilibre_intense: "Une sagesse intérieure profonde qui risque de se déconnecter du réel. L'intuition est forte, mais une surabondance d'informations subtiles peut conduire à un repli dans des mondes intérieurs complexes, au détriment de l'action concrète.",
                pale_intense: "Des flashs intuitifs puissants mais déstabilisants. L'ouverture des perceptions est réelle mais peut être difficile à intégrer, créant un décalage entre les visions intérieures et la vie de tous les jours."
            },
            'Violet': {
                pale: "Le lavande ou le lilas est la porte d'entrée vers la spiritualité. C'est une énergie de grande sensibilité, d'imagination, de connexion avec le monde des rêves et de l'art. Une nature douce, altruiste, qui aspire à la beauté et à l'harmonie universelle.",
                equilibre: "Le violet améthyste est la couleur de la maîtrise spirituelle. La conscience est élevée, connectée à un but supérieur, mais parfaitement intégrée dans la réalité. C'est l'énergie du guide, du sage, qui allie connaissance universelle et action juste dans le monde.",
                intense: "Le violet pourpre, intense, indique une conscience cosmique, une fusion avec le Tout. C'est une vibration très élevée qui peut rendre difficile l'incarnation dans les aspects pratiques de la vie. L'enjeu est de ramener cette sagesse 'd'en haut' pour la rendre accessible ici-bas.",
                pale_equilibre: "La spiritualité s'incarne. Une sensibilité artistique et onirique se transforme en une sagesse pratique et applicable au quotidien, créant un pont entre l'inspiration et l'action.",
                equilibre_intense: "Une conscience spirituelle très élevée qui cherche sa place dans le monde matériel. La connexion au 'Tout' est forte, mais l'enjeu principal est de traduire cette sagesse universelle en actions concrètes sans se sentir déconnecté.",
                pale_intense: "Une imagination et une sensibilité exacerbées qui peuvent être difficiles à canaliser. La connexion à des plans subtils est forte mais peut manquer d'ancrage, rendant la vie pratique et matérielle plus complexe à gérer."
            },
             'Blanc': {
                pale: "Un blanc cassé ou brumeux indique une phase de transition. Le champ énergétique est en cours de nettoyage, ce qui peut créer un sentiment de confusion ou de vide. C'est le silence avant la création, un potentiel immense qui n'a pas encore pris forme.",
                equilibre: "Le blanc cristallin, pur, est une aura de haute fréquence. Il indique une grande pureté d'intention et agit comme un bouclier protecteur. Contenant toutes les couleurs, il est le signe d'un équilibre parfait et d'une connexion claire à la conscience supérieure.",
                intense: "Le blanc immaculé, presque aveuglant, est extrêmement rare. C'est l'énergie de la conscience pure, de la transcendance. Une connexion directe avec la Source. Cette vibration est si élevée qu'elle est au-delà de la personnalité, agissant comme un canal pur de lumière et de guérison.",
                pale_equilibre: "Un potentiel en cours de clarification. L'énergie se purifie, passant d'un état de transition un peu confus à un champ aurique clair, stable et protecteur. C'est la fin d'un cycle de nettoyage et le début d'une nouvelle clarté.",
                equilibre_intense: "Une pureté et une connexion spirituelle exceptionnelles. L'aura est non seulement équilibrée et protectrice, mais elle atteint également des pics de conscience transcendante, agissant comme un phare spirituel.",
                pale_intense: "Une phase de transition intense et potentiellement déroutante. Le champ énergétique subit un nettoyage profond, oscillant entre le vide du renouveau et des éclairs de conscience pure, ce qui peut être très déstabilisant avant de trouver un nouvel équilibre."
            }
        };

        const VIBRATIONAL_DATA = {
             tres_bas: { level: 'Très Basse Fréquence', commentary: "L'analyse indique une dispersion significative du signal bio-photonique. Cela peut correspondre à un état de fatigue physique profonde ou de stress mental important. Il est recommandé de privilégier le repos, l'hydratation et des activités calmes pour favoriser la régulation naturelle du système.", colorHex: '#ef4444' }, 
             bas: { level: 'Basse Fréquence', commentary: "Le signal présente une faible cohérence, souvent associée à un état de préoccupation mentale ou de tension corporelle. Des pratiques de relaxation, comme la respiration consciente ou une marche dans la nature, peuvent aider à améliorer la stabilité du signal.", colorHex: '#f97316' }, 
             equilibre: { level: 'Fréquence d\'Équilibre', commentary: "Le signal est stable et modérément cohérent, ce qui reflète un état d'homéostasie général. C'est le signe d'un équilibre fonctionnel entre l'activité mentale et la relaxation physique. Maintenir des habitudes de vie saines soutiendra cette stabilité.", colorHex: '#22c55e' }, 
             eleve: { level: 'Haute Fréquence', commentary: "Une forte cohérence et une haute luminance caractérisent le signal. Cela correspond typiquement à un état de clarté mentale, de concentration focalisée ou de bien-être physique notable. Le système nerveux autonome montre des signes de régulation optimale.", colorHex: '#38bdf8' }, 
             optimal: { level: 'Fréquence Optimale', commentary: "Le signal atteint un pic de cohérence et de luminance, une signature observée lors d'états de paix intérieure profonde ou de grande créativité. Cet état reflète une harmonie exceptionnelle entre les systèmes physiologique et psychologique.", colorHex: '#8b5cf6' }
        };
        
        let animationFrameId;
        let isRecording = false;
        let recordingStartTime = null;
        let recordIntervalId = null;
        let recordedData = [];
        const MAX_RECORD_TIME = 45 * 60;

        // --- UI MANAGEMENT ---
        function showResults(title) {
            analysisTitle.textContent = title;
            resultsContainer.classList.remove('hidden');
            resultsPlaceholder.classList.add('hidden');
        }

        function hideResults() {
            analysisTitle.textContent = '';
            resultsContainer.classList.add('hidden');
            resultsPlaceholder.classList.remove('hidden');

            const defaultInterpretation = "L'analyse débutera lorsque la caméra sera active ou qu'une photo sera chargée.";
            const defaultVibrationalCommentary = "L'analyse vibratoire débutera pour quantifier la cohérence et la luminance du signal bio-photonique capté.";

            dominantColorPreview.style.backgroundColor = 'transparent';
            dominantColorName.textContent = 'En attente...';
            dominantColorWavelength.textContent = `~ ... nm`;
            dominantColorKeywords.innerHTML = '';
            interpretationText.innerHTML = defaultInterpretation;

            vibrationalGaugeBar.style.strokeDasharray = `0, 100`;
            vibrationalGaugeBar.style.stroke = `#38bdf8`;
            vibrationalRateValue.textContent = '...';
            vibrationalLevelText.textContent = 'En attente...';
            vibrationalCommentary.textContent = defaultVibrationalCommentary;
        }

        // --- CAMERA & LIVE ANALYSIS ---
        async function setupCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: {
                        facingMode: 'user',
                        width: { ideal: 640 },
                        height: { ideal: 480 }
                    },
                    audio: false 
                });
                video.srcObject = stream;
                video.onloadedmetadata = () => {
                    video.play();
                    startMessage.classList.add('hidden');
                    loadingSpinner.classList.add('hidden');
                    stopButton.classList.remove('hidden');
                    showResults('Analyse en direct');
                    recordButton.disabled = false;
                    recordStatus.textContent = "Prêt pour l'enregistrement.";

                    const containerWidth = videoContainer.clientWidth;
                    const containerHeight = videoContainer.clientHeight;
                    canvas.width = containerWidth;
                    canvas.height = containerHeight;
                    
                    animationFrameId = requestAnimationFrame(tick);
                };
            } catch (err) {
                console.error("Erreur d'accès à la caméra:", err);
                startMessage.innerHTML = `<p class="text-red-400">Impossible d'accéder à la caméra. Veuillez vérifier les autorisations de votre navigateur.</p>`;
                loadingSpinner.classList.add('hidden');
                startMessage.classList.remove('hidden');
            }
        }

        function stopCamera() {
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
                video.srcObject = null;
            }
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
                animationFrameId = null;
            }
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            startMessage.classList.remove('hidden');
            stopButton.classList.add('hidden');
            loadingSpinner.classList.add('hidden');
            hideResults();
            if(isRecording) toggleRecording();
            recordButton.disabled = true;
            recordStatus.textContent = "Activez la caméra pour pouvoir enregistrer.";
            recordTimer.textContent = '00:00';
        }

        function tick() {
            if (!video.srcObject) return;
            const { width, height } = canvas;
            ctx.save();
            ctx.clearRect(0, 0, width, height);
            ctx.translate(width, 0);
            ctx.scale(-1, 1);
            ctx.drawImage(video, 0, 0, width, height);
            ctx.restore();

            const imageData = ctx.getImageData(0, 0, width, height);
            const { avgR, avgG, avgB, count } = calculateAverageColorFromPeriphery(imageData);

            if (count > 0) {
                const vibrationalRate = calculateVibrationalRate(avgR, avgG, avgB);
                
                if(isRecording) {
                    const now = Date.now();
                    if (!recordedData.length || now - recordedData[recordedData.length - 1].t > 1000) {
                        const [h,s,v] = rgbToHsv(avgR, avgG, avgB);
                        recordedData.push({ t: now, r: avgR, g: avgG, b: avgB, s:s, v:v, vRate: vibrationalRate });
                    }
                }

                const gradient = ctx.createRadialGradient(width/2, height/2, width * 0.3, width/2, height/2, width * 0.6);
                gradient.addColorStop(0, `rgba(${avgR}, ${avgG}, ${avgB}, 0.5)`);
                gradient.addColorStop(1, `rgba(${avgR}, ${avgG}, ${avgB}, 0)`);
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, width, height);

                updateAuraUI(avgR, avgG, avgB);
                updateVibrationalUI(vibrationalRate);
            }

            animationFrameId = requestAnimationFrame(tick);
        }

        // --- PHOTO ANALYSIS ---
        function analyzeImage(img) {
            photoLoadingSpinner.classList.add('hidden');
            showResults('Analyse de la Photo');
            
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d', { willReadFrequently: true });
            tempCanvas.width = img.width;
            tempCanvas.height = img.height;
            tempCtx.drawImage(img, 0, 0);
            const imageData = tempCtx.getImageData(0, 0, img.width, img.height);
            
            const { avgR, avgG, avgB, count } = calculateAverageColorFromPeriphery(imageData);

            if (count > 0) {
                 const vibrationalRate = calculateVibrationalRate(avgR, avgG, avgB);
                 updateAuraUI(avgR, avgG, avgB);
                 updateVibrationalUI(vibrationalRate);

                 const container = document.getElementById('photo-container');
                 const { clientWidth: width, clientHeight: height } = container;
                 photoCanvas.width = width;
                 photoCanvas.height = height;
                 photoCtx.clearRect(0, 0, width, height);

                 const gradient = photoCtx.createRadialGradient(width/2, height/2, width * 0.35, width/2, height/2, width * 0.7);
                 gradient.addColorStop(0, `rgba(${avgR}, ${avgG}, ${avgB}, 0.5)`);
                 gradient.addColorStop(1, `rgba(${avgR}, ${avgG}, ${avgB}, 0)`);
                 photoCtx.fillStyle = gradient;
                 photoCtx.fillRect(0, 0, width, height);
            }
        }
        
        function clearPhoto() {
            photoPreview.classList.add('hidden');
            photoPreview.src = '';
            clearPhotoButton.classList.add('hidden');
            photoCtx.clearRect(0, 0, photoCanvas.width, photoCanvas.height);
            photoInput.value = null;
            photoStartMessage.classList.remove('hidden');
            hideResults();
        }

        // --- CORE LOGIC & UTILITIES ---
        function calculateAverageColorFromPeriphery(imageData) {
            const { data, width, height } = imageData;
            let r = 0, g = 0, b = 0, count = 0;
            const radius = Math.min(width, height) * 0.25;
            const centerX = width / 2;
            const centerY = height / 2;

            for (let y = 0; y < height; y += 4) {
                for (let x = 0; x < width; x += 4) {
                    const dist = Math.sqrt(Math.pow(x - centerX, 2) + Math.pow(y - centerY, 2));
                    if (dist > radius * 0.5 && dist < radius) {
                        const index = (y * width + x) * 4;
                        r += data[index];
                        g += data[index + 1];
                        b += data[index + 2];
                        count++;
                    }
                }
            }
            if (count > 0) {
                return { avgR: Math.floor(r / count), avgG: Math.floor(g / count), avgB: Math.floor(b / count), count };
            }
            return { avgR: 0, avgG: 0, avgB: 0, count: 0 };
        }

        function calculateVibrationalRate(r, g, b) {
            const [h, s, v] = rgbToHsv(r, g, b);
            const maxRate = 20000;
            let rate = maxRate * (v * 0.7 + s * 0.3);
            const fluctuation = (Math.random() - 0.5) * 50;
            return Math.max(0, Math.floor(rate + fluctuation));
        }
        
        function getVibrationalTier(rate) { 
            if (rate <= 4000) return VIBRATIONAL_DATA.tres_bas; 
            if (rate <= 7500) return VIBRATIONAL_DATA.bas; 
            if (rate <= 11000) return VIBRATIONAL_DATA.equilibre; 
            if (rate <= 15000) return VIBRATIONAL_DATA.eleve; 
            return VIBRATIONAL_DATA.optimal;
        }

        function getColorName(r, g, b) { 
            const hsv = rgbToHsv(r, g, b); 
            const h = hsv[0] * 360; 
            const s = hsv[1]; 
            const v = hsv[2]; 
            if (s < 0.2 || v < 0.3) return 'Blanc'; 
            if (h >= 330 || h < 15) return 'Rouge'; 
            if (h >= 15 && h < 45) return 'Orange'; 
            if (h >= 45 && h < 75) return 'Jaune'; 
            if (h >= 75 && h < 165) return 'Vert'; 
            if (h >= 165 && h < 255) return 'Bleu'; 
            if (h >= 255 && h < 285) return 'Indigo'; 
            if (h >= 285 && h < 330) return 'Violet'; 
            return 'Inconnu';
        }

        // --- [NEW HELPER FUNCTION] ---
        function getIntensityLabel(s, v) {
            const intensityScore = (s + v) / 2;
            const percent = Math.round(intensityScore * 100);
            let label = '';
            if (percent <= 20) label = 'Très Faible';
            else if (percent <= 40) label = 'Faible';
            else if (percent <= 60) label = 'Modérée';
            else if (percent <= 80) label = 'Forte';
            else label = 'Très Forte';
            return { label: label, percent: percent };
        }

        function getInterpretation(colorName, s, v) {
            const interpretations = INTERPRETATIONS[colorName];
            if (!interpretations) return "Analyse des données en cours...";
            
            // intensityKey is still used to select the correct descriptive text below.
            const intensityKey = getIntensityKey(s, v); 
            
            const { label, percent } = getIntensityLabel(s, v);

            const title = `Intensité de l'Aura : ${label} (${percent}%)`;
            
            // The descriptive text from INTERPRETATIONS remains the same.
            return `<strong class="block mb-1 text-slate-100">${title}</strong> ${interpretations[intensityKey]}`;
        }

        function getIntensityKey(s, v) {
            const intensityScore = (s + v) / 2;
            if (intensityScore < 0.45) return 'pale';
            if (intensityScore > 0.8) return 'intense';
            return 'equilibre';
        }

        function rgbToHsv(r, g, b) {
            r /= 255, g /= 255, b /= 255; 
            let max = Math.max(r, g, b), min = Math.min(r, g, b); 
            let h, s, v = max; 
            let d = max - min; 
            s = max == 0 ? 0 : d / max; 
            if (max == min) { h = 0; } 
            else { 
                switch (max) { 
                    case r: h = (g - b) / d + (g < b ? 6 : 0); break; 
                    case g: h = (b - r) / d + 2; break; 
                    case b: h = (r - g) / d + 4; break; 
                } 
                h /= 6; 
            } 
            return [h, s, v];
        }
        
        function formatTime(seconds) {
             const m = Math.floor(seconds / 60).toString().padStart(2, '0'); 
             const s = (seconds % 60).toString().padStart(2, '0'); 
             return `${m}:${s}`;
        }

        // --- UI UPDATES ---
        function updateAuraUI(r, g, b) {
             const color = `rgb(${r}, ${g}, ${b})`; 
             const colorName = getColorName(r, g, b);
             const [h, s, v] = rgbToHsv(r, g, b);
             
             dominantColorPreview.style.backgroundColor = color; 
             dominantColorName.textContent = colorName; 
             interpretationText.innerHTML = getInterpretation(colorName, s, v);

             const colorData = COLOR_DATA[colorName] || { wavelength: 'N/A', keywords: [] }; 
             dominantColorWavelength.textContent = `~ ${colorData.wavelength} nm`; 
             
             dominantColorKeywords.innerHTML = ''; 
             colorData.keywords.forEach(keyword => { 
                 const keywordElement = document.createElement('span'); 
                 keywordElement.className = 'text-xs bg-slate-700/50 text-sky-300 px-2 py-0.5 rounded-full'; 
                 keywordElement.textContent = keyword; 
                 dominantColorKeywords.appendChild(keywordElement); 
             });
        }
        
        function updateVibrationalUI(rate) { 
            vibrationalRateValue.textContent = rate.toLocaleString('fr-FR'); 
            const maxRate = 20000; 
            const percentage = Math.min(100, (rate / maxRate) * 100); 
            vibrationalGaugeBar.style.strokeDasharray = `${percentage}, 100`; 
            const tier = getVibrationalTier(rate); 
            vibrationalGaugeBar.style.stroke = tier.colorHex; 
            vibrationalLevelText.textContent = tier.level; 
            vibrationalCommentary.textContent = tier.commentary;
        }

        // --- RECORDING & REPORTING ---
        function toggleRecording() {
             isRecording = !isRecording; 
             if(isRecording) { 
                 recordedData = []; 
                 recordingStartTime = Date.now(); 
                 recordButton.textContent = "Arrêter"; 
                 recordButton.classList.add('bg-red-600', 'hover:bg-red-500', 'recording-pulse'); 
                 recordButton.classList.remove('bg-sky-600', 'hover:bg-sky-500'); 
                 recordStatus.textContent = "Enregistrement en cours..."; 
                 recordIntervalId = setInterval(updateTimer, 1000); 
             } else { 
                 clearInterval(recordIntervalId); 
                 recordButton.textContent = "Démarrer"; 
                 recordButton.classList.remove('bg-red-600', 'hover:bg-red-500', 'recording-pulse'); 
                 recordButton.classList.add('bg-sky-600', 'hover:bg-sky-500'); 
                 recordStatus.textContent = `Enregistrement de ${formatTime(Math.floor((Date.now() - recordingStartTime)/1000))} terminé.`; 
                 analyzeAndShowReport(recordedData); 
             }
        }
        
        function updateTimer() { 
             const elapsedSeconds = Math.floor((Date.now() - recordingStartTime) / 1000); 
             recordTimer.textContent = formatTime(elapsedSeconds); 
             if(elapsedSeconds >= MAX_RECORD_TIME) { 
                 toggleRecording(); 
             }
        }
        
        // --- [CORRECTED AND REWRITTEN FUNCTION] ---
        function analyzeAndShowReport(data) {
            if (data.length < 2) {
                reportContent.innerHTML = `<p class="text-center text-slate-400">Pas assez de données pour générer un rapport fiable.</p>`;
                reportModal.classList.remove('hidden');
                return;
            };

            const colorAggregates = {};
            data.forEach(d => {
                const colorName = getColorName(d.r, d.g, d.b);
                if (!colorAggregates[colorName]) {
                    colorAggregates[colorName] = { count: 0, pale: 0, equilibre: 0, intense: 0 };
                }
                colorAggregates[colorName].count++;
                const intensityKey = getIntensityKey(d.s, d.v);
                colorAggregates[colorName][intensityKey]++;
            });

            const sortedColors = Object.entries(colorAggregates).sort(([,a],[,b]) => b.count - a.count);

            const getReportInterpretation = (colorName, aggregate) => {
                const total = aggregate.count;
                const percentages = {
                    pale: (aggregate.pale / total) * 100,
                    equilibre: (aggregate.equilibre / total) * 100,
                    intense: (aggregate.intense / total) * 100
                };

                const sortedIntensities = Object.entries(percentages)
                    .filter(([,percent]) => percent > 10) // On ne considère que les influences significatives (>10%)
                    .sort(([,a],[,b]) => b - a);

                let interpretationKey = 'equilibre'; // Clé par défaut
                
                if (sortedIntensities.length > 0) {
                    const dominantState = sortedIntensities[0][0];
                    interpretationKey = dominantState; // Commence avec l'état dominant

                    if (sortedIntensities.length > 1) {
                        const secondaryState = sortedIntensities[1][0];
                        // Crée une clé combinée prédictible (ex: 'equilibre_intense')
                        const combinedKey = `${dominantState}_${secondaryState}`;
                        const reversedCombinedKey = `${secondaryState}_${dominantState}`;

                        // Vérifie si une interprétation pour cette dynamique existe
                        if (INTERPRETATIONS[colorName][combinedKey]) {
                            interpretationKey = combinedKey;
                        } else if (INTERPRETATIONS[colorName][reversedCombinedKey]) {
                            interpretationKey = reversedCombinedKey;
                        }
                    }
                }
                
                const percentageStrings = Object.entries(percentages)
                    .filter(([,p]) => p > 0)
                    .map(([key, p]) => {
                        let label = '';
                        if(key === 'equilibre') label = 'Intensité Modérée';
                        else if(key === 'pale') label = 'Basse Intensité';
                        else if(key === 'intense') label = 'Haute Intensité';
                        return `<strong>${label}</strong> (${p.toFixed(0)}%)`
                    }).join(', ');

                const qualityLabel = `Dynamique de l'Aura : ${percentageStrings}.`;
                const interpretationText = INTERPRETATIONS[colorName][interpretationKey] || INTERPRETATIONS[colorName]['equilibre']; // Fallback

                return `<strong class="block mb-1 text-slate-100">${qualityLabel}</strong> ${interpretationText}<br><small class="text-slate-400">L'interprétation ci-dessus est basée sur la dynamique la plus représentative de votre session.</small>`;
            };
            
            const vRates = data.map(d => d.vRate);
            const avgVRate = Math.round(vRates.reduce((a, b) => a + b, 0) / vRates.length);
            const maxVRate = Math.round(Math.max(...vRates));
            const minVRate = Math.round(Math.min(...vRates));
            const avgTier = getVibrationalTier(avgVRate);
            
            let reportHTML = `
                <div>
                    <h3 class="font-semibold text-sky-400 mb-2">Visualisation Temporelle de l'Aura</h3>
                    <div class="w-full h-10 bg-slate-900 rounded-lg flex overflow-hidden" title="Chaque segment représente une seconde de l'enregistrement.">
                        ${data.map(d => `<div style="flex-grow: 1; background-color: rgb(${d.r}, ${d.g}, ${d.b});"></div>`).join('')}
                    </div>
                </div>
                <div>
                    <h3 class="font-semibold text-sky-400 mb-2">Analyse Détaillée de l'Aura</h3>
                    <div class="text-sm space-y-3 text-slate-300">
                        <p>
                            <strong>Couleur Principale : ${sortedColors[0][0]} (${((sortedColors[0][1].count / data.length) * 100).toFixed(0)}%)</strong>
                            <br>${getReportInterpretation(sortedColors[0][0], sortedColors[0][1])}
                        </p>
                        ${sortedColors.length > 1 ? `
                            <p class="mt-4"><strong>Influences Secondaires :</strong></p>
                            <ul class="list-disc list-inside space-y-2">
                                ${sortedColors.slice(1, 2).map(([color, aggregate]) => `<li><strong>${color} (${((aggregate.count / data.length) * 100).toFixed(0)}%):</strong> ${getReportInterpretation(color, aggregate)}</li>`).join('')}
                            </ul>
                        ` : ''}
                    </div>
                </div>
                <div>
                    <h3 class="font-semibold text-sky-400 mb-2">Synthèse Vibratoire (UBQ)</h3>
                    <div class="text-sm space-y-3 text-slate-300">
                        <div class="grid grid-cols-3 gap-4 text-center">
                            <div><span class="text-xs text-slate-400">MINIMUM</span><p class="text-lg font-mono font-bold">${minVRate.toLocaleString('fr-FR')}</p></div>
                            <div><span class="text-xs text-slate-400">MOYENNE</span><p class="text-2xl font-mono font-bold text-white">${avgVRate.toLocaleString('fr-FR')}</p></div>
                            <div><span class="text-xs text-slate-400">MAXIMUM</span><p class="text-lg font-mono font-bold">${maxVRate.toLocaleString('fr-FR')}</p></div>
                        </div>
                        <p class="mt-4"><strong>Analyse de la Fréquence Moyenne (${avgTier.level}) :</strong><br>${avgTier.commentary}</p>
                    </div>
                </div>`;
            reportContent.innerHTML = reportHTML;
            reportModal.classList.remove('hidden');
        }

        function closeModal() { reportModal.classList.add('hidden'); }

        // --- EVENT LISTENERS ---
        startButton.addEventListener('click', () => {
            startMessage.classList.add('hidden');
            loadingSpinner.classList.remove('hidden');
            setupCamera();
        });

        stopButton.addEventListener('click', stopCamera);

        photoInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file && file.type.startsWith('image/')) {
                photoStartMessage.classList.add('hidden');
                photoLoadingSpinner.classList.remove('hidden');
                photoPreview.classList.add('hidden');
                photoCtx.clearRect(0,0, photoCanvas.width, photoCanvas.height);

                const reader = new FileReader();
                reader.onload = (e) => {
                    const imageUrl = e.target.result;
                    photoPreview.src = imageUrl;
                    photoPreview.classList.remove('hidden');
                    clearPhotoButton.classList.remove('hidden');
                    
                    const img = new Image();
                    img.onload = () => analyzeImage(img);
                    img.onerror = () => {
                        photoLoadingSpinner.classList.add('hidden');
                        photoStartMessage.classList.remove('hidden');
                        clearPhotoButton.classList.add('hidden');
                        photoStartMessage.querySelector('p').textContent = "Erreur lors du chargement de l'image.";
                    };
                    img.src = imageUrl;
                };
                reader.readAsDataURL(file);
            }
        });

        liveTabButton.addEventListener('click', () => {
            photoTabContent.classList.add('hidden');
            liveTabContent.classList.remove('hidden');
            liveTabButton.classList.add('border-indigo-500', 'text-white');
            liveTabButton.classList.remove('border-transparent', 'text-slate-400');
            photoTabButton.classList.add('border-transparent', 'text-slate-400');
            photoTabButton.classList.remove('border-indigo-500', 'text-white');
            
            recordButton.disabled = video.srcObject ? false : true;
            recordStatus.textContent = video.srcObject ? "Prêt pour l'enregistrement." : "Activez la caméra pour pouvoir enregistrer.";
            if (!video.srcObject) {
                hideResults();
            }
        });

        photoTabButton.addEventListener('click', () => {
            liveTabContent.classList.add('hidden');
            photoTabContent.classList.remove('hidden');
            photoTabButton.classList.add('border-indigo-500', 'text-white');
            photoTabButton.classList.remove('border-transparent', 'text-slate-400');
            liveTabButton.classList.add('border-transparent', 'text-slate-400');
            liveTabButton.classList.remove('border-indigo-500', 'text-white');

            stopCamera();
            recordButton.disabled = true;
            recordStatus.textContent = "L'enregistrement n'est pas disponible pour les photos.";
            if (!photoPreview.src) {
                hideResults();
            }
        });
        
        clearPhotoButton.addEventListener('click', clearPhoto);
        recordButton.addEventListener('click', toggleRecording);
        closeModalButton.addEventListener('click', closeModal);
        closeModalButton2.addEventListener('click', closeModal);

        window.addEventListener('resize', () => {
            if (video.srcObject) {
              const containerWidth = videoContainer.clientWidth;
              const containerHeight = videoContainer.clientHeight;
              canvas.width = containerWidth;
              canvas.height = containerHeight;
            }
        });

        // Initial setup
        hideResults();
    </script>
</body>
</html>

