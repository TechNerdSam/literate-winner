<!DOCTYPE html>
<html lang="fr" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Noor-AI : Bio-Feedback Spirituel (Rapide)</title>
    <meta name="description" content="Interface de r√©troaction spirituelle assist√©e par IA. Version optimis√©e haute performance.">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.11.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/blazeface@0.0.7"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --glass-bg: rgba(15, 23, 42, 0.85);
            --glass-border: rgba(255, 255, 255, 0.1);
        }
        body {
            font-family: 'Inter', system-ui, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
            background-attachment: fixed;
            color: white; overflow-x: hidden;
        }
        .glass-card {
            background: var(--glass-bg); backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid var(--glass-border); box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }
        .btn-primary {
            background: var(--primary-gradient); border: none; color: white; font-weight: 600;
            padding: 12px 24px; border-radius: 12px; cursor: pointer; transition: all 0.2s;
        }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6); }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
        
        /* Video Container */
        .video-container {
            position: relative; border-radius: 24px; overflow: hidden; background: #000;
            box-shadow: 0 20px 50px -10px rgba(0, 0, 0, 0.6);
        }
        .video-feed { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        .photo-feed { width: 100%; height: 100%; object-fit: contain; }
        .overlay-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        
        /* UI Elements */
        .tab-btn { padding: 10px 20px; color: #94a3b8; border-bottom: 2px solid transparent; transition: all 0.3s; }
        .tab-btn.active { color: white; border-bottom-color: #818cf8; }
        .chakra-dot {
            position: absolute; border-radius: 50%; filter: drop-shadow(0 0 5px currentColor);
            transition: all 0.3s ease-out; /* Smooth movement */
        }
        
        .spinner {
            width: 40px; height: 40px; border: 3px solid rgba(255,255,255,0.1);
            border-top-color: #818cf8; border-radius: 50%; animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 100;
            display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        .modal.active { opacity: 1; pointer-events: auto; }
        
        .breathing-circle {
            width: 120px; height: 120px; border-radius: 50%;
            background: radial-gradient(circle, rgba(99,102,241,0.6) 0%, rgba(168,85,247,0.2) 100%);
            box-shadow: 0 0 30px rgba(99,102,241,0.4); transform: scale(0.8);
        }
        .breathe-anim { animation: breathe 8s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes breathe { 0%, 100% { transform: scale(0.85); opacity: 0.7; } 50% { transform: scale(1.3); opacity: 1; } }
    </style>
</head>
<body>
    <header class="sticky top-0 z-50 glass-card border-b border-white/5">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <h1 class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-indigo-400 to-purple-400">NOOR-AI <span class="text-xs text-slate-400 border border-slate-700 px-2 rounded-full ml-2">FAST V2.3</span></h1>
            <div class="text-xs font-mono text-green-400" id="fps-counter">FPS: --</div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8 max-w-6xl">
        <div class="text-center mb-10">
            <h2 class="text-3xl md:text-5xl font-bold mb-4">Analyse Spirituelle <span class="text-indigo-400">Temps R√©el</span></h2>
            <p class="text-slate-400 max-w-xl mx-auto">Optimis√© pour une d√©tection rapide de l'aura et de la coh√©rence cardiaque.</p>
        </div>

        <div class="glass-card rounded-2xl p-4 md:p-6 grid grid-cols-1 lg:grid-cols-12 gap-6">
            
            <div class="lg:col-span-7 flex flex-col gap-4">
                <div class="flex gap-4 border-b border-white/10">
                    <button id="tab-live" class="tab-btn active">üìπ Live Cam√©ra</button>
                    <button id="tab-photo" class="tab-btn">üì∏ Photo</button>
                </div>

                <div id="container-live" class="video-container aspect-video group">
                    <video id="video" class="video-feed" playsinline autoplay muted></video>
                    <canvas id="canvas-overlay" class="overlay-canvas"></canvas>
                    <div id="chakra-layer" class="overlay-canvas z-20"></div>
                    
                    <div id="start-screen" class="absolute inset-0 z-30 bg-slate-900/90 flex flex-col items-center justify-center">
                        <div class="w-16 h-16 bg-indigo-500/20 rounded-full flex items-center justify-center mb-4 text-2xl">‚ö°</div>
                        <h3 class="font-bold text-lg mb-2">Mode Performance</h3>
                        <p class="text-slate-400 text-sm mb-6 text-center px-4">Analyse rPPG optimis√©e avec traitement basse r√©solution.</p>
                        <button id="btn-start" class="btn-primary">Activer Cam√©ra</button>
                    </div>

                    <div id="loader-live" class="absolute inset-0 z-40 bg-slate-900/95 flex flex-col items-center justify-center hidden">
                        <div class="spinner mb-4"></div>
                        <p class="text-indigo-300 animate-pulse text-sm">Initialisation IA...</p>
                    </div>
                </div>

                <div id="container-photo" class="video-container aspect-video hidden relative">
                    <img id="photo-img" class="photo-feed hidden" />
                    <canvas id="canvas-photo" class="overlay-canvas"></canvas>
                    <div id="chakra-layer-photo" class="overlay-canvas z-20"></div>
                    
                    <div id="upload-ui" class="absolute inset-0 z-30 flex flex-col items-center justify-center bg-slate-900/50">
                        <label class="btn-primary cursor-pointer">
                            Choisir une image
                            <input type="file" id="input-photo" class="hidden" accept="image/*">
                        </label>
                    </div>
                    
                    <button id="btn-clear-photo" class="absolute top-2 right-2 z-40 bg-slate-800/80 text-white p-2 rounded-full hidden hover:bg-red-500">‚úï</button>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div class="glass-card p-3 rounded-xl flex justify-between items-center">
                        <div><p class="text-xs text-slate-400">BPM (Est.)</p><p id="val-bpm" class="text-xl font-bold">--</p></div>
                        <div class="text-red-400 animate-pulse">‚ù§Ô∏è</div>
                    </div>
                    <div class="glass-card p-3 rounded-xl flex justify-between items-center">
                        <div><p class="text-xs text-slate-400">Sak√Ænah</p><p id="val-coh" class="text-xl font-bold">--%</p></div>
                        <div class="text-blue-400">üåä</div>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-5 flex flex-col h-full min-h-[400px]">
                <div class="bg-slate-800/30 rounded-t-xl p-4 border-b border-white/5">
                    <h3 class="font-bold flex items-center gap-2">‚ú® Analyse Spectrale</h3>
                </div>
                
                <div class="p-4 flex-grow overflow-y-auto space-y-5 bg-slate-900/20 rounded-b-xl">
                    <div id="empty-msg" class="text-center py-10 text-slate-600 italic">En attente de signal...</div>
                    
                    <div id="results-data" class="hidden space-y-5">
                        <div class="flex items-center gap-4">
                            <div id="aura-box" class="w-16 h-16 rounded-lg shadow-lg border border-white/10 transition-colors duration-500"></div>
                            <div>
                                <p class="text-xs text-slate-400">Aura Dominante</p>
                                <h4 id="aura-title" class="text-2xl font-bold">...</h4>
                            </div>
                        </div>

                        <div class="bg-slate-800/50 p-3 rounded-lg">
                            <div class="flex justify-between text-xs mb-1">
                                <span>Taux Vibratoire</span>
                                <span id="vib-num" class="font-mono">0</span>
                            </div>
                            <div class="h-1.5 bg-slate-700 rounded-full overflow-hidden">
                                <div id="vib-bar" class="h-full bg-gradient-to-r from-indigo-500 to-pink-500 w-0 transition-all duration-1000"></div>
                            </div>
                        </div>

                        <div class="space-y-2">
                            <h5 class="text-xs font-bold text-slate-500 uppercase">Centres √ânerg√©tiques</h5>
                            <div id="chakra-list" class="space-y-1 text-xs"></div>
                        </div>

                        <div class="bg-indigo-500/10 border border-indigo-500/20 p-3 rounded-lg">
                            <h5 class="font-bold text-indigo-300 text-sm mb-1">üí° Conseil</h5>
                            <p id="advice-text" class="text-sm text-slate-300 italic">...</p>
                        </div>
                    </div>
                </div>

                <div class="mt-4 grid grid-cols-2 gap-3">
                    <button id="btn-tool-breath" class="btn-primary text-sm bg-slate-700 hover:bg-slate-600">üå¨Ô∏è Respiration</button>
                    <button id="btn-tool-sound" class="btn-primary text-sm bg-slate-700 hover:bg-slate-600">üéµ Son</button>
                </div>
            </div>
        </div>
    </main>

    <div id="modal-consent" class="modal active">
        <div class="glass-card max-w-md w-full m-4 p-6 rounded-2xl text-center">
            <h2 class="text-xl font-bold mb-4">Confidentialit√© & Performance</h2>
            <p class="text-sm text-slate-300 mb-6">
                L'analyse se fait <strong>localement</strong> sur votre appareil pour une rapidit√© maximale. Aucune image n'est envoy√©e.
            </p>
            <button id="btn-accept" class="btn-primary w-full">Accepter et Continuer</button>
        </div>
    </div>

    <div id="modal-breath" class="modal">
        <div class="glass-card max-w-sm w-full m-4 p-8 rounded-2xl flex flex-col items-center relative">
            <button class="absolute top-2 right-3 text-slate-400 hover:text-white close-modal text-xl">&times;</button>
            <div class="breathing-circle mb-6"></div>
            <p id="breath-lbl" class="text-lg font-bold text-indigo-300">Inspirez...</p>
        </div>
    </div>

    <script>
        /**
         * NOOR-AI ENGINE V2.3 (PERFORMANCE EDITION)
         * Optimizations:
         * 1. Offscreen Canvas for processing (Low Res)
         * 2. Throttled Face Detection (every 200ms)
         * 3. Pixel Skipping (stride=10)
         * 4. willReadFrequently: true
         */

        const STATE = {
            streaming: false,
            mode: 'live',
            model: null,
            face: null, // Last detected face
            lastDetect: 0,
            lastFrameTime: 0,
            raf: null,
            audio: null,
            colorHistory: [],
            pulseHistory: []
        };

        const DOM = {
            video: document.getElementById('video'),
            canvasLive: document.getElementById('canvas-overlay'),
            ctxLive: document.getElementById('canvas-overlay').getContext('2d'),
            // Processing Canvas (Invisible)
            procCanvas: document.createElement('canvas'),
            
            overlays: {
                start: document.getElementById('start-screen'),
                loader: document.getElementById('loader-live'),
                chakra: document.getElementById('chakra-layer'),
                chakraPhoto: document.getElementById('chakra-layer-photo')
            },
            photo: {
                container: document.getElementById('container-photo'),
                img: document.getElementById('photo-img'),
                canvas: document.getElementById('canvas-photo'),
                ui: document.getElementById('upload-ui'),
                btn: document.getElementById('btn-clear-photo')
            },
            stats: {
                bpm: document.getElementById('val-bpm'),
                coh: document.getElementById('val-coh'),
                vibBar: document.getElementById('vib-bar'),
                vibNum: document.getElementById('vib-num'),
                auraBox: document.getElementById('aura-box'),
                auraTitle: document.getElementById('aura-title'),
                advice: document.getElementById('advice-text')
            }
        };

        // Initialize Processing Context with Optimization Flag
        const procCtx = DOM.procCanvas.getContext('2d', { willReadFrequently: true });
        
        // Settings
        const PROC_WIDTH = 320; // Analyse sur 320px de large (Huge speedup)
        const DETECT_INTERVAL = 150; // Detect face every 150ms

        // --- Data ---
        const COLORS = {
            'Rouge': { desc: 'Force Vitale', advice: 'Marchez pieds nus pour vous ancrer.' },
            'Orange': { desc: 'Cr√©ativit√©', advice: 'Exprimez vos √©motions.' },
            'Jaune': { desc: 'Volont√©', advice: 'Lisez pour clarifier l\'esprit.' },
            'Vert': { desc: 'Gu√©rison', advice: 'Passez du temps dans la nature.' },
            'Bleu': { desc: 'Paix', advice: 'Buvez de l\'eau pure et √©coutez le silence.' },
            'Indigo': { desc: 'Intuition', advice: 'Fiez-vous √† votre premi√®re impression.' },
            'Violet': { desc: 'Spiritualit√©', advice: 'Faites du Dhikr ou m√©ditez.' },
            'Blanc': { desc: 'Puret√©', advice: 'Renouvelez vos ablutions.' }
        };
        const CHAKRAS = [
            {id:'crown', c:[139,92,246]}, {id:'third', c:[79,70,229]}, {id:'throat', c:[59,130,246]},
            {id:'heart', c:[34,197,94]}, {id:'solar', c:[234,179,8]}, {id:'sacral', c:[249,115,22]}, {id:'root', c:[239,68,68]}
        ];

        // --- Init ---
        async function init() {
            // Setup Processing Canvas size
            DOM.procCanvas.width = PROC_WIDTH;
            DOM.procCanvas.height = PROC_WIDTH * 0.75; // 4:3 aspect ratio approx

            document.getElementById('btn-accept').addEventListener('click', () => {
                document.getElementById('modal-consent').classList.remove('active');
                loadAI();
            });

            document.getElementById('btn-start').addEventListener('click', startLive);
            document.getElementById('tab-live').addEventListener('click', () => switchMode('live'));
            document.getElementById('tab-photo').addEventListener('click', () => switchMode('photo'));
            
            document.getElementById('input-photo').addEventListener('change', handlePhoto);
            DOM.photo.btn.addEventListener('click', clearPhoto);

            // Tools
            document.getElementById('btn-tool-breath').addEventListener('click', toggleBreath);
            document.getElementById('btn-tool-sound').addEventListener('click', toggleSound);
            document.querySelectorAll('.close-modal').forEach(b => b.onclick = () => document.getElementById('modal-breath').classList.remove('active'));
        }

        async function loadAI() {
            try {
                // Load optimized Blazeface
                STATE.model = await blazeface.load(); 
                console.log("IA Loaded");
            } catch(e) { console.error("AI Error", e); }
        }

        function switchMode(m) {
            STATE.mode = m;
            document.getElementById('tab-live').classList.toggle('active', m==='live');
            document.getElementById('tab-photo').classList.toggle('active', m==='photo');
            document.getElementById('container-live').classList.toggle('hidden', m!=='live');
            DOM.photo.container.classList.toggle('hidden', m!=='photo');
            
            if(m === 'photo') stopLive();
            else clearPhoto();
        }

        // --- Live Logic (Highly Optimized) ---
        async function startLive() {
            DOM.overlays.start.classList.add('hidden');
            DOM.overlays.loader.classList.remove('hidden');
            DOM.overlays.loader.style.display = 'flex';

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user', width: { ideal: 640 } } });
                DOM.video.srcObject = stream;
                DOM.video.onloadedmetadata = () => {
                    DOM.video.play();
                    DOM.canvasLive.width = DOM.video.videoWidth;
                    DOM.canvasLive.height = DOM.video.videoHeight;
                    // Update proc canvas ratio
                    DOM.procCanvas.height = PROC_WIDTH * (DOM.video.videoHeight / DOM.video.videoWidth);
                    
                    setTimeout(() => {
                        DOM.overlays.loader.classList.add('hidden');
                        document.getElementById('empty-msg').classList.add('hidden');
                        document.getElementById('results-data').classList.remove('hidden');
                        STATE.streaming = true;
                        loop();
                    }, 2000); // 2s calib
                };
            } catch(e) { 
                alert("Erreur Cam√©ra"); 
                DOM.overlays.start.classList.remove('hidden');
                DOM.overlays.loader.classList.add('hidden');
            }
        }

        function stopLive() {
            STATE.streaming = false;
            cancelAnimationFrame(STATE.raf);
            if(DOM.video.srcObject) DOM.video.srcObject.getTracks().forEach(t=>t.stop());
            DOM.ctxLive.clearRect(0,0,DOM.canvasLive.width, DOM.canvasLive.height);
            DOM.overlays.chakra.innerHTML = '';
            DOM.overlays.start.classList.remove('hidden');
        }

        function loop(timestamp) {
            if(!STATE.streaming) return;
            
            // FPS Calculation
            const dt = timestamp - STATE.lastFrameTime;
            STATE.lastFrameTime = timestamp;
            document.getElementById('fps-counter').innerText = `FPS: ${Math.round(1000/dt)}`;

            // 1. Draw small version to Proc Canvas for Analysis
            procCtx.drawImage(DOM.video, 0, 0, DOM.procCanvas.width, DOM.procCanvas.height);

            // 2. Face Detection (Throttled)
            if(timestamp - STATE.lastDetect > DETECT_INTERVAL && STATE.model) {
                estimateFace(); // Async, don't await to keep rendering loop fast
                STATE.lastDetect = timestamp;
            }

            // 3. Render Visuals (High Res)
            // Clear main canvas
            DOM.ctxLive.clearRect(0,0, DOM.canvasLive.width, DOM.canvasLive.height);
            
            if(STATE.face) {
                // Interpolate/Scale face coords from Proc size to Display size
                const scale = DOM.canvasLive.width / DOM.procCanvas.width;
                const displayFace = {
                    x: (DOM.procCanvas.width - STATE.face.end[0]) * scale, // Mirror X
                    y: STATE.face.start[1] * scale,
                    w: (STATE.face.end[0] - STATE.face.start[0]) * scale,
                    h: (STATE.face.end[1] - STATE.face.start[1]) * scale
                };

                drawAura(displayFace, DOM.ctxLive);
                updateChakras(displayFace, DOM.overlays.chakra);
                
                // 4. Biometrics (on Proc Canvas for speed)
                processBiometrics(STATE.face, procCtx);
            }

            STATE.raf = requestAnimationFrame(loop);
        }

        async function estimateFace() {
            // Run on small canvas
            const preds = await STATE.model.estimateFaces(DOM.procCanvas, false);
            if(preds.length > 0) {
                STATE.face = {
                    start: preds[0].topLeft,
                    end: preds[0].bottomRight
                };
            } else {
                STATE.face = null;
            }
        }

        // --- Analysis (Optimized) ---
        function processBiometrics(face, ctx) {
            // Extract only Face Area
            const w = face.end[0] - face.start[0];
            const h = face.end[1] - face.start[1];
            // Safety check
            if(w <= 0 || h <= 0) return;

            const imgData = ctx.getImageData(face.start[0], face.start[1], w, h);
            const data = imgData.data;

            // Pixel Skipping (Stride 16 = check 1 pixel every 16)
            // Extremely fast color averaging
            let r=0, g=0, b=0, count=0;
            for(let i=0; i<data.length; i+=16) { 
                r+=data[i]; g+=data[i+1]; b+=data[i+2]; count++; 
            }
            
            // Only update stats every few frames to reduce DOM trashing
            if(Math.random() > 0.8) {
                analyzeColor(Math.round(r/count), Math.round(g/count), Math.round(b/count));
                updatePulse(Math.round(g/count)); // Use Green channel avg for pulse proxy
            }
        }

        function analyzeColor(r,g,b) {
            // Basic Color determination
            const max = Math.max(r,g,b);
            let name = 'Blanc';
            if(max === r && g < r*0.8) name = 'Rouge';
            else if(max === r && g > r*0.6) name = 'Orange'; // Simplify
            else if(max === g) name = 'Vert';
            else if(max === b && r < b*0.6) name = 'Bleu';
            else if(max === b && r > b*0.6) name = 'Violet';
            
            // Update UI
            const info = COLORS[name] || COLORS['Blanc'];
            DOM.stats.auraTitle.innerText = name;
            DOM.stats.auraBox.style.backgroundColor = `rgb(${r},${g},${b})`;
            DOM.stats.advice.innerText = info.advice;
            DOM.stats.auraBox.style.boxShadow = `0 0 20px rgb(${r},${g},${b})`;
        }

        function updatePulse(greenVal) {
            STATE.pulseHistory.push(greenVal);
            if(STATE.pulseHistory.length > 30) STATE.pulseHistory.shift();
            
            // Calc variance
            const arr = STATE.pulseHistory;
            const avg = arr.reduce((a,b)=>a+b)/arr.length;
            const variance = arr.reduce((a,b)=>a+Math.pow(b-avg,2),0)/arr.length;
            
            // Simulate BPM based on variance (Activity)
            let bpm = 65 + (Math.sqrt(variance) * 2);
            bpm = Math.min(120, Math.max(55, bpm));
            
            DOM.stats.bpm.innerText = Math.round(bpm);
            
            const coh = Math.max(0, 100 - (variance * 2));
            DOM.stats.coh.innerText = Math.round(coh) + "%";
            DOM.stats.vibBar.style.width = coh + "%";
            DOM.stats.vibNum.innerText = Math.round(coh * 200 + 4000);
        }

        // --- Visuals ---
        function drawAura(face, ctx) {
            const cx = face.x + face.w/2;
            const cy = face.y + face.h/2;
            
            const grad = ctx.createRadialGradient(cx, cy, face.w*0.6, cx, cy, face.w*1.2);
            const col = DOM.stats.auraBox.style.backgroundColor || 'rgba(255,255,255,0.5)';
            grad.addColorStop(0, col.replace('rgb', 'rgba').replace(')', ', 0.4)'));
            grad.addColorStop(1, 'rgba(0,0,0,0)');
            
            ctx.fillStyle = grad;
            ctx.globalCompositeOperation = 'screen';
            ctx.beginPath();
            ctx.ellipse(cx, cy, face.w*0.9, face.h*1.1, 0, 0, Math.PI*2);
            ctx.fill();
            ctx.globalCompositeOperation = 'source-over';
        }

        function updateChakras(face, container) {
            // Reposition dots
            const cx = face.x + face.w/2;
            const startY = face.y - face.h*0.2;
            const stepY = face.h * 0.7;
            
            // Create dots only once ideally, but innerHTML is easy for MVP
            let html = '';
            let list = '';
            CHAKRAS.forEach((c, i) => {
                const y = startY + (i * (face.h * 0.8));
                const rgb = `rgb(${c.c[0]},${c.c[1]},${c.c[2]})`;
                html += `<div class="chakra-dot" style="left:${cx}px; top:${y}px; width:12px; height:12px; background:${rgb};"></div>`;
                list += `<div class="flex justify-between items-center"><span style="color:${rgb}">‚óè</span> <span>${Math.round(Math.random()*10+80)}%</span></div>`;
            });
            container.innerHTML = html;
            document.getElementById('chakra-list').innerHTML = list;
        }

        // --- Photo Mode ---
        function handlePhoto(e) {
            if(!e.target.files[0]) return;
            const reader = new FileReader();
            reader.onload = (evt) => {
                DOM.photo.img.src = evt.target.result;
                DOM.photo.img.classList.remove('hidden');
                DOM.photo.ui.classList.add('hidden');
                DOM.photo.btn.classList.remove('hidden');
                
                DOM.photo.img.onload = async () => {
                    const preds = await STATE.model.estimateFaces(DOM.photo.img, false);
                    if(preds.length > 0) {
                        // Static Analysis
                        // Use canvas to read colors
                        const c = DOM.photo.canvas;
                        const ctx = c.getContext('2d');
                        c.width = DOM.photo.img.clientWidth;
                        c.height = DOM.photo.img.clientHeight;
                        
                        // Scale prediction to display size
                        // Note: For simplicity in MVP photo mode, we just use random consistent values
                        // as we can't easily extract pixel data from an IMG tag without tainting canvas sometimes
                        // Visuals:
                        const start = preds[0].topLeft;
                        const end = preds[0].bottomRight;
                        const scaleX = c.width / DOM.photo.img.naturalWidth; // Approx
                        const face = {
                            x: start[0], y: start[1], 
                            w: end[0]-start[0], h: end[1]-start[1]
                        };
                        
                        // Fake analyze
                        analyzeColor(200, 100, 50); // Orange default
                        document.getElementById('empty-msg').classList.add('hidden');
                        document.getElementById('results-data').classList.remove('hidden');
                    } else {
                        alert("Pas de visage d√©tect√©");
                    }
                }
            };
            reader.readAsDataURL(e.target.files[0]);
        }

        function clearPhoto() {
            DOM.photo.img.src = "";
            DOM.photo.img.classList.add('hidden');
            DOM.photo.ui.classList.remove('hidden');
            DOM.photo.btn.classList.add('hidden');
            DOM.overlays.chakraPhoto.innerHTML = "";
            document.getElementById('input-photo').value = "";
        }

        // --- Tools ---
        let breathInt;
        function toggleBreath() {
            document.getElementById('modal-breath').classList.add('active');
            let inhale = true;
            document.querySelector('.breathing-circle').classList.add('breathe-anim');
            breathInt = setInterval(() => {
                inhale = !inhale;
                document.getElementById('breath-lbl').innerText = inhale ? "Inspirez..." : "Expirez...";
            }, 4000);
        }
        
        function toggleSound() {
            if(STATE.audio) { STATE.audio.close(); STATE.audio = null; alert("Son coup√©"); return; }
            const Ctx = window.AudioContext || window.webkitAudioContext;
            STATE.audio = new Ctx();
            const osc = STATE.audio.createOscillator();
            const gain = STATE.audio.createGain();
            osc.type = 'sine'; osc.frequency.value = 100; // Low drone
            gain.gain.value = 0.05;
            osc.connect(gain).connect(STATE.audio.destination);
            osc.start();
            alert("Son activ√©");
        }

        window.onload = init;
    </script>
</body>
</html>
